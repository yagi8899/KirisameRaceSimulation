# 競馬予測モデル改善プロジェクト - 的中率向上タスク

## 📋 プロジェクト概要

競馬予測モデル（LightGBM LambdaRank）の的中率を以下の目標値まで向上させたい。

### 🎯 的中率目標

| 券種      | 成功ライン    |
| ------- | --------- |
| **単勝**  | **30%以上** |
| **複勝**  | **70%以上** |
| **馬連**  | **35%以上** |
| **馬単**  | **25%以上** |
| **ワイド** | **50%以上** |
| **三連複** | **15%以上** |

### 📊 現在の成績（2023年テスト）

**東京芝中長距離3歳以上（tokyo_turf_3ageup_long.sav）:**
- 単勝的中率: 23.08%（目標: 30%）
- 複勝的中率: 49.23%（目標: 70%）
- 三連複的中率: 7.69%（目標: 15%）

**東京芝短距離3歳以上（tokyo_turf_3ageup_short.sav）:**
- 単勝的中率: 13.73%（目標: 30%）
- 複勝的中率: 38.56%（目標: 70%）
- 三連複的中率: 0.00%（目標: 15%）

### ギャップ分析
- 単勝: **+6.92〜16.27%** の改善が必要
- 複勝: **+20.77〜31.44%** の改善が必要
- 三連複: **+7.31〜15%** の改善が必要

## 🔬 これまでの改善履歴

### ✅ 完了した分析・実験

1. **SHAP分析によるモデル解釈（2024年実施）**
   - ツール: `model_explainer.py`, `analyze_shap_results.py`
   - 結果: `past_avg_sotai_chakujun`が最重要特徴量（SHAP=0.211）
   - トップ5特徴量特定: past_avg_sotai_chakujun, time_index, past_score, umaban_kyori_interaction, kohan_3f_index

2. **EWM（指数加重移動平均）実験（2024年実施）**
   - 試行: span=3, 5, 7
   - 結果: span=7で単勝26.15%と改善したが、複勝47.18%、三連複6.15%に悪化
   - 結論: EWMの「慣性」問題により不採用。SQL単純移動平均を継続
   - 詳細: `debug_ewm_detail.py`, `analyze_ewm_issue.py`

3. **低重要度特徴量の削除（完了）**
   - ✅ 既に削除済み（SHAP < 0.005）:
     - `barei_peak_short` (0.000)
     - `barei_peak_distance` (0.002)
     - `baba_condition_score` (0.003)
     - `futan_juryo` (0.004)
     - `distance_change_adaptability` (0.005)
     - `wakuban_bias_score` (0.005)
   - 現在の特徴量数: 26個 → 20個に削減完了

## 💡 改善アプローチ候補

### 方針1: 特徴量の最適化
- [x] ~~**低重要度特徴量の削除**（SHAP < 0.005）~~ ✅ 完了
  - 26個 → 20個に削減完了
  
- [ ] **既存の重要特徴量の強化**
  - **past_avg_sotai_chakujun（SHAP 0.211）の改善**
    - 現在: SQL単純移動平均（直近3走）
    - 改善案1: 参照レース数の最適化（3走 → 5走 or 10走）
    - 改善案2: 着順だけでなく着差も考慮
    - 改善案3: レースグレード重み付け（G1での成績をより重視）
  
  - **umaban_kyori_interaction（SHAP 0.130）の強化**
    - 現在: 単純な積（umaban × kyori / 1000）
    - 改善案: 非線形変換（長距離×外枠のペナルティ強化）
  
  - **騎手特徴量（SHAP 0.061, 0.052）の精緻化**
    - kishu_surface_scoreを競馬場別に分割
    - 騎手×馬の相性特徴量追加
    - 騎手の調子（直近1ヶ月の成績）追加

- [ ] **新規特徴量の追加**
  - 前走からの間隔（休養明け、連闘など）
  - 出走頭数による難易度指標
  - 馬体重・馬体重変化
  - 血統情報（父馬、母父馬）

### 方針2: ハイパーパラメータの再調整
- [ ] **Optunaの試行回数増加**（現在50回 → 100〜200回）
- [ ] **評価指標の変更**（ndcg@1重視 → ndcg@3重視）
- [ ] **LightGBMパラメータ範囲の拡大**

### 方針3: 学習データの見直し
- [ ] **年範囲の最適化**（現在2013-2022 → 直近5年など）
- [ ] **データバランス調整**（人気馬vs穴馬のバランス）
- [ ] **外れ値処理の強化**

### 方針4: アンサンブル学習
- [ ] **複数モデルの組み合わせ**
- [ ] **距離別モデルの細分化**
- [ ] **投票方式の導入**

### 方針5: 予測閾値の最適化
- [ ] **購入判断閾値の調整**
- [ ] **オッズとの組み合わせ判断**
- [ ] **券種別の最適閾値設定**

## 📂 プロジェクト構造

### 主要ファイル
```
KirisameRaceSimulation2/
├── model_creator.py              # モデル作成メイン
├── batch_model_creator.py        # 一括作成スクリプト
├── universal_test.py             # テストスクリプト
├── model_configs.json            # モデル設定
├── keiba_constants.py            # 定数定義
├── model_config_loader.py        # 設定読み込み
│
├── 📊 分析ツール
├── model_explainer.py            # SHAP分析
├── analyze_shap_results.py       # SHAP統計分析
├── test_ewm.py                   # EWMテスト
├── debug_ewm_detail.py           # EWM詳細比較
├── analyze_ewm_issue.py          # EWM問題分析
├── compare_models.py             # モデル比較
│
├── 📁 ディレクトリ
├── models/                       # 学習済みモデル(.sav)
├── results/                      # テスト結果(.tsv)
└── shap_analysis/                # SHAP分析結果
```

### データベース情報
- **DBMS**: PostgreSQL
- **データベース名**: keiba
- **主要テーブル**: jvd_ra, jvd_se
- **接続情報**: localhost:5432, user=postgres

### 現在の特徴量リスト（20個）

**使用中の特徴量:**
1. past_score - 過去スコア (SHAP: 0.076)
2. kohan_3f_index - 後半3Fインデックス (SHAP: 0.052)
3. **past_avg_sotai_chakujun** - 過去平均相対着順 **（SHAP: 0.211 - 最重要!）**
4. time_index - タイムインデックス (SHAP: 0.025)
5. wakuban_ratio - 枠番比率 (SHAP: 0.008)
6. futan_per_barei - 斤量/馬齢比 (SHAP: 0.069)
7. **umaban_kyori_interaction** - 馬番×距離相互作用 **（SHAP: 0.130 - 2位!）**
8. futan_per_barei_log - 斤量/馬齢比のlog変換 (SHAP: 0.011)
9. futan_deviation - 期待斤量からの差分 (SHAP: 0.007)
10. umaban_percentile - 馬番パーセンタイル (SHAP: 0.016)
11. futan_zscore - 斤量標準化スコア (SHAP: 0.019)
12. futan_percentile - 斤量パーセンタイル (SHAP: 0.017)
13. distance_category_score - 距離カテゴリスコア (SHAP: 0.007)
14. similar_distance_score - 類似距離スコア (SHAP: 0.022)
15. surface_aptitude_score - 路面適性スコア (SHAP: 0.018)
16. baba_change_adaptability - 馬場変化適応性 (SHAP: 0.009)
17. **kishu_skill_score** - 騎手スキルスコア **（SHAP: 0.052）**
18. kishu_popularity_score - 騎手人気スコア (SHAP: 0.014)
19. **kishu_surface_score** - 騎手路面スコア **（SHAP: 0.061）**
20. chokyoshi_recent_score - 調教師直近スコア (SHAP: 0.009)

**既に削除済み（コメントアウト）:**
- ✅ barei_peak_distance (SHAP: 0.002)
- ✅ barei_peak_short (SHAP: 0.000)
- ✅ wakuban_bias_score (SHAP: 0.005)
- ✅ distance_change_adaptability (SHAP: 0.005)
- ✅ baba_condition_score (SHAP: 0.003)
- ✅ futan_juryo (SHAP: 0.004)

### 機械学習設定
- **アルゴリズム**: LightGBM LambdaRank
- **最適化**: Optuna（50試行）
- **評価指標**: ndcg@1, ndcg@3, ndcg@5
- **訓練/テスト分割**: 時系列分割（75%/25%）

## 🚀 改善ロードマップ（優先順位付き）

### 🔥 Phase 1: 最重要特徴量の強化（優先度：最高）

**past_avg_sotai_chakujun（SHAP 0.211、影響度51.7%）の改善**

#### 実験1-1: 参照レース数の最適化
- **現状**: 直近3走の平均
- **試行**: 3走 / 5走 / 10走 / 全レースで比較
- **期待効果**: +1.0〜2.0%
- **実装難易度**: ★☆☆☆☆（SQLクエリ修正のみ）
- **所要時間**: 30分

#### 実験1-2: 着差の考慮
- **現状**: 着順のみ（1着 vs 2着を区別するが、0.1秒差 vs 5秒差は区別しない）
- **改善**: 着差を正規化して着順スコアに反映
  - 例: 1着との差が0.1秒 → スコア×0.95
  - 例: 1着との差が3.0秒 → スコア×0.70
- **期待効果**: +0.5〜1.5%
- **実装難易度**: ★★★☆☆（SQLで着差データ取得、正規化ロジック追加）
- **所要時間**: 2時間

#### 実験1-3: レースグレード重み付け
- **現状**: 全レース均等に扱う
- **改善**: G1=3.0倍、G2=2.0倍、G3=1.5倍、OP=1.0倍、その他=0.8倍
- **期待効果**: +0.3〜1.0%
- **実装難易度**: ★★☆☆☆（グレード情報を重み係数に変換）
- **所要時間**: 1時間

**Phase 1の期待効果合計: +1.8〜4.5%（単勝23% → 25〜27%）**

---

### ⚡ Phase 2: 2番目に重要な特徴量の強化（優先度：高）

**umaban_kyori_interaction（SHAP 0.130）の改善**

#### 実験2-1: 非線形変換の導入
- **現状**: 単純な積（umaban × kyori / 1000）
- **改善**: 
  - 長距離(2400m+) × 外枠(13番+): ペナルティ1.5倍
  - 短距離(1400m-) × 内枠(1-3番): ボーナス1.3倍
- **期待効果**: +0.5〜1.0%
- **実装難易度**: ★★☆☆☆
- **所要時間**: 1時間

**Phase 2の期待効果: +0.5〜1.0%**

---

### 🏇 Phase 3: 騎手特徴量の精緻化（優先度：中）

**kishu_surface_score（SHAP 0.061）、kishu_skill_score（SHAP 0.052）**

#### 実験3-1: 競馬場別騎手成績
- **現状**: 芝/ダート全体での成績
- **改善**: 東京芝、中山芝、阪神芝など競馬場×路面別の成績
- **期待効果**: +0.3〜0.8%
- **実装難易度**: ★★★☆☆（SQLクエリ複雑化）
- **所要時間**: 2時間

#### 実験3-2: 騎手×馬の相性
- **追加**: 同じ騎手×同じ馬の過去成績
- **期待効果**: +0.2〜0.5%
- **実装難易度**: ★★★★☆（新規特徴量、結合処理）
- **所要時間**: 3時間

**Phase 3の期待効果: +0.5〜1.3%**

---

### 🔧 Phase 4: ハイパーパラメータ最適化（優先度：中）

#### 実験4-1: Optuna試行回数増加
- **現状**: 50回
- **改善**: 100回 → 200回
- **期待効果**: +0.3〜0.8%
- **実装難易度**: ★☆☆☆☆（パラメータ変更のみ）
- **所要時間**: 計算時間が2〜4倍（実装5分）

#### 実験4-2: 評価指標の変更
- **現状**: ndcg@1重視
- **改善**: ndcg@3重視（複勝・三連複の改善）
- **期待効果**: 単勝-0.5%、複勝+2〜5%、三連複+1〜3%
- **実装難易度**: ★★☆☆☆
- **所要時間**: 30分

**Phase 4の期待効果: +0.3〜0.8%（単勝）、複勝・三連複大幅改善**

---

### 🆕 Phase 5: 新規特徴量追加（優先度：低〜中）

#### 実験5-1: 前走間隔
- **追加**: 前走からの日数（休養明け、連闘）
- **期待効果**: +0.2〜0.5%
- **実装難易度**: ★★★☆☆
- **所要時間**: 2時間

#### 実験5-2: 馬体重変化
- **追加**: 前走比の馬体重増減
- **期待効果**: +0.1〜0.3%
- **実装難易度**: ★★☆☆☆
- **所要時間**: 1時間

**Phase 5の期待効果: +0.3〜0.8%**

---

## 📊 改善効果予測サマリー

| Phase | 内容 | 期待効果 | 難易度 | 所要時間 | 優先度 |
|-------|------|----------|--------|----------|--------|
| **Phase 1** | past_avg_sotai_chakujun強化 | **+1.8〜4.5%** | ★★☆☆☆ | 3.5時間 | 🔥最高 |
| **Phase 2** | umaban_kyori_interaction強化 | +0.5〜1.0% | ★★☆☆☆ | 1時間 | ⚡高 |
| **Phase 3** | 騎手特徴量精緻化 | +0.5〜1.3% | ★★★☆☆ | 5時間 | 🏇中 |
| **Phase 4** | ハイパーパラメータ最適化 | +0.3〜0.8% | ★☆☆☆☆ | 0.5時間 | 🔧中 |
| **Phase 5** | 新規特徴量追加 | +0.3〜0.8% | ★★☆☆☆ | 3時間 | 🆕低〜中 |
| **合計** | - | **+3.4〜8.4%** | - | 13時間 | - |

**目標達成予測:**
- 現在: 単勝23.08%
- Phase 1完了後: 25〜27%（目標30%まで残り3〜5%）
- Phase 2完了後: 26〜28%（目標30%まで残り2〜4%）
- Phase 3-5完了後: **27〜32%**（目標達成の可能性大!）

---

## 🎯 推奨実施順序

### Week 1: Phase 1（最重要）
1. **実験1-1**: 参照レース数最適化（30分）→ テスト → 効果確認
2. **実験1-3**: レースグレード重み付け（1時間）→ テスト → 効果確認
3. **実験1-2**: 着差考慮（2時間）→ テスト → 効果確認

### Week 2: Phase 2 + Phase 4
4. **実験2-1**: 非線形変換（1時間）→ テスト → 効果確認
5. **実験4-1**: Optuna試行回数増加（5分）→ テスト（計算時間長い）
6. **実験4-2**: 評価指標変更（30分）→ テスト → 複勝・三連複改善確認

### Week 3: Phase 3（余裕があれば）
7. **実験3-1**: 競馬場別騎手成績（2時間）→ テスト → 効果確認
8. **実験3-2**: 騎手×馬相性（3時間）→ テスト → 効果確認

### Week 4: Phase 5（時間があれば）
9. **実験5-1**: 前走間隔（2時間）→ テスト → 効果確認
10. **実験5-2**: 馬体重変化（1時間）→ テスト → 効果確認

---

## 🚀 各実験の標準フロー

### Step 1: 実装
```bash
# model_creator.py または SQL を編集
# universal_test.py も同様に修正
```

### Step 2: モデル再作成
```bash
python batch_model_creator.py custom 2013-2022
```

### Step 3: テスト実行
```bash
python universal_test.py multi 2023
```

### Step 4: 結果評価
```bash
# 改善前後を比較
cat results/model_comparison.tsv
cat results/betting_summary_tokyo_turf_3ageup_long.tsv
```

### Step 5: Git記録
```bash
git add .
git commit -m "実験X-X: [実験名] - 単勝XX% (ΔXX%)"
git push
```

## 📝 初回指示の例

「競馬予測モデルの的中率を目標値（単勝30%、複勝70%、三連複15%）まで向上させたい。

現在の成績:
- 単勝23.08%（目標30%）
- 複勝49.23%（目標70%）
- 三連複7.69%（目標15%）

まず、SHAP分析で特定された低重要度特徴量（SHAP<0.005の6個）を削除して効果を検証したい。
その後、必要に応じて新規特徴量追加やハイパーパラメータ調整を行いたい。

プロジェクト詳細は `next_improvement_prompt.md` を参照してください。」

## 📌 重要な注意事項

1. **EWMは使用しない**: 実験結果により不採用が確定
2. **SQL平均を維持**: past_avg_sotai_chakujunはSQL単純移動平均を使用
3. **バックアップ**: 変更前にファイルをバックアップ
4. **段階的改善**: 一度に複数の変更をせず、1つずつ効果を検証
5. **結果記録**: 各実験結果をgitでコミット

## 🎯 成功基準

### 成功ライン
- 単勝: 30%以上
- 複勝: 70%以上
- 三連複: 15%以上

## 📚 参考資料

- `README.md` - プロジェクト全体説明
- `shap_analysis_report.md` - SHAP分析レポート
- `shap_analysis/tokyo_turf_3ageup_long_importance.csv` - 特徴量重要度詳細

---

## 🔥 次のチャットで最初に伝えること

```
競馬予測モデルの的中率改善プロジェクトを進めたい。

【現状】
- 単勝: 23.08%（目標: 30%）→ +6.92%必要
- 複勝: 49.23%（目標: 70%）→ +20.77%必要
- 三連複: 7.69%（目標: 15%）→ +7.31%必要

【完了済み】
✅ SHAP分析: past_avg_sotai_chakujun（SHAP 0.211）が最重要特徴量と判明
✅ EWM実験: span=7で単勝26.15%まで改善したが複勝・三連複が悪化。SQL平均に戻す
✅ 低重要度特徴量削除: 26個→20個に削減完了

【次のステップ】
最重要特徴量 past_avg_sotai_chakujun（SHAP 0.211、影響度51.7%）の改善を優先したい。

改善案:
1. 参照レース数の最適化（現在3走 → 5走 or 10走で検証）
2. 着順だけでなく着差も考慮（2着0.1秒差 vs 2着5秒差を区別）
3. レースグレード重み付け（G1での好走をより高評価）

詳細は `next_improvement_prompt.md` を確認して、具体的な実装案を提案してください。
```

頑張ってね!🔥✨
