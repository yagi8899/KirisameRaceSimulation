=== ãƒ†ã‚¹ãƒˆç”¨SQL ===
ãƒ¢ãƒ‡ãƒ«: walk_forward_results_custom2\period_10\models\2024\ogura_dirt_3age_short_2014-2023.sav
ãƒ†ã‚¹ãƒˆæœŸé–“: 2024å¹´ã€œ2024å¹´
å®Ÿè¡Œæ—¥æ™‚: 2026-01-22 15:39:22


    -- ========== ç«¶é¦¬å ´åˆ¥ç©´é¦¬å‚¾å‘ã‚¹ã‚³ã‚¢ï¼ˆãƒªãƒ¼ã‚¯é˜²æ­¢ï¼šè¨“ç·´æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§è¨ˆç®—ï¼‰ ==========
    WITH track_upset_stats AS (
        SELECT 
            se_stats.keibajo_code,
            COUNT(*) as total_7_12_count,
            SUM(CASE WHEN CAST(se_stats.kakutei_chakujun AS INTEGER) <= 3 THEN 1 ELSE 0 END) as upset_count
        FROM jvd_se se_stats
        INNER JOIN jvd_ra ra_stats
            ON se_stats.kaisai_nen = ra_stats.kaisai_nen 
            AND se_stats.kaisai_tsukihi = ra_stats.kaisai_tsukihi 
            AND se_stats.keibajo_code = ra_stats.keibajo_code 
            AND se_stats.race_bango = ra_stats.race_bango
        WHERE CAST(se_stats.tansho_ninkijun AS INTEGER) BETWEEN 7 AND 12
            AND CAST(ra_stats.kaisai_nen AS INTEGER) BETWEEN 2021 AND 2024
            AND se_stats.kohan_3f <> '000' 
            AND se_stats.kohan_3f <> '999'
        GROUP BY se_stats.keibajo_code
    ),
    track_upset_rates AS (
        SELECT 
            keibajo_code,
            CASE 
                WHEN total_7_12_count > 0 
                THEN CAST(upset_count AS FLOAT) / CAST(total_7_12_count AS FLOAT)
                ELSE 0.10  -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            END as track_upset_rate
        FROM track_upset_stats
    )
    -- ========== ğŸ”¥ Tier S: relative_abilityï¼ˆå¤–å´ã‚¯ã‚¨ãƒªã§è¨ˆç®—ï¼‰ ==========
    SELECT 
        base_features.*,
        -- ç«¶é¦¬å ´åˆ¥ç©´é¦¬å‚¾å‘ã‚¹ã‚³ã‚¢ï¼ˆæ­£è¦åŒ–ï¼š0-1ï¼‰
        COALESCE(
            (base_features.track_upset_rate_raw - MIN(base_features.track_upset_rate_raw) OVER()) / 
            NULLIF(MAX(base_features.track_upset_rate_raw) OVER() - MIN(base_features.track_upset_rate_raw) OVER(), 0),
            0.5
        ) AS track_upset_score,
        -- 5-2. relative_ability: ãƒ¬ãƒ¼ã‚¹å†…ç›¸å¯¾èƒ½åŠ›å€¤ï¼ˆz-scoreï¼‰
        CASE 
            WHEN STDDEV(base_features.past_score_mean) OVER (
                PARTITION BY base_features.kaisai_nen, base_features.kaisai_tsukihi, 
                             base_features.keibajo_code, base_features.race_bango
            ) > 0 THEN
            (base_features.past_score_mean - AVG(base_features.past_score_mean) OVER (
                PARTITION BY base_features.kaisai_nen, base_features.kaisai_tsukihi, 
                             base_features.keibajo_code, base_features.race_bango
            )) / STDDEV(base_features.past_score_mean) OVER (
                PARTITION BY base_features.kaisai_nen, base_features.kaisai_tsukihi, 
                             base_features.keibajo_code, base_features.race_bango
            )
            ELSE 0
        END AS relative_ability
    FROM (
    SELECT 
        inner_query.*,
        COALESCE(tur.track_upset_rate, 0.10) as track_upset_rate_raw
    FROM (
        SELECT * FROM (
            select
            ra.kaisai_nen,
        ra.kaisai_tsukihi,
        ra.keibajo_code,
        CASE 
            WHEN ra.keibajo_code = '01' THEN 'æœ­å¹Œ' 
            WHEN ra.keibajo_code = '02' THEN 'å‡½é¤¨' 
            WHEN ra.keibajo_code = '03' THEN 'ç¦å³¶' 
            WHEN ra.keibajo_code = '04' THEN 'æ–°æ½Ÿ' 
            WHEN ra.keibajo_code = '05' THEN 'æ±äº¬' 
            WHEN ra.keibajo_code = '06' THEN 'ä¸­å±±' 
            WHEN ra.keibajo_code = '07' THEN 'ä¸­äº¬' 
            WHEN ra.keibajo_code = '08' THEN 'äº¬éƒ½' 
            WHEN ra.keibajo_code = '09' THEN 'é˜ªç¥' 
            WHEN ra.keibajo_code = '10' THEN 'å°å€‰' 
            ELSE '' 
        END keibajo_name,
        ra.race_bango,
        ra.kyori,
        ra.tenko_code,
        ra.babajotai_code_dirt as babajotai_code,
        ra.grade_code,
        ra.kyoso_joken_code,
        ra.kyoso_shubetsu_code,
        ra.track_code,
        ra.shusso_tosu,
        seum.ketto_toroku_bango,
        trim(seum.bamei) as bamei,
        seum.wakuban,
        seum.umaban,
        cast(seum.umaban as integer) as umaban_numeric,
        seum.barei,
        seum.kishu_code,
        seum.chokyoshi_code,
        seum.kishu_name,
        seum.chokyoshi_name,
        seum.futan_juryo,
        nullif(cast(seum.tansho_odds as float), 0) / 10 as tansho_odds,
        seum.seibetsu_code,
        seum.corner_1,
        seum.corner_2,
        seum.corner_3,
        seum.corner_4,
        CAST(seum.corner_4 AS INTEGER) AS corner_4_numeric,
        seum.kyakushitsu_hantei,
        nullif(cast(seum.tansho_ninkijun as integer), 0) as tansho_ninkijun_numeric,
        seum.kakutei_chakujun,
        18 - cast(seum.kakutei_chakujun as integer) + 1 as kakutei_chakujun_numeric, 
        1.0 / nullif(cast(seum.kakutei_chakujun as integer), 0) as chakujun_score,  --ä¸Šä½ç€é †ã»ã©1ã«è¿‘ããªã‚‹
        AVG(
            (1 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0)))
            * CASE
                WHEN seum.time_sa LIKE '-%' THEN 1.00  -- 1ç€(ãƒã‚¤ãƒŠã‚¹å€¤) â†’ ä¿‚æ•°1.00(æº€ç‚¹)
                WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 5 THEN 0.85   -- 0.5ç§’å·®ä»¥å†… â†’ 0.85å€(15%æ¸›)
                WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 10 THEN 0.70  -- 1.0ç§’å·®ä»¥å†… â†’ 0.70å€(30%æ¸›)
                WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 20 THEN 0.50  -- 2.0ç§’å·®ä»¥å†… â†’ 0.50å€(50%æ¸›)
                WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 30 THEN 0.30  -- 3.0ç§’å·®ä»¥å†… â†’ 0.30å€(70%æ¸›)
                ELSE 0.20  -- 3.0ç§’è¶… â†’ 0.20å€(å¤§æ•—ã¯ã»ã¼ç„¡è¦–)
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
        ) AS past_avg_sotai_chakujun,
        AVG(
            cast(ra.kyori as integer) /
            NULLIF(
                FLOOR(cast(seum.soha_time as integer) / 1000) * 60 +
                FLOOR((cast(seum.soha_time as integer) % 1000) / 10) +
                (cast(seum.soha_time as integer) % 10) * 0.1,
                0
            )
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
        ) AS time_index,
        SUM(
            CASE 
                WHEN seum.kakutei_chakujun = '01' THEN 100
                WHEN seum.kakutei_chakujun = '02' THEN 80
                WHEN seum.kakutei_chakujun = '03' THEN 60
                WHEN seum.kakutei_chakujun = '04' THEN 40
                WHEN seum.kakutei_chakujun = '05' THEN 30
                WHEN seum.kakutei_chakujun = '06' THEN 20
                WHEN seum.kakutei_chakujun = '07' THEN 10
                ELSE 5 
            END
            * CASE 
                WHEN ra.grade_code = 'A' THEN 3.00                                                                                          --G1 (1.00â†’3.00ã«å¼·åŒ–)
                WHEN ra.grade_code = 'B' THEN 2.00                                                                                          --G2 (0.80â†’2.00ã«å¼·åŒ–)
                WHEN ra.grade_code = 'C' THEN 1.50                                                                                          --G3 (0.60â†’1.50ã«å¼·åŒ–)
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '999' THEN 1.00       --OP (0.50â†’1.00ã«èª¿æ•´)
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '016' THEN 0.80       --3å‹ã‚¯ãƒ©ã‚¹ (0.40â†’0.80ã«èª¿æ•´)
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '010' THEN 0.60       --2å‹ã‚¯ãƒ©ã‚¹ (0.30â†’0.60ã«èª¿æ•´)
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '005' THEN 0.40       --1å‹ã‚¯ãƒ©ã‚¹ (0.20â†’0.40ã«èª¿æ•´)
                ELSE 0.20                                                                                                                   --æœªå‹åˆ© (0.10â†’0.20ã«èª¿æ•´)
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING  
        ) AS past_score,  --ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ¥ã‚¹ã‚³ã‚¢
        CASE 
            WHEN AVG(
                CASE 
                    WHEN cast(seum.kohan_3f as integer) > 0 AND cast(seum.kohan_3f as integer) < 999 THEN
                    CAST(seum.kohan_3f AS FLOAT) / 10
                    ELSE NULL
                END
            ) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
            ) IS NOT NULL THEN
            AVG(
                CASE 
                    WHEN cast(seum.kohan_3f as integer) > 0 AND cast(seum.kohan_3f as integer) < 999 THEN
                    CAST(seum.kohan_3f AS FLOAT) / 10
                    ELSE NULL
                END
            ) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
            ) - 
            CASE
                WHEN cast(ra.kyori as integer) <= 1600 THEN 33.5
                WHEN cast(ra.kyori as integer) <= 2000 THEN 35.0
                WHEN cast(ra.kyori as integer) <= 2400 THEN 36.0
                ELSE 37.0
            END
            ELSE 0
        END AS kohan_3f_index,
        -- é¨æ‰‹ã‚¹ã‚³ã‚¢: éå»30èµ°ã®å¹³å‡ç€é †ã‚¹ã‚³ã‚¢ï¼ˆ1ç€=é«˜ã‚¹ã‚³ã‚¢ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.kishu_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 30 PRECEDING AND 1 PRECEDING
            ) >= 10 THEN
            AVG(1.0 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0))) OVER (
                PARTITION BY seum.kishu_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 30 PRECEDING AND 1 PRECEDING
            )
            ELSE 0.5
        END AS kishu_skill_score,
        -- é¨æ‰‹ã®è·¯é¢åˆ¥ã‚¹ã‚³ã‚¢: éå»50èµ°ã®åŒä¸€è·¯é¢å¹³å‡æˆç¸¾ï¼ˆ1ç€=é«˜ã‚¹ã‚³ã‚¢ï¼‰
        CASE 
            WHEN COUNT(
                CASE 
                    WHEN CASE 
                        WHEN cast(ra.track_code as integer) BETWEEN 10 AND 22 THEN 'turf'
                        WHEN cast(ra.track_code as integer) BETWEEN 23 AND 29 THEN 'dirt'
                        ELSE 'unknown'
                    END = 
                    CASE 
                        WHEN cast(ra.track_code as integer) BETWEEN 10 AND 22 THEN 'turf'
                        WHEN cast(ra.track_code as integer) BETWEEN 23 AND 29 THEN 'dirt'
                        ELSE 'unknown'
                    END
                    THEN 1 ELSE NULL
                END
            ) OVER (
                PARTITION BY seum.kishu_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
            ) >= 5 THEN
            AVG(
                CASE 
                    WHEN CASE 
                        WHEN cast(ra.track_code as integer) BETWEEN 10 AND 22 THEN 'turf'
                        WHEN cast(ra.track_code as integer) BETWEEN 23 AND 29 THEN 'dirt'
                        ELSE 'unknown'
                    END = 
                    CASE 
                        WHEN cast(ra.track_code as integer) BETWEEN 10 AND 22 THEN 'turf'
                        WHEN cast(ra.track_code as integer) BETWEEN 23 AND 29 THEN 'dirt'
                        ELSE 'unknown'
                    END
                    THEN 1.0 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0))
                    ELSE NULL
                END
            ) OVER (
                PARTITION BY seum.kishu_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
            )
            ELSE 0.5
        END AS kishu_surface_score,
        -- èª¿æ•™å¸«ã‚¹ã‚³ã‚¢: éå»20èµ°ã®å¹³å‡ç€é †ã‚¹ã‚³ã‚¢ï¼ˆ1ç€=é«˜ã‚¹ã‚³ã‚¢ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.chokyoshi_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 20 PRECEDING AND 1 PRECEDING
            ) >= 5 THEN
            AVG(1.0 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0))) OVER (
                PARTITION BY seum.chokyoshi_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 20 PRECEDING AND 1 PRECEDING
            )
            ELSE 0.5
        END AS chokyoshi_recent_score,
        -- é¦¬ç•ªãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«: ãƒ¬ãƒ¼ã‚¹å†…ã§ã®é¦¬ç•ªã®ç›¸å¯¾ä½ç½®ï¼ˆ0ï½1ï¼‰
        PERCENT_RANK() OVER (
            PARTITION BY ra.kaisai_nen, ra.kaisai_tsukihi, ra.keibajo_code, ra.race_bango
            ORDER BY cast(seum.umaban as integer)
        ) AS umaban_percentile,
        -- æ–¤é‡Z-score: ãƒ¬ãƒ¼ã‚¹å†…ã§ã®æ–¤é‡ã®æ¨™æº–åŒ–ã‚¹ã‚³ã‚¢
        CASE 
            WHEN STDDEV(cast(seum.futan_juryo as float)) OVER (
                PARTITION BY ra.kaisai_nen, ra.kaisai_tsukihi, ra.keibajo_code, ra.race_bango
            ) > 0 THEN
            (cast(seum.futan_juryo as float) - AVG(cast(seum.futan_juryo as float)) OVER (
                PARTITION BY ra.kaisai_nen, ra.kaisai_tsukihi, ra.keibajo_code, ra.race_bango
            )) / STDDEV(cast(seum.futan_juryo as float)) OVER (
                PARTITION BY ra.kaisai_nen, ra.kaisai_tsukihi, ra.keibajo_code, ra.race_bango
            )
            ELSE 0
        END AS futan_zscore,
        -- æ–¤é‡ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«: ãƒ¬ãƒ¼ã‚¹å†…ã§ã®æ–¤é‡ã®ç›¸å¯¾ä½ç½®ï¼ˆ0ï½1ï¼‰
        PERCENT_RANK() OVER (
            PARTITION BY ra.kaisai_nen, ra.kaisai_tsukihi, ra.keibajo_code, ra.race_bango
            ORDER BY cast(seum.futan_juryo as float)
        ) AS futan_percentile,
        -- çŸ­è·é›¢ã‚¹ã‚³ã‚¢: 1000-1400mã§ã®éå»5èµ°ã®å¹³å‡æˆç¸¾ã‚¹ã‚³ã‚¢
        AVG(
            CASE 
                WHEN cast(ra.kyori as integer) BETWEEN 1000 AND 1400
                THEN (1 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0)))
                    * CASE
                        WHEN seum.time_sa LIKE '-%' THEN 1.00
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 5 THEN 0.85
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 10 THEN 0.70
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 20 THEN 0.50
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 30 THEN 0.30
                        ELSE 0.20
                    END
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING
        ) AS past_score_short,
        -- ãƒã‚¤ãƒ«ã‚¹ã‚³ã‚¢: 1401-1800mã§ã®éå»5èµ°ã®å¹³å‡æˆç¸¾ã‚¹ã‚³ã‚¢
        AVG(
            CASE 
                WHEN cast(ra.kyori as integer) BETWEEN 1401 AND 1800
                THEN (1 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0)))
                    * CASE
                        WHEN seum.time_sa LIKE '-%' THEN 1.00
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 5 THEN 0.85
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 10 THEN 0.70
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 20 THEN 0.50
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 30 THEN 0.30
                        ELSE 0.20
                    END
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING
        ) AS past_score_mile,
        -- ä¸­è·é›¢ã‚¹ã‚³ã‚¢: 1801-2400mã§ã®éå»5èµ°ã®å¹³å‡æˆç¸¾ã‚¹ã‚³ã‚¢
        AVG(
            CASE 
                WHEN cast(ra.kyori as integer) BETWEEN 1801 AND 2400
                THEN (1 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0)))
                    * CASE
                        WHEN seum.time_sa LIKE '-%' THEN 1.00
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 5 THEN 0.85
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 10 THEN 0.70
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 20 THEN 0.50
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 30 THEN 0.30
                        ELSE 0.20
                    END
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING
        ) AS past_score_middle,
        -- é•·è·é›¢ã‚¹ã‚³ã‚¢: 2401mä»¥ä¸Šã§ã®éå»5èµ°ã®å¹³å‡æˆç¸¾ã‚¹ã‚³ã‚¢
        AVG(
            CASE 
                WHEN cast(ra.kyori as integer) >= 2401
                THEN (1 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0)))
                    * CASE
                        WHEN seum.time_sa LIKE '-%' THEN 1.00
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 5 THEN 0.85
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 10 THEN 0.70
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 20 THEN 0.50
                        WHEN CAST(REPLACE(seum.time_sa, '+', '') AS INTEGER) <= 30 THEN 0.30
                        ELSE 0.20
                    END
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING
        ) AS past_score_long,
        -- å‰èµ°è·é›¢å·®: å‰èµ°ã¨ã®è·é›¢å·®ï¼ˆmï¼‰
        cast(ra.kyori as integer) - LAG(cast(ra.kyori as integer)) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS zenso_kyori_sa,
        -- å‰èµ°è·é›¢: å‰èµ°ã®ãƒ¬ãƒ¼ã‚¹è·é›¢ï¼ˆmï¼‰
        LAG(cast(ra.kyori as integer)) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS zenso_kyori,
        -- å‰èµ°ç€é †: å‰èµ°ã®ç¢ºå®šç€é †
        LAG(cast(seum.kakutei_chakujun as integer)) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS zenso_chakujun,
        -- é•·è·é›¢çµŒé¨“å›æ•°: éå»ã®2200mä»¥ä¸Šãƒ¬ãƒ¼ã‚¹çµŒé¨“å›æ•°
        COUNT(
            CASE WHEN cast(ra.kyori as integer) >= 2200 THEN 1 ELSE NULL END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
        ) AS long_distance_experience_count,
        -- ã‚¹ã‚¿ãƒ¼ãƒˆæŒ‡æ•°: éå»ã®1ã‚³ãƒ¼ãƒŠãƒ¼å¹³å‡ä½ç½®ã¨é¦¬ç•ªå¹³å‡ã®å·®ï¼ˆå®Œå…¨ç‰ˆï¼‰
        CASE 
            WHEN COUNT(
                CASE WHEN seum.corner_1 IS NOT NULL AND seum.corner_1 <> '' THEN 1 ELSE NULL END
            ) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
            ) >= 1 THEN
            AVG(
                CASE 
                    WHEN seum.corner_1 IS NOT NULL AND seum.corner_1 <> '' 
                    THEN cast(seum.corner_1 as float)
                    ELSE NULL
                END
            ) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
            ) - 
            AVG(cast(seum.umaban as float)) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
            )
            ELSE 0
        END AS start_index,
        -- ã‚³ãƒ¼ãƒŠãƒ¼ä½ç½®ã‚¹ã‚³ã‚¢: éå»3èµ°ã®å…¨ã‚³ãƒ¼ãƒŠãƒ¼å¹³å‡ä½ç½®
        (
            COALESCE(AVG(
                CASE 
                    WHEN seum.corner_1 IS NOT NULL AND seum.corner_1 <> '' 
                    THEN cast(seum.corner_1 as float)
                    ELSE NULL
                END
            ) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
            ), 0) +
            COALESCE(AVG(
                CASE 
                    WHEN seum.corner_2 IS NOT NULL AND seum.corner_2 <> '' 
                    THEN cast(seum.corner_2 as float)
                    ELSE NULL
                END
            ) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
            ), 0) +
            COALESCE(AVG(
                CASE 
                    WHEN seum.corner_3 IS NOT NULL AND seum.corner_3 <> '' 
                    THEN cast(seum.corner_3 as float)
                    ELSE NULL
                END
            ) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
            ), 0) +
            COALESCE(AVG(
                CASE 
                    WHEN seum.corner_4 IS NOT NULL AND seum.corner_4 <> '' 
                    THEN cast(seum.corner_4 as float)
                    ELSE NULL
                END
            ) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
            ), 0)
        ) / 4.0 AS corner_position_score,
        -- è·¯é¢é©æ€§ã‚¹ã‚³ã‚¢: åŒä¸€è·¯é¢ã§ã®éå»3èµ°å¹³å‡ç€é †ã‚¹ã‚³ã‚¢
        AVG(
            CASE 
                WHEN CASE 
                    WHEN cast(ra.track_code as integer) BETWEEN 10 AND 22 THEN 'turf'
                    WHEN cast(ra.track_code as integer) BETWEEN 23 AND 29 THEN 'dirt'
                    ELSE 'unknown'
                END = 
                CASE 
                    WHEN cast(ra.track_code as integer) BETWEEN 10 AND 22 THEN 'turf'
                    WHEN cast(ra.track_code as integer) BETWEEN 23 AND 29 THEN 'dirt'
                    ELSE 'unknown'
                END
                THEN 1.0 / nullif(cast(seum.kakutei_chakujun as integer), 0)
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
        ) AS surface_aptitude_score,
        -- ========== ğŸ”¥ Tier S: ãƒ©ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’å¿…é ˆç‰¹å¾´é‡ ==========
        -- 1. current_class_score: ä»Šå›ãƒ¬ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¹ã‚¹ã‚³ã‚¢
        CASE 
            WHEN ra.grade_code = 'A' THEN 3.00                                                                                          -- G1
            WHEN ra.grade_code = 'B' THEN 2.00                                                                                          -- G2
            WHEN ra.grade_code = 'C' THEN 1.50                                                                                          -- G3
            WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '999' THEN 1.00       -- OP
            WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '016' THEN 0.80       -- 3å‹ã‚¯ãƒ©ã‚¹
            WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '010' THEN 0.60       -- 2å‹ã‚¯ãƒ©ã‚¹
            WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '005' THEN 0.40       -- 1å‹ã‚¯ãƒ©ã‚¹
            ELSE 0.20                                                                                                                   -- æœªå‹åˆ©
        END AS current_class_score,
        -- 2. class_score_change: ã‚¯ãƒ©ã‚¹ã‚¹ã‚³ã‚¢å¤‰åŒ–åº¦ï¼ˆè² =é™ç´šã€æ­£=æ˜‡ç´šï¼‰
        CASE 
            WHEN ra.grade_code = 'A' THEN 3.00
            WHEN ra.grade_code = 'B' THEN 2.00
            WHEN ra.grade_code = 'C' THEN 1.50
            WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '999' THEN 1.00
            WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '016' THEN 0.80
            WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '010' THEN 0.60
            WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '005' THEN 0.40
            ELSE 0.20
        END - LAG(
            CASE 
                WHEN ra.grade_code = 'A' THEN 3.00
                WHEN ra.grade_code = 'B' THEN 2.00
                WHEN ra.grade_code = 'C' THEN 1.50
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '999' THEN 1.00
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '016' THEN 0.80
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '010' THEN 0.60
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '005' THEN 0.40
                ELSE 0.20
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS class_score_change,
        -- 4. kyuyo_kikan: ä¼‘é¤ŠæœŸé–“ï¼ˆæ—¥æ•°ï¼‰
        TO_DATE(ra.kaisai_nen || ra.kaisai_tsukihi, 'YYYYMMDD') - 
        LAG(TO_DATE(ra.kaisai_nen || ra.kaisai_tsukihi, 'YYYYMMDD')) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS kyuyo_kikan,
        -- 5-1. past_score_mean: éå»3èµ°ã®past_scoreã®å¹³å‡å€¤ï¼ˆrelative_abilityè¨ˆç®—ç”¨ï¼‰
        AVG(
            CASE 
                WHEN seum.kakutei_chakujun = '01' THEN 100
                WHEN seum.kakutei_chakujun = '02' THEN 80
                WHEN seum.kakutei_chakujun = '03' THEN 60
                WHEN seum.kakutei_chakujun = '04' THEN 40
                WHEN seum.kakutei_chakujun = '05' THEN 30
                WHEN seum.kakutei_chakujun = '06' THEN 20
                WHEN seum.kakutei_chakujun = '07' THEN 10
                ELSE 5 
            END
            * CASE 
                WHEN ra.grade_code = 'A' THEN 3.00
                WHEN ra.grade_code = 'B' THEN 2.00
                WHEN ra.grade_code = 'C' THEN 1.50
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '999' THEN 1.00
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '016' THEN 0.80
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '010' THEN 0.60
                WHEN ra.grade_code <> 'A' AND ra.grade_code <> 'B' AND ra.grade_code <> 'C' AND ra.kyoso_joken_code = '005' THEN 0.40
                ELSE 0.20
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING  
        ) AS past_score_mean,
        -- ğŸŸ¢ Tier A: ãƒ©ãƒ³ã‚­ãƒ³ã‚°å·®åˆ¥åŒ–ç‰¹å¾´é‡
        -- 6. left_direction_score: å·¦å›ã‚Šæˆç¸¾ã‚¹ã‚³ã‚¢ï¼ˆéå»10èµ°å¹³å‡ï¼‰
        AVG(
            CASE 
                WHEN ra.track_code IN ('11', '12', '13', '14', '15', '16', '23', '25', '26')
                THEN (1.0 - cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0))
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 10 PRECEDING AND 1 PRECEDING
        ) AS left_direction_score,
        -- 9. right_direction_score: å³å›ã‚Šæˆç¸¾ã‚¹ã‚³ã‚¢ï¼ˆéå»10èµ°å¹³å‡ï¼‰
        AVG(
            CASE 
                WHEN ra.track_code IN ('17', '18', '19', '20', '21', '22', '24')
                THEN (1.0 - cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0))
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ROWS BETWEEN 10 PRECEDING AND 1 PRECEDING
        ) AS right_direction_score,
        -- 10. current_direction_match: ä»Šå›ã‚³ãƒ¼ã‚¹å›ã‚Šé©æ€§
        CASE 
            WHEN ra.track_code IN ('11', '12', '13', '14', '15', '16', '23', '25', '26') THEN
                AVG(
                    CASE 
                        WHEN ra.track_code IN ('11', '12', '13', '14', '15', '16', '23', '25', '26')
                        THEN (1.0 - cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0))
                        ELSE NULL
                    END
                ) OVER (
                    PARTITION BY seum.ketto_toroku_bango
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN 10 PRECEDING AND 1 PRECEDING
                )
            WHEN ra.track_code IN ('17', '18', '19', '20', '21', '22', '24') THEN
                AVG(
                    CASE 
                        WHEN ra.track_code IN ('17', '18', '19', '20', '21', '22', '24')
                        THEN (1.0 - cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0))
                        ELSE NULL
                    END
                ) OVER (
                    PARTITION BY seum.ketto_toroku_bango
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN 10 PRECEDING AND 1 PRECEDING
                )
            ELSE 0.5  -- ç›´ç·šã‚³ãƒ¼ã‚¹ï¼ˆ10, 29ï¼‰ã¯ä¸­ç«‹å€¤
        END AS current_direction_match,
        -- ğŸ”¥ Phase 3: ç©´é¦¬ç‰¹åŒ–ç‰¹å¾´é‡ï¼ˆãƒ•ã‚§ãƒ¼ã‚º1ï¼‰
        -- 1. past_score_std: æˆç¸¾ã‚¹ã‚³ã‚¢æ¨™æº–åå·®ï¼ˆéå»5èµ°ï¼‰
        CASE 
            WHEN COUNT(seum.kakutei_chakujun) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING
            ) >= 2 THEN
                (
                    SELECT SQRT(AVG((score - avg_score) * (score - avg_score)))
                    FROM (
                        SELECT 
                            (1.0 - cast(seum2.kakutei_chakujun as float) / NULLIF(cast(ra2.shusso_tosu as float), 0))
                            * CASE
                                WHEN seum2.time_sa LIKE '-%' THEN 1.00
                                WHEN CAST(REPLACE(seum2.time_sa, '+', '') AS INTEGER) <= 5 THEN 0.85
                                WHEN CAST(REPLACE(seum2.time_sa, '+', '') AS INTEGER) <= 10 THEN 0.70
                                WHEN CAST(REPLACE(seum2.time_sa, '+', '') AS INTEGER) <= 20 THEN 0.50
                                WHEN CAST(REPLACE(seum2.time_sa, '+', '') AS INTEGER) <= 30 THEN 0.30
                                ELSE 0.20
                            END AS score,
                            AVG(
                                (1.0 - cast(seum2.kakutei_chakujun as float) / NULLIF(cast(ra2.shusso_tosu as float), 0))
                                * CASE
                                    WHEN seum2.time_sa LIKE '-%' THEN 1.00
                                    WHEN CAST(REPLACE(seum2.time_sa, '+', '') AS INTEGER) <= 5 THEN 0.85
                                    WHEN CAST(REPLACE(seum2.time_sa, '+', '') AS INTEGER) <= 10 THEN 0.70
                                    WHEN CAST(REPLACE(seum2.time_sa, '+', '') AS INTEGER) <= 20 THEN 0.50
                                    WHEN CAST(REPLACE(seum2.time_sa, '+', '') AS INTEGER) <= 30 THEN 0.30
                                    ELSE 0.20
                                END
                            ) OVER () AS avg_score
                        FROM jvd_se seum2
                        INNER JOIN jvd_ra ra2 
                            ON seum2.kaisai_nen = ra2.kaisai_nen
                            AND seum2.kaisai_tsukihi = ra2.kaisai_tsukihi
                            AND seum2.keibajo_code = ra2.keibajo_code
                            AND seum2.race_bango = ra2.race_bango
                        WHERE seum2.ketto_toroku_bango = seum.ketto_toroku_bango
                            AND (
                                cast(ra2.kaisai_nen as integer) < cast(ra.kaisai_nen as integer)
                                OR (
                                    cast(ra2.kaisai_nen as integer) = cast(ra.kaisai_nen as integer)
                                    AND cast(ra2.kaisai_tsukihi as integer) < cast(ra.kaisai_tsukihi as integer)
                                )
                            )
                        ORDER BY cast(ra2.kaisai_nen as integer) DESC, cast(ra2.kaisai_tsukihi as integer) DESC
                        LIMIT 5
                    )
                )
            ELSE -1
        END AS past_score_std,
        -- 2. past_chakujun_variance: ç€é †åˆ†æ•£ï¼ˆéå»5èµ°ï¼‰
        CASE 
            WHEN COUNT(seum.kakutei_chakujun) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING
            ) >= 2 THEN
                (
                    SELECT AVG((chaku - avg_chaku) * (chaku - avg_chaku))
                    FROM (
                        SELECT 
                            cast(seum2.kakutei_chakujun as float) AS chaku,
                            AVG(cast(seum2.kakutei_chakujun as float)) OVER () AS avg_chaku
                        FROM jvd_se seum2
                        INNER JOIN jvd_ra ra2 
                            ON seum2.kaisai_nen = ra2.kaisai_nen
                            AND seum2.kaisai_tsukihi = ra2.kaisai_tsukihi
                            AND seum2.keibajo_code = ra2.keibajo_code
                            AND seum2.race_bango = ra2.race_bango
                        WHERE seum2.ketto_toroku_bango = seum.ketto_toroku_bango
                            AND (
                                cast(ra2.kaisai_nen as integer) < cast(ra.kaisai_nen as integer)
                                OR (
                                    cast(ra2.kaisai_nen as integer) = cast(ra.kaisai_nen as integer)
                                    AND cast(ra2.kaisai_tsukihi as integer) < cast(ra.kaisai_tsukihi as integer)
                                )
                            )
                        ORDER BY cast(ra2.kaisai_nen as integer) DESC, cast(ra2.kaisai_tsukihi as integer) DESC
                        LIMIT 5
                    )
                )
            ELSE -1
        END AS past_chakujun_variance,
        -- 3. zenso_oikomi_power: å‰èµ°è¿½ã„è¾¼ã¿åŠ›ï¼ˆå‰èµ°4ã‚³ãƒ¼ãƒŠãƒ¼ä½ç½® - å‰èµ°ç€é †ï¼‰
        LAG(
            CASE 
                WHEN seum.corner_4 IS NOT NULL AND seum.corner_4 <> '' 
                    AND cast(seum.corner_4 as integer) > 0
                THEN cast(seum.corner_4 as float) - cast(seum.kakutei_chakujun as float)
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS zenso_oikomi_power,
        -- 4. zenso_kakoi_komon: å‰èµ°åŒ…ã¾ã‚Œåº¦ï¼ˆå‰èµ°2ã‚³ãƒ¼ãƒŠãƒ¼ä½ç½® - å‰èµ°4ã‚³ãƒ¼ãƒŠãƒ¼ä½ç½®ï¼‰
        LAG(
            CASE 
                WHEN seum.corner_2 IS NOT NULL AND seum.corner_2 <> '' 
                    AND seum.corner_4 IS NOT NULL AND seum.corner_4 <> ''
                    AND cast(seum.corner_2 as integer) > 0
                    AND cast(seum.corner_4 as integer) > 0
                THEN cast(seum.corner_2 as float) - cast(seum.corner_4 as float)
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS zenso_kakoi_komon,
        -- ğŸ†• Phase 3.5: è¿½åŠ ç‰¹å¾´é‡ï¼ˆ2026-01-20ï¼‰
        -- 5. zenso_ninki_gap: å‰èµ°äººæ°—ç€é †ã‚®ãƒ£ãƒƒãƒ—ï¼ˆå‰èµ°äººæ°— - å‰èµ°ç€é †ï¼‰
        LAG(
            CASE 
                WHEN seum.tansho_ninkijun IS NOT NULL AND seum.tansho_ninkijun <> ''
                    AND cast(seum.tansho_ninkijun as integer) > 0
                THEN cast(seum.tansho_ninkijun as float) - cast(seum.kakutei_chakujun as float)
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS zenso_ninki_gap,
        -- 6. zenso_nigeba: å‰èµ°é€ƒã’æˆåŠŸãƒ•ãƒ©ã‚°ï¼ˆå‰èµ°ç¬¬1ã‚³ãƒ¼ãƒŠãƒ¼1ä½ï¼‰
        LAG(
            CASE 
                WHEN seum.corner_1 IS NOT NULL AND seum.corner_1 <> ''
                    AND (seum.corner_1 = '01' OR seum.corner_1 = '1')
                THEN 1
                ELSE 0
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS zenso_nigeba,
        -- 7. zenso_taihai: å‰èµ°å¤§æ•—ãƒ•ãƒ©ã‚°ï¼ˆå‰èµ°10ç€ä»¥ä¸‹ï¼‰
        LAG(
            CASE 
                WHEN seum.kakutei_chakujun IS NOT NULL AND seum.kakutei_chakujun <> ''
                    AND cast(seum.kakutei_chakujun as integer) > 10
                THEN 1
                ELSE 0
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS zenso_taihai,
        -- 8. zenso_agari_rank: å‰èµ°ä¸ŠãŒã‚Š3Fé †ä½ï¼ˆãƒ¬ãƒ¼ã‚¹å†…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰
        LAG(
            CASE 
                WHEN seum.kohan_3f IS NOT NULL AND seum.kohan_3f <> '' 
                    AND seum.kohan_3f <> '000' AND seum.kohan_3f <> '999'
                THEN (
                    SELECT COUNT(*) + 1
                    FROM jvd_se seum3
                    WHERE seum3.kaisai_nen = seum.kaisai_nen
                        AND seum3.kaisai_tsukihi = seum.kaisai_tsukihi
                        AND seum3.keibajo_code = seum.keibajo_code
                        AND seum3.race_bango = seum.race_bango
                        AND seum3.kohan_3f IS NOT NULL
                        AND seum3.kohan_3f <> '' 
                        AND seum3.kohan_3f <> '000' 
                        AND seum3.kohan_3f <> '999'
                        AND cast(seum3.kohan_3f as integer) < cast(seum.kohan_3f as integer)
                )
                ELSE NULL
            END
        ) OVER (
            PARTITION BY seum.ketto_toroku_bango
            ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
        ) AS zenso_agari_rank,
        -- 9. saikin_kaikakuritsu: ç›´è¿‘3èµ°æ”¹å–„ç‡ï¼ˆå‰èµ°ã‚ˆã‚Šç€é †ãŒæ”¹å–„ã—ãŸå‰²åˆï¼‰
        CASE 
            WHEN COUNT(seum.kakutei_chakujun) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING
            ) >= 3 THEN
                (
                    CAST(
                        (CASE 
                            WHEN LAG(cast(seum.kakutei_chakujun as integer), 1) OVER (
                                PARTITION BY seum.ketto_toroku_bango
                                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                            ) < LAG(cast(seum.kakutei_chakujun as integer), 2) OVER (
                                PARTITION BY seum.ketto_toroku_bango
                                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                            ) THEN 1 ELSE 0 END) +
                        (CASE 
                            WHEN LAG(cast(seum.kakutei_chakujun as integer), 2) OVER (
                                PARTITION BY seum.ketto_toroku_bango
                                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                            ) < LAG(cast(seum.kakutei_chakujun as integer), 3) OVER (
                                PARTITION BY seum.ketto_toroku_bango
                                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                            ) THEN 1 ELSE 0 END)
                    AS FLOAT) / 2.0
                )
            ELSE NULL
        END AS saikin_kaikakuritsu,
        -- ğŸ”¥ Phase 3.5: é¨æ‰‹ãƒ»èª¿æ•™å¸«ãƒ»é¦¬çµ±è¨ˆç‰¹å¾´é‡ï¼ˆ2026-01-20 è¿½åŠ ï¼‰
        -- 10. jockey_win_rate: é¨æ‰‹å‹ç‡ï¼ˆéå»50èµ°ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.kishu_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
            ) >= 10 THEN
                AVG(
                    CASE WHEN cast(seum.kakutei_chakujun as integer) = 1 THEN 1.0 ELSE 0.0 END
                ) OVER (
                    PARTITION BY seum.kishu_code
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
                )
            ELSE NULL
        END AS jockey_win_rate,
        -- 11. jockey_place_rate: é¨æ‰‹é€£å¯¾ç‡ï¼ˆéå»50èµ°ã§3ç€ä»¥å†…ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.kishu_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
            ) >= 10 THEN
                AVG(
                    CASE WHEN cast(seum.kakutei_chakujun as integer) <= 3 THEN 1.0 ELSE 0.0 END
                ) OVER (
                    PARTITION BY seum.kishu_code
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
                )
            ELSE NULL
        END AS jockey_place_rate,
        -- 12. jockey_recent_form: é¨æ‰‹æœ€è¿‘æˆç¸¾ï¼ˆéå»10èµ°å¹³å‡ç€é †ã‚¹ã‚³ã‚¢ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.kishu_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 10 PRECEDING AND 1 PRECEDING
            ) >= 5 THEN
                AVG(
                    1.0 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0))
                ) OVER (
                    PARTITION BY seum.kishu_code
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN 10 PRECEDING AND 1 PRECEDING
                )
            ELSE NULL
        END AS jockey_recent_form,
        -- 13. trainer_win_rate: èª¿æ•™å¸«å‹ç‡ï¼ˆéå»50èµ°ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.chokyoshi_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
            ) >= 10 THEN
                AVG(
                    CASE WHEN cast(seum.kakutei_chakujun as integer) = 1 THEN 1.0 ELSE 0.0 END
                ) OVER (
                    PARTITION BY seum.chokyoshi_code
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
                )
            ELSE NULL
        END AS trainer_win_rate,
        -- 14. trainer_place_rate: èª¿æ•™å¸«é€£å¯¾ç‡ï¼ˆéå»50èµ°ã§3ç€ä»¥å†…ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.chokyoshi_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
            ) >= 10 THEN
                AVG(
                    CASE WHEN cast(seum.kakutei_chakujun as integer) <= 3 THEN 1.0 ELSE 0.0 END
                ) OVER (
                    PARTITION BY seum.chokyoshi_code
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN 50 PRECEDING AND 1 PRECEDING
                )
            ELSE NULL
        END AS trainer_place_rate,
        -- 15. trainer_recent_form: èª¿æ•™å¸«æœ€è¿‘æˆç¸¾ï¼ˆéå»20èµ°å¹³å‡ç€é †ã‚¹ã‚³ã‚¢ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.chokyoshi_code
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN 20 PRECEDING AND 1 PRECEDING
            ) >= 5 THEN
                AVG(
                    1.0 - (cast(seum.kakutei_chakujun as float) / NULLIF(cast(ra.shusso_tosu as float), 0))
                ) OVER (
                    PARTITION BY seum.chokyoshi_code
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN 20 PRECEDING AND 1 PRECEDING
                )
            ELSE NULL
        END AS trainer_recent_form,
        -- 16. horse_career_win_rate: é¦¬é€šç®—å‹ç‡ï¼ˆå…¨ãƒ¬ãƒ¼ã‚¹ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
            ) >= 3 THEN
                AVG(
                    CASE WHEN cast(seum.kakutei_chakujun as integer) = 1 THEN 1.0 ELSE 0.0 END
                ) OVER (
                    PARTITION BY seum.ketto_toroku_bango
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
                )
            ELSE NULL
        END AS horse_career_win_rate,
        -- 17. horse_career_place_rate: é¦¬é€šç®—é€£å¯¾ç‡ï¼ˆå…¨ãƒ¬ãƒ¼ã‚¹ã§3ç€ä»¥å†…ï¼‰
        CASE 
            WHEN COUNT(*) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
            ) >= 3 THEN
                AVG(
                    CASE WHEN cast(seum.kakutei_chakujun as integer) <= 3 THEN 1.0 ELSE 0.0 END
                ) OVER (
                    PARTITION BY seum.ketto_toroku_bango
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                    ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING
                )
            ELSE NULL
        END AS horse_career_place_rate,
        -- 18. rest_weeks: ä¼‘é¤Šé€±æ•°ï¼ˆå‰èµ°ã‹ã‚‰ä»Šå›ã¾ã§ã®é€±æ•°ï¼‰
        CASE 
            WHEN LAG(TO_DATE(ra.kaisai_nen || ra.kaisai_tsukihi, 'YYYYMMDD')) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ) IS NOT NULL THEN
                (TO_DATE(ra.kaisai_nen || ra.kaisai_tsukihi, 'YYYYMMDD') - 
                 LAG(TO_DATE(ra.kaisai_nen || ra.kaisai_tsukihi, 'YYYYMMDD')) OVER (
                     PARTITION BY seum.ketto_toroku_bango
                     ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                 )) / 7.0
            ELSE NULL
        END AS rest_weeks,
        -- ğŸ†• Phase 1: ç©´é¦¬äºˆæ¸¬å¼·åŒ–ç‰¹å¾´é‡ï¼ˆ2026-01-20 è¿½åŠ ï¼‰
        -- 1. is_turf_bad_condition: èŠä¸è‰¯ãƒ•ãƒ©ã‚°ï¼ˆæœ€å¤§åŠ¹æœ+3.35%ï¼‰
        CASE 
            WHEN cast(ra.track_code as integer) BETWEEN 10 AND 22
                AND ra.babajotai_code_dirt = '4' THEN 1
            ELSE 0
        END AS is_turf_bad_condition,
        -- 2. is_turf_heavy: èŠé‡ãƒ•ãƒ©ã‚°ï¼ˆåŠ¹æœ+1.73%ï¼‰
        CASE 
            WHEN cast(ra.track_code as integer) BETWEEN 10 AND 22
                AND ra.babajotai_code_dirt = '3' THEN 1
            ELSE 0
        END AS is_turf_heavy,
        -- 3. is_local_track: ãƒ­ãƒ¼ã‚«ãƒ«ç«¶é¦¬å ´ãƒ•ãƒ©ã‚°ï¼ˆåŠ¹æœ+1.47%ï¼‰
        CASE 
            WHEN ra.keibajo_code IN ('01', '02', '03', '10') THEN 1  -- æœ­å¹Œ/å‡½é¤¨/ç¦å³¶/å°å€‰
            ELSE 0
        END AS is_local_track,
        -- ğŸ†• Phase 1.6: ç«¶é¦¬å ´åˆ¥æ”¹å–„ç‰¹å¾´é‡ï¼ˆ2026-01-21 è¿½åŠ ï¼‰
        -- num_runners: å‡ºèµ°é ­æ•°ï¼ˆå¤šé ­æ•°â†’ç©´é¦¬æœ‰åˆ©ã®ä»®èª¬ï¼‰
        CAST(ra.shusso_tosu AS INTEGER) AS num_runners,
        -- is_full_field: ãƒ•ãƒ«ã‚²ãƒ¼ãƒˆãƒ•ãƒ©ã‚°ï¼ˆ16é ­ä»¥ä¸Šï¼‰
        CASE 
            WHEN CAST(ra.shusso_tosu AS INTEGER) >= 16 THEN 1
            ELSE 0
        END AS is_full_field,
        -- 4. is_open_class: ã‚ªãƒ¼ãƒ—ãƒ³ã‚¯ãƒ©ã‚¹ãƒ•ãƒ©ã‚°ï¼ˆåŠ¹æœ+2.38%ï¼‰
        CASE 
            WHEN ra.grade_code NOT IN ('A', 'B', 'C') 
                AND ra.kyoso_joken_code = '999' THEN 1
            ELSE 0
        END AS is_open_class,
        -- 5. is_3win_class: 3å‹ã‚¯ãƒ©ã‚¹ãƒ•ãƒ©ã‚°ï¼ˆåŠ¹æœ+2.22%ï¼‰
        CASE 
            WHEN ra.grade_code NOT IN ('A', 'B', 'C') 
                AND ra.kyoso_joken_code = '016' THEN 1
            ELSE 0
        END AS is_3win_class,
        -- 6. is_age_prime: æœ€ç››æœŸå¹´é½¢ãƒ•ãƒ©ã‚°ï¼ˆ4-5æ­³ã€åŠ¹æœ+1.50%ï¼‰
        CASE 
            WHEN cast(seum.barei as integer) BETWEEN 4 AND 5 THEN 1
            ELSE 0
        END AS is_age_prime,
        -- 7. zenso_top6: å‰èµ°6ç€ä»¥å†…ãƒ•ãƒ©ã‚°ï¼ˆåŠ¹æœ+1.82%ï¼‰
        CASE 
            WHEN LAG(cast(seum.kakutei_chakujun as integer)) OVER (
                PARTITION BY seum.ketto_toroku_bango
                ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
            ) <= 6 THEN 1
            ELSE 0
        END AS zenso_top6,
        -- 8. rest_days_fresh: ä¼‘é¤Š1-3é€±ãƒ•ãƒ©ã‚°ï¼ˆåŠ¹æœ+0.5%ï¼‰
        CASE 
            WHEN CASE 
                WHEN LAG(TO_DATE(ra.kaisai_nen || ra.kaisai_tsukihi, 'YYYYMMDD')) OVER (
                    PARTITION BY seum.ketto_toroku_bango
                    ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                ) IS NOT NULL THEN
                    (TO_DATE(ra.kaisai_nen || ra.kaisai_tsukihi, 'YYYYMMDD') - 
                     LAG(TO_DATE(ra.kaisai_nen || ra.kaisai_tsukihi, 'YYYYMMDD')) OVER (
                         PARTITION BY seum.ketto_toroku_bango
                         ORDER BY cast(ra.kaisai_nen as integer), cast(ra.kaisai_tsukihi as integer)
                     )) / 7.0
                ELSE NULL
            END BETWEEN 1 AND 3 THEN 1
            ELSE 0
        END AS rest_days_fresh,nullif(cast(nullif(trim(hr.haraimodoshi_fukusho_1a), '') as integer), 0) as è¤‡å‹1ç€é¦¬ç•ª
        ,nullif(cast(nullif(trim(hr.haraimodoshi_fukusho_1b), '') as float), 0) / 100 as è¤‡å‹1ç€ã‚ªãƒƒã‚º
        ,nullif(cast(nullif(trim(hr.haraimodoshi_fukusho_1c), '') as integer), 0) as è¤‡å‹1ç€äººæ°—
        ,nullif(cast(nullif(trim(hr.haraimodoshi_fukusho_2a), '') as integer), 0) as è¤‡å‹2ç€é¦¬ç•ª
        ,nullif(cast(nullif(trim(hr.haraimodoshi_fukusho_2b), '') as float), 0) / 100 as è¤‡å‹2ç€ã‚ªãƒƒã‚º
        ,nullif(cast(nullif(trim(hr.haraimodoshi_fukusho_2c), '') as integer), 0) as è¤‡å‹2ç€äººæ°—
        ,nullif(cast(nullif(trim(hr.haraimodoshi_fukusho_3a), '') as integer), 0) as è¤‡å‹3ç€é¦¬ç•ª
        ,nullif(cast(nullif(trim(hr.haraimodoshi_fukusho_3b), '') as float), 0) / 100 as è¤‡å‹3ç€ã‚ªãƒƒã‚º
        ,nullif(cast(nullif(trim(hr.haraimodoshi_fukusho_3c), '') as integer), 0) as è¤‡å‹3ç€äººæ°—
        ,cast(substring(trim(hr.haraimodoshi_umaren_1a), 1, 2) as integer) as é¦¬é€£é¦¬ç•ª1
        ,cast(substring(trim(hr.haraimodoshi_umaren_1a), 3, 2) as integer) as é¦¬é€£é¦¬ç•ª2
        ,nullif(cast(nullif(trim(hr.haraimodoshi_umaren_1b), '') as float), 0) / 100 as é¦¬é€£ã‚ªãƒƒã‚º
        ,cast(substring(trim(hr.haraimodoshi_wide_1a), 1, 2) as integer) as ãƒ¯ã‚¤ãƒ‰1_2é¦¬ç•ª1
        ,cast(substring(trim(hr.haraimodoshi_wide_1a), 3, 2) as integer) as ãƒ¯ã‚¤ãƒ‰1_2é¦¬ç•ª2
        ,cast(substring(trim(hr.haraimodoshi_wide_2a), 1, 2) as integer) as ãƒ¯ã‚¤ãƒ‰2_3ç€é¦¬ç•ª1
        ,cast(substring(trim(hr.haraimodoshi_wide_2a), 3, 2) as integer) as ãƒ¯ã‚¤ãƒ‰2_3ç€é¦¬ç•ª2
        ,cast(substring(trim(hr.haraimodoshi_wide_3a), 1, 2) as integer) as ãƒ¯ã‚¤ãƒ‰1_3ç€é¦¬ç•ª1
        ,cast(substring(trim(hr.haraimodoshi_wide_3a), 3, 2) as integer) as ãƒ¯ã‚¤ãƒ‰1_3ç€é¦¬ç•ª2
        ,nullif(cast(nullif(trim(hr.haraimodoshi_wide_1b), '') as float), 0) / 100 as ãƒ¯ã‚¤ãƒ‰1_2ã‚ªãƒƒã‚º
        ,nullif(cast(nullif(trim(hr.haraimodoshi_wide_2b), '') as float), 0) / 100 as ãƒ¯ã‚¤ãƒ‰2_3ã‚ªãƒƒã‚º
        ,nullif(cast(nullif(trim(hr.haraimodoshi_wide_3b), '') as float), 0) / 100 as ãƒ¯ã‚¤ãƒ‰1_3ã‚ªãƒƒã‚º
        ,cast(substring(trim(hr.haraimodoshi_umatan_1a), 1, 2) as integer) as é¦¬å˜é¦¬ç•ª1
        ,cast(substring(trim(hr.haraimodoshi_umatan_1a), 3, 2) as integer) as é¦¬å˜é¦¬ç•ª2
        ,nullif(cast(nullif(trim(hr.haraimodoshi_umatan_1b), '') as float), 0) / 100 as é¦¬å˜ã‚ªãƒƒã‚º
        ,nullif(cast(nullif(trim(hr.haraimodoshi_sanrenpuku_1b), '') as float), 0) / 100 as ï¼“é€£è¤‡ã‚ªãƒƒã‚º
    from
        jvd_ra ra 
        inner join ( 
            select
                se.kaisai_nen
                , se.kaisai_tsukihi
                , se.keibajo_code
                , se.race_bango
                , se.kakutei_chakujun
                , se.ketto_toroku_bango
                , se.bamei
                , se.wakuban
                , se.umaban
                , se.barei
                , se.seibetsu_code
                , se.kishu_code
                , se.chokyoshi_code
                , trim(se.kishumei_ryakusho) as kishu_name
                , trim(se.chokyoshimei_ryakusho) as chokyoshi_name
                , se.futan_juryo
                , se.tansho_odds
                , se.tansho_ninkijun
                , se.kohan_3f
                , se.soha_time
                , se.time_sa
                , se.corner_1
                , se.corner_2
                , se.corner_3
                , se.corner_4
                , se.kyakushitsu_hantei
            from
                jvd_se se
            where 
                se.kohan_3f <> '000' 
                and se.kohan_3f <> '999'
        ) seum 
            on ra.kaisai_nen = seum.kaisai_nen 
            and ra.kaisai_tsukihi = seum.kaisai_tsukihi 
            and ra.keibajo_code = seum.keibajo_code 
            and ra.race_bango = seum.race_bango 
        inner join jvd_hr hr
            on ra.kaisai_nen = hr.kaisai_nen 
            and ra.kaisai_tsukihi = hr.kaisai_tsukihi 
            and ra.keibajo_code = hr.keibajo_code 
            and ra.race_bango = hr.race_bango
    where
        cast(ra.kaisai_nen as integer) between 2021 and 2024    --å­¦ç¿’ãƒ‡ãƒ¼ã‚¿å¹´ç¯„å›²
    ) rase 
    where 
    rase.keibajo_code = '10' and cast(rase.kyoso_shubetsu_code as integer) = 12 and cast(rase.track_code as integer) between 23 and 29 and cast(rase.kyori as integer) between 1000 and 1600
    ) inner_query
    LEFT JOIN track_upset_rates tur ON inner_query.keibajo_code = tur.keibajo_code
    ) base_features
    
    WHERE CAST(base_features.kaisai_nen AS INTEGER) BETWEEN 2024 AND 2024
    
