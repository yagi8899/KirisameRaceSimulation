# 穴馬予測モデル 目標設定ドキュメント

**作成日**: 2026年1月19日  
**最終更新**: 2026年1月19日

---

## 📋 目的

競馬予測モデルにおいて、**10番人気以下の馬（穴馬）が3着以内に入ることを高精度で予測する**ことを目指す。
従来のランキング学習（相対順位予測）に加えて、**穴馬検出**に特化した予測能力を強化し、高配当獲得の可能性を高める。

---

## 📊 現状分析（過去10年データ：2016-2026年）

### ベースライン（ランダム選択時の期待値）

| 人気帯 | 3着以内率 | 出走回数 | 1着率 |
|--------|----------|---------|--------|
| 1番人気 | 70.26% | 56,008 | 39.14% |
| 2-3番人気 | 50.09% | 111,999 | 16.24% |
| 4-5番人気 | 30.45% | 111,942 | 7.39% |
| 6-9番人気（中穴） | 14.16% | 214,650 | 2.91% |
| **10番人気以下（大穴）** | **4.35%** | **200,126** | **0.81%** |

### 重要な発見

1. **年度別の安定性**
   - 10番人気以下の3着以内率は**4.1〜4.7%**で推移（予測可能性あり）
   - 2016年: 4.40% → 2025年: 4.30%（安定）

2. **競馬場別の差異**
   - 最高: **函館 6.10%**（穴が出やすい）
   - 次点: 小倉 5.32%、札幌 5.25%
   - 最低: 東京 3.98%、中山 4.07%（堅い傾向）
   - **函館は東京の1.5倍**穴が出る

3. **路面×距離別の傾向**
   - 芝右短距離: **5.41%**（高め）
   - ダート左長距離: 9.52%（サンプル少ない）
   - ダート右短距離: 3.94%（低め）

---

## 🎯 穴馬の定義

本プロジェクトにおける「穴馬」の定義：

| 分類 | 人気帯 | ベースライン3着以内率 | 対象 |
|------|--------|---------------------|------|
| **大穴（メイン目標）** | **10番人気以下** | **4.35%** | ✅ 主目標 |
| 中穴（サブ目標） | 6-9番人気 | 14.16% | 補助目標 |
| 超大穴（参考） | 13番人気以下 | 約2.5% | 高リスク |

**採用理由**:
- 10番人気以下は母数が十分（年間約2万頭）
- 複勝平均配当が3.5〜5.0倍程度（高配当期待）
- 年度・条件による変動が比較的安定

---

## 📈 評価指標（KPI）

### 主要指標: Precision（適合率）

> モデルが「3着以内に来る」と予測した穴馬のうち、実際に的中した割合

$$
\text{Precision} = \frac{\text{予測的中数}}{\text{予測総数}} \times 100
$$

**例**: 100頭の穴馬を「3着以内」と予測し、10頭が実際に3着以内に入った場合 → **Precision 10%**

### 副次指標: Recall（再現率）

> 実際に3着以内に来た穴馬のうち、モデルが事前に予測できた割合

$$
\text{Recall} = \frac{\text{予測的中数}}{\text{実際の3着以内穴馬数}} \times 100
$$

### 補助指標: F1スコア

$$
\text{F1 Score} = 2 \times \frac{\text{Precision} \times \text{Recall}}{\text{Precision} + \text{Recall}}
$$

### 実運用指標: ROI（回収率）

複勝馬券での期待回収率（参考値）：

| Precision | 平均配当3.5倍 | 平均配当4.5倍 | 備考 |
|-----------|--------------|--------------|------|
| 4.35%（ベースライン） | 15.2% | 19.6% | 大赤字 |
| 8% | 28% | 36% | 赤字（改善） |
| 10% | 35% | 45% | 赤字（大幅改善） |
| 15% | 52.5% | 67.5% | 赤字（限界） |
| 29% | **100%** | - | 損益分岐点（非現実的） |

**注意**: 複勝のみでROI 100%超えは非常に困難。単勝・馬連・3連複との組み合わせ戦略が必要。

---

## 🎯 目標値設定

### Phase 1: 基礎モデル（3ヶ月目標）

| 指標 | 目標値 | ベースライン比 | 優先度 |
|------|--------|---------------|--------|
| **Precision** | **8.0%以上** | 1.8倍 | 🔥 最重要 |
| Recall | 30%以上 | - | ⭐ 重要 |
| F1 Score | 12%以上 | - | 参考 |
| 予測件数 | 年間1,000件以上 | - | 実用性確保 |

**達成基準**:
- テストデータ（2024-2025年）でPrecision 8%を安定して達成
- 全競馬場で4%以上（ベースライン未満にならない）

---

### Phase 2: 実用モデル（6ヶ月目標）

| 指標 | 目標値 | ベースライン比 | 優先度 |
|------|--------|---------------|--------|
| **Precision** | **10.0%以上** | 2.3倍 | 🔥 最重要 |
| Recall | 25%以上 | - | ⭐ 重要 |
| F1 Score | 16%以上 | - | 参考 |
| Top10%予測のPrecision | 15%以上 | 3.5倍 | 高精度層 |

**達成基準**:
- 全体でPrecision 10%達成
- 穴が出やすい条件（函館、小倉、芝右短距離）で12%以上

---

### Phase 3: 高精度モデル（1年目標）

| 指標 | 目標値 | ベースライン比 | 優先度 |
|------|--------|---------------|--------|
| **Precision** | **12.0%以上** | 2.8倍 | 🔥 最重要 |
| Recall | 20%以上 | - | バランス |
| Top10%予測のPrecision | **18%以上** | 4.1倍 | 超高精度層 |
| Top5%予測のPrecision | **25%以上** | 5.7倍 | 厳選予測 |

**達成基準**:
- 競馬場×路面×距離の組み合わせで個別最適化
- 信頼度スコアによる階層化（Top5%, Top10%, Top25%）
- 単勝・馬連・3連複戦略と組み合わせてROI 80%以上

---

## 🏇 条件別目標（Phase 2以降）

### 競馬場別目標

| 競馬場 | ベースライン | Phase 2目標 | Phase 3目標 | 戦略 |
|--------|------------|------------|------------|------|
| 函館 | 6.10% | 12% | 15% | 積極的予測 |
| 小倉 | 5.32% | 11% | 14% | 積極的予測 |
| 札幌 | 5.25% | 11% | 14% | 積極的予測 |
| 新潟 | 4.88% | 10% | 12% | 標準 |
| 京都 | 4.56% | 9% | 11% | 標準 |
| 阪神 | 4.31% | 9% | 11% | 標準 |
| 中京 | 4.25% | 9% | 11% | 標準 |
| 中山 | 4.07% | 8% | 10% | 慎重 |
| 東京 | 3.98% | 8% | 10% | 慎重 |

### 路面×距離別目標

| 路面種別 | 距離区分 | ベースライン | Phase 2目標 | 備考 |
|---------|---------|------------|------------|------|
| 芝右 | 短距離 | 5.41% | 11% | 穴が出やすい |
| 芝左 | 長距離 | 5.61% | 11% | サンプル少 |
| ダート右 | マイル | 4.46% | 9% | 標準 |
| ダート左 | マイル | 4.45% | 9% | 標準 |
| 芝左 | マイル | 3.75% | 8% | 堅い |
| ダート右 | 短距離 | 3.94% | 8% | 堅い |

---

## 🔧 実現戦略

### 1. モデルアーキテクチャ

**既存の強み**:
- ✅ `relative_ability`（SHAP値1位）でレース内格差を捉える
- ✅ `right_direction_score`（京都で2位）でトラック適性を捉える
- ✅ LambdaRank（ランキング学習）で順位予測が強力

**穴馬予測強化策**:
1. **二段階モデル構成**
   - 第1段階: 既存ランキングモデル（全体順位予測）
   - 第2段階: 穴馬検出モデル（10番人気以下に特化）

2. **穴馬特化特徴量の追加**
   - 人気と実力の乖離度（`relative_ability` vs `tansho_ninkijun`）
   - 前走格上レース経験（クラス降級馬の検出）
   - 休養明け×実力馬（kyuyo_kikan × relative_ability）
   - 競馬場適性×人気薄（keibajo × ninki）

3. **閾値最適化**
   - 信頼度スコアによる階層化（Top5%, Top10%, Top25%）
   - 競馬場別の動的閾値調整

### 2. データ戦略

- **訓練データ**: 2016-2022年（約14万レース）
- **検証データ**: 2023年（約2万レース）
- **テストデータ**: 2024-2025年（約3.5万レース）

**重点サンプリング**:
- 穴馬の3着以内ケースを重点的に学習（SMOTE等）
- 競馬場×条件別に層別サンプリング

### 3. 評価プロセス

1. **週次評価**: 2024-2025年データでPrecision/Recallをモニタリング
2. **月次評価**: 条件別の精度を確認し、弱点を特定
3. **四半期評価**: Phase目標達成度を確認し、戦略を調整

---

## 📅 ロードマップ

### Month 1-3: Phase 1（基礎モデル構築）

- [ ] 穴馬検出用特徴量の実装（人気乖離度、クラス降級など）
- [ ] 二段階モデルの設計と実装
- [ ] 2024-2025年データでPrecision 8%達成
- [ ] 競馬場別のベースライン精度確認

**成功基準**: Precision 8.0%以上、Recall 30%以上

---

### Month 4-6: Phase 2（実用モデル最適化）

- [ ] 信頼度スコアの導入（Top10%で15%達成）
- [ ] 競馬場×条件別の個別モデル調整
- [ ] 函館・小倉でPrecision 12%達成
- [ ] 馬券戦略シミュレーション（複勝・馬連）

**成功基準**: Precision 10.0%以上、条件別12%以上

---

### Month 7-12: Phase 3（高精度化とROI最適化）

- [ ] Top5%予測でPrecision 25%達成
- [ ] 単勝・3連複との組み合わせ戦略
- [ ] Walk Forward Validationでの安定性確認
- [ ] リアルタイム予測システムの構築

**成功基準**: Precision 12.0%以上、Top5%で25%、ROI 80%以上

---

## 📊 進捗管理

### 現在の状況（2026年1月19日）

- [x] 過去10年データの分析完了
- [x] ベースライン（4.35%）の確認
- [x] 目標設定完了
- [ ] Phase 1開始準備中

### 次のアクション

1. **穴馬検出用特徴量の設計**
   - 人気と実力の乖離度スコア
   - クラス降級フラグ
   - 競馬場適性×人気薄スコア

2. **二段階モデルの実装**
   - 既存ランキングモデルの予測スコアを特徴量として利用
   - 10番人気以下専用の二値分類器（3着以内 or not）

3. **評価スクリプトの作成**
   - Precision/Recall/F1の自動計算
   - 競馬場別・条件別の精度レポート
   - 予測信頼度の分布分析

---

## 📝 注意事項

### モデルの限界

- **複勝だけでは利益確保困難**: ROI 100%超えには非現実的な精度（Precision 29%）が必要
- **サンプル不足の条件**: 芝左長距離など母数が少ない条件では精度が不安定
- **オッズ変動**: 予測公開によるオッズ下落リスク（実運用時の課題）

### リスク管理

- **過学習の防止**: Walk Forward Validationで未来データへの汎化性能を確認
- **ドリフト監視**: 年度による傾向変化（ルール改正、馬場改修）を継続監視
- **条件別評価**: 全体精度だけでなく、条件別の偏りを常にチェック

---

## 🔗 関連ドキュメント

- [特徴量一覧](FEATURE_LIST.md) - 既存特徴量の詳細
- [SHAP分析結果](shap_analysis_report.md) - 特徴量重要度の分析
- [モデル設定](model_configs.json) - 現在のモデル構成
- [ワークフローガイド](MODEL_WORKFLOW_GUIDE.md) - モデル作成の手順

---

**最終更新者**: GitHub Copilot AI Assistant  
**承認日**: 2026年1月19日
