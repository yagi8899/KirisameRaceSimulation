# 穴馬予測モデル 目標設定ドキュメント

**作成日**: 2026年1月19日  
**最終更新**: 2026年1月19日  
**精査・改訂**: 2026年1月19日（理論的妥当性検証済み）

---

## 📋 目的

競馬予測モデルにおいて、**10番人気以下の馬（穴馬）が3着以内に入ることを高精度で予測する**ことを目指す。
従来のランキング学習（相対順位予測）に加えて、**穴馬検出**に特化した予測能力を強化し、高配当獲得の可能性を高める。

---

## ⚠️ ランキング学習と穴馬予測の関係性（重要）

### なぜ通常のランキング学習では穴馬が出にくいのか

本プロジェクトはLightGBMの**LambdaRank（ランキング学習）**を使用しており、これは本質的に：

> **「上位に来る確率が高い馬」を正しく並べる**

評価指標もNDCG / MAP / Hit@k など、**「人気馬を安定して当てる」方向に最適化される**。

つまり：
- **穴馬** = 勝率は低いが、オッズが高い
- **ランキング学習** = 勝率（または着順期待値）重視

👉 **この2つは目的がズレている**

そのため「的中率はそこそこ、回収率が伸びない」という症状はほぼ必然。

### それでも「可能」と言える理由

重要なのは：

> ランキング学習 = 着順を学習するもの、**ではない**  
> **「任意のスコア順序」を学習できる枠組み**

という点。

つまり、
- 「期待回収率が高い順」
- 「オッズに対して過小評価されている順」

こうした**歪んだ順位**を正解として与えれば、ランキング学習でも穴馬志向にできる。

**ただし、本プロジェクトでは以下の理由から段階的アプローチを採用**：
1. **現状の設計**：着順スコア（18 - 着順 + 1）をラベルとして使用
2. **オッズの扱い**：速報予測対応のため、意図的にオッズを特徴量から除外
3. **実装戦略**：オッズを使わずに実力を予測 → オッズとの乖離を後処理で計算

---

## 📊 現状分析（過去10年データ：2016-2026年）

### ベースライン（ランダム選択時の期待値）

| 人気帯 | 3着以内率 | 出走回数 | 1着率 |
|--------|----------|---------|--------|
| 1番人気 | 70.26% | 56,008 | 39.14% |
| 2-3番人気 | 50.09% | 111,999 | 16.24% |
| 4-5番人気 | 30.45% | 111,942 | 7.39% |
| 6-9番人気（中穴） | 14.16% | 214,650 | 2.91% |
| **10番人気以下（大穴）** | **4.35%** | **200,126** | **0.81%** |

### 重要な発見

1. **年度別の安定性**
   - 10番人気以下の3着以内率は**4.1〜4.7%**で推移（予測可能性あり）
   - 2016年: 4.40% → 2025年: 4.30%（安定）

2. **競馬場別の差異**
   - 最高: **函館 6.10%**（穴が出やすい）
   - 次点: 小倉 5.32%、札幌 5.25%
   - 最低: 東京 3.98%、中山 4.07%（堅い傾向）
   - **函館は東京の1.5倍**穴が出る

3. **路面×距離別の傾向**
   - 芝右短距離: **5.41%**（高め）
   - ダート左長距離: 9.52%（サンプル少ない）
   - ダート右短距離: 3.94%（低め）

---

## 🎯 穴馬の定義

本プロジェクトにおける「穴馬」の定義：

| 分類 | 人気帯 | ベースライン3着以内率 | 対象 |
|------|--------|---------------------|------|
| **大穴（メイン目標）** | **10番人気以下** | **4.35%** | ✅ 主目標 |
| 中穴（サブ目標） | 6-9番人気 | 14.16% | 補助目標 |
| 超大穴（参考） | 13番人気以下 | 約2.5% | 高リスク |

**採用理由**:
- 10番人気以下は母数が十分（年間約2万頭）
- 複勝平均配当が3.5〜5.0倍程度（高配当期待）
- 年度・条件による変動が比較的安定

---

## 📈 評価指標（KPI）

### 主要指標: Precision（適合率）

> モデルが「3着以内に来る」と予測した穴馬のうち、実際に的中した割合

$$
\text{Precision} = \frac{\text{予測的中数}}{\text{予測総数}} \times 100
$$

**例**: 100頭の穴馬を「3着以内」と予測し、10頭が実際に3着以内に入った場合 → **Precision 10%**

### 副次指標: Recall（再現率）

> 実際に3着以内に来た穴馬のうち、モデルが事前に予測できた割合

$$
\text{Recall} = \frac{\text{予測的中数}}{\text{実際の3着以内穴馬数}} \times 100
$$

### 補助指標: F1スコア

$$
\text{F1 Score} = 2 \times \frac{\text{Precision} \times \text{Recall}}{\text{Precision} + \text{Recall}}
$$

### 実運用指標: ROI（回収率）

複勝馬券での期待回収率（参考値）：

| Precision | 平均配当3.5倍 | 平均配当4.5倍 | 備考 |
|-----------|--------------|--------------|------|
| 4.35%（ベースライン） | 15.2% | 19.6% | 大赤字 |
| 8% | 28% | 36% | 赤字（改善） |
| 10% | 35% | 45% | 赤字（大幅改善） |
| 15% | 52.5% | 67.5% | 赤字（限界） |
| 29% | **100%** | - | 損益分岐点（非現実的） |

**注意**: 複勝のみでROI 100%超えは非常に困難。単勝・馬連・3連複との組み合わせ戦略が必要。

---

## 🎯 目標値設定

### Phase 1: 基礎モデル（3ヶ月目標）

| 指標 | 目標値 | ベースライン比 | 優先度 |
|------|--------|---------------|--------|
| **Precision** | **8.0%以上** | 1.8倍 | 🔥 最重要 |
| Recall | 30%以上 | - | ⭐ 重要 |
| F1 Score | 12%以上 | - | 参考 |
| 予測件数 | 年間1,000件以上 | - | 実用性確保 |

**達成基準**:
- テストデータ（2024-2025年）でPrecision 8%を安定して達成
- 全競馬場で4%以上（ベースライン未満にならない）

---

### Phase 2: 実用モデル（6ヶ月目標）

| 指標 | 目標値 | ベースライン比 | 優先度 |
|------|--------|---------------|--------|
| **Precision** | **10.0%以上** | 2.3倍 | 🔥 最重要 |
| Recall | 25%以上 | - | ⭐ 重要 |
| F1 Score | 16%以上 | - | 参考 |
| Top10%予測のPrecision | 15%以上 | 3.5倍 | 高精度層 |

**達成基準**:
- 全体でPrecision 10%達成
- 穴が出やすい条件（函館、小倉、芝右短距離）で12%以上

---

### Phase 3: 高精度モデル（1年目標）

| 指標 | 目標値 | ベースライン比 | 優先度 |
|------|--------|---------------|--------|
| **Precision** | **12.0%以上** | 2.8倍 | 🔥 最重要 |
| Recall | 20%以上 | - | バランス |
| Top10%予測のPrecision | **18%以上** | 4.1倍 | 超高精度層 |
| Top5%予測のPrecision | **25%以上** | 5.7倍 | 厳選予測 |

**達成基準**:
- 競馬場×路面×距離の組み合わせで個別最適化
- 信頼度スコアによる階層化（Top5%, Top10%, Top25%）
- 単勝・馬連・3連複戦略と組み合わせてROI 80%以上

---

## 🏇 条件別目標（Phase 2以降）

### 競馬場別目標

| 競馬場 | ベースライン | Phase 2目標 | Phase 3目標 | 戦略 |
|--------|------------|------------|------------|------|
| 函館 | 6.10% | 12% | 15% | 積極的予測 |
| 小倉 | 5.32% | 11% | 14% | 積極的予測 |
| 札幌 | 5.25% | 11% | 14% | 積極的予測 |
| 新潟 | 4.88% | 10% | 12% | 標準 |
| 京都 | 4.56% | 9% | 11% | 標準 |
| 阪神 | 4.31% | 9% | 11% | 標準 |
| 中京 | 4.25% | 9% | 11% | 標準 |
| 中山 | 4.07% | 8% | 10% | 慎重 |
| 東京 | 3.98% | 8% | 10% | 慎重 |

### 路面×距離別目標

| 路面種別 | 距離区分 | ベースライン | Phase 2目標 | 備考 |
|---------|---------|------------|------------|------|
| 芝右 | 短距離 | 5.41% | 11% | 穴が出やすい |
| 芝左 | 長距離 | 5.61% | 11% | サンプル少 |
| ダート右 | マイル | 4.46% | 9% | 標準 |
| ダート左 | マイル | 4.45% | 9% | 標準 |
| 芝左 | マイル | 3.75% | 8% | 堅い |
| ダート右 | 短距離 | 3.94% | 8% | 堅い |

---

## 🔧 実現戦略

### 現状のモデル設計（検証済み）

**使用中の設定**:
- ✅ **モデル**: LightGBM Ranker（LambdaRank）
- ✅ **ラベル**: 反転着順スコア（18 - 着順 + 1）
- ✅ **評価指標**: NDCG@5（学習時）、的中率・回収率（テスト時）
- ✅ **オッズ**: 特徴量として使用していない（速報予測対応のため）
- ❌ **人気帯別分割**: なし（全人気帯を同一モデルで学習）

**既存の強み**:
- ✅ `relative_ability`（SHAP値1位）でレース内格差を捉える
- ✅ `right_direction_score`（京都で2位）でトラック適性を捉える
- ✅ LambdaRank（ランキング学習）で順位予測が強力
- ✅ オッズを使わない設計で速報予測に対応可能

**現状の課題**:
- ❌ 目的関数がLambdaRank → 上位予測に最適化、穴馬検出には不向き
- ❌ 人気帯別モデル分割なし → 穴馬サンプルが希薄化
- ❌ Precision/Recallの未評価 → 穴馬予測の適合率を監視できていない
- ❌ 学習時の重み付けなし → 穴馬的中を重視した学習ができていない

---

### 穴馬予測強化策（理論的に妥当なアプローチ）

#### 戦略1: オッズを使わない実力予測 + 後処理での乖離検出

**方針**:
```
学習時：オッズなしで予測スコアを出す（現状維持）
　　　　↓
推論時：予測順位と人気順位の乖離を計算
　　　　↓
穴馬候補：乖離が大きい馬を抽出
```

**実装例**:
```python
# 学習時：オッズなしで予測スコアを出す
predicted_score = model.predict(X)
predicted_rank = rankdata(-predicted_score, method='ordinal')

# 推論時：オッズとの乖離を計算
popularity_rank = df['tansho_ninkijun_numeric'].values
value_gap = predicted_rank - popularity_rank  # 負の値 = 過小評価

# 過小評価馬を抽出（予測順位 << 人気順位）
df['is_value_bet'] = (value_gap < -3) & (predicted_rank <= 3)
```

**メリット**:
- ✅ 速報予測に対応可能（オッズ未確定でも予測できる）
- ✅ オッズの逆順を学習する問題を回避
- ✅ 市場の歪み（人気と実力の乖離）を直接利用

---

#### 戦略2: 二段階モデル構成

**方針**:
```
第1段階：既存ランキングモデル（全体順位予測）
　　　　　↓
第2段階：穴馬検出モデル（10番人気以下に特化した二値分類）
```

**第2段階モデルの設計**:
- **目的変数**: 3着以内=1、4着以下=0（二値分類）
- **入力特徴量**: 第1段階の予測スコア + 穴馬特化特徴量
- **学習対象**: 10番人気以下の馬のみ
- **モデル**: LightGBM Classifier（binary classification）

**実装例**:
```python
# 第1段階：ランキング予測
ranking_score = ranker_model.predict(X)

# 第2段階用のデータ準備（10番人気以下のみ）
upset_candidates = df[df['tansho_ninkijun_numeric'] >= 10].copy()
upset_candidates['ranking_score'] = ranking_score

# 第2段階：穴馬検出（二値分類）
X_upset = upset_candidates[feature_columns + ['ranking_score']]
y_upset = (upset_candidates['kakutei_chakujun_numeric'] <= 3).astype(int)
classifier_model.fit(X_upset, y_upset)
```

**メリット**:
- ✅ 人気馬と穴馬を別の土俵で評価（サンプル不均衡を回避）
- ✅ 穴馬専用の特徴量を追加可能
- ✅ Precision/Recallで評価しやすい

---

#### 戦略3: ラベル設計の変更（オプション・Phase 2以降）

**問題点**:
現状のラベル（反転着順スコア）は「順位を当てる」に最適化されており、「回収を最大化する」には不向き。

**改善案**:
```python
# オプション1: 対数変換付きオッズ重み
label = log(min(odds, 30)) * win_flag

# オプション2: 回収期待値
label = odds * win_flag / theoretical_win_rate

# オプション3: クラス別重み付け
sample_weight = np.where(popularity_rank >= 10, 3.0, 1.0)
```

**注意点**:
- ⚠️ ラベルの分散が極端に大きくなり学習が不安定になるリスク
- ⚠️ 対数変換やキャップで安定化が必要
- ⚠️ 速報予測への影響を検証する必要あり

**実装タイミング**: Phase 2以降、基礎モデルが安定してから

---

#### 戦略4: 人気帯別モデル分割

**方針**:
```
モデルA：1-5番人気専用（堅実予測）
モデルB：6-9番人気専用（中穴予測）
モデルC：10番人気以下専用（大穴予測）
```

**課題と対策**:
| 課題 | 対策 |
|------|------|
| 10番人気以下の3着以内率は約8-10%（正例が少ない） | SMOTEなどのオーバーサンプリング |
| 過学習しやすい | 早期終了、正則化強化 |
| サンプル数不足 | 複数年のデータをプール |

**実装タイミング**: Phase 2以降、データ不均衡対策とセットで実装

---

#### 戦略5: 二段階評価（学習時NDCG + 選択時回収率）

**方針**:
```
学習時の目的関数：NDCG（微分可能である必要）
　　　　↓
早期終了の判定：仮想ベット回収率シミュレーション
　　　　↓
モデル選択：回収率で最良モデルを選択
```

**実装例**:
```python
# カスタムコールバック：回収率で早期終了
def回収率_callback(env):
    predictions = model.predict(X_valid)
    roi = calculate_roi(predictions, y_valid, odds_valid)
    if roi > best_roi:
        best_roi = roi
        best_iteration = env.iteration
    return env.iteration - best_iteration > 50  # 50回改善なければ停止

model.fit(X_train, y_train, callbacks=[回収率_callback])
```

**メリット**:
- ✅ 学習は従来通りNDCG最適化
- ✅ モデル選択は回収率で判断
- ✅ 過学習を防ぎつつ実運用性能を確保

---

### 穴馬特化特徴量の追加

1. **人気と実力の乖離度**
   - `relative_ability` vs `tansho_ninkijun_numeric`の差分
   - レース内での相対的な評価ギャップ

2. **クラス降級フラグ**
   - `class_score_change`が負（クラスダウン）
   - 降級馬は穴馬候補の代表例

3. **休養明け×実力馬**
   - `kyuyo_kikan` × `relative_ability`の相互作用
   - 実力馬の休養明けは狙い目

4. **競馬場適性×人気薄**
   - `right_direction_score` × 人気度
   - 適性が高いのに人気がない馬

5. **成績の不安定性（NEW）**
   - `past_score_std`（標準偏差）
   - ムラっ気のある馬 = 当たればデカい

**詳細は [UPSET_PREDICTION_FEATURES.md](UPSET_PREDICTION_FEATURES.md) を参照**

---

### 閾値最適化

- **信頼度スコアによる階層化**（Top5%, Top10%, Top25%）
- **競馬場別の動的閾値調整**（函館は緩く、東京は厳しく）
- **条件別の最適化**（芝右短距離、ダート左長距離など）

---

## 📊 データ戦略

- **訓練データ**: 2016-2022年（約14万レース）
- **検証データ**: 2023年（約2万レース）
- **テストデータ**: 2024-2025年（約3.5万レース）

**重点サンプリング**:
- 穴馬の3着以内ケースを重点的に学習（SMOTE等）
- 競馬場×条件別に層別サンプリング

---

## 🔍 評価プロセス

1. **週次評価**: 2024-2025年データでPrecision/Recallをモニタリング
2. **月次評価**: 条件別の精度を確認し、弱点を特定
3. **四半期評価**: Phase目標達成度を確認し、戦略を調整

---

## 📅 ロードマップ

### Month 1-3: Phase 1（基礎モデル構築） ✅ **完了**

- [x] 穴馬検出用特徴量の実装（人気乖離度、クラス降級など）
- [x] 二段階モデルの設計と実装
- [x] 2024-2025年データでPrecision 6.83%達成
- [x] 競馬場別のベースライン精度確認
- [x] Walk-Forward Validation統合完了

**成果**: Precision 6.83%, Recall 80.39%, F1 12.62%（目標8%は未達）

---

### Month 1-3: Phase 1.5（SQL特徴量拡張） 🔧 **実装中**

**2026年1月20日開始**

- [ ] SQL穴馬特化特徴量の実装（フェーズ1・6特徴量）
  - [ ] `past_score_std` - 成績ムラで穴馬検出
  - [ ] `past_chakujun_variance` - 着順ムラで穴馬検出
  - [ ] `zenso_oikomi_power` - 追い込み力で展開依存検出
  - [ ] `kishu_changed` - 騎手変更で厩舎本気度検出
  - [ ] `class_downgrade` - クラス降級で実力差検出
  - [ ] `zenso_kakoi_komon` - 前走包まれで不利検出
- [ ] db_query_builder.py更新（訓練・速報両方）
- [ ] feature_engineering.py更新
- [ ] 穴馬分類器の再訓練
- [ ] Walk-Forward再実行・Precision再評価
- [ ] **Precision 8.0%以上達成**

**目標**: Precision 7.5-8.5%、Recall 70-80%

---

### Month 4-6: Phase 2（実用モデル最適化）

- [ ] SQL特徴量フェーズ2（必要に応じて4特徴量追加）
  - [ ] `zenso_agari_rank` - 前走上がり最速検出
  - [ ] `zenso_agari_gap` - 上がり良いのに負けた馬検出
  - [ ] `avg_oikomi_power` - 平均追い込み力
  - [ ] `kyuyo_after_bad_race` - 休養明けの立て直し
- [ ] 信頼度スコアの導入（Top10%で15%達成）
- [ ] 競馬場×条件別の個別モデル調整
- [ ] 函館・小倉でPrecision 12%達成
- [ ] 馬券戦略シミュレーション（複勝・馬連）

**成功基準**: Precision 10.0%以上、条件別12%以上

---

### Month 7-12: Phase 3（高精度化とROI最適化）

- [ ] SQL特徴量フェーズ3（効果検証後に判断）
  - [ ] 条件別複雑集計（turf_vs_dirt_gap等）
  - [ ] 厩舎・騎手統計（chokyoshi_upset_rate等）
- [ ] Top5%予測でPrecision 25%達成
- [ ] 単勝・3連複との組み合わせ戦略
- [ ] Walk Forward Validationでの安定性確認
- [ ] リアルタイム予測システムの構築

**成功基準**: Precision 12.0%以上、Top5%で25%、ROI 80%以上

---

## 📊 進捗管理

### 現在の状況（2026年1月20日）

**Phase 1完了実績**:
- [x] 過去10年データの分析完了
- [x] ベースライン（4.35%）の確認
- [x] 目標設定完了
- [x] 二段階モデル（Universal Ranker + 穴馬分類器）実装完了
- [x] Walk-Forward Validation統合完了
- [x] Precision 6.83%, Recall 80.39%達成（目標8%未達）
- [x] 閾値最適化完了（threshold=0.0005が最適）

**Phase 1.5開始**（SQL特徴量拡張）:
- [x] UPSET系ドキュメント3種の確認完了
- [x] 未実装特徴量15個を特定
- [x] SQL実装方針決定（速報予測対応のため）
- [x] 優先順位再編成（3フェーズに分類）
- [ ] 実装開始

### 次のアクション（Week 1-2）

1. **SQL穴馬特化特徴量の実装**（フェーズ1・6特徴量）
   - `db_query_builder.py` の `build_race_data_query()` 関数にWINDOW関数・LAG追加
   - `build_sokuho_race_data_query()` にも同じロジック追加（速報予測対応）
   - past_score_std, past_chakujun_variance, zenso_oikomi_power, kishu_changed, class_downgrade, zenso_kakoi_komon

2. **feature_engineering.py更新**
   - `create_universal_features()` 関数に新特徴量の取り込みコード追加
   - fillna処理とデータ型検証

3. **再訓練・評価パイプライン**
   - `upset_classifier_creator.py` 再実行
   - `walk_forward_validation.py --config walk_forward_config_2026.json` 再実行
   - `calculate_precision_recall.py` でPrecision/Recall再計算
   - **目標: Precision 8.0%以上達成**

4. **フェーズ2判断**
   - Precision 8%達成 → Phase 2へ進む
   - Precision 8%未達 → フェーズ2特徴量（zenso_agari_rank等4個）を追加実装

---

## 📝 注意事項

### モデルの限界

- **複勝だけでは利益確保困難**: ROI 100%超えには非現実的な精度（Precision 29%）が必要
- **サンプル不足の条件**: 芝左長距離など母数が少ない条件では精度が不安定
- **オッズ変動**: 予測公開によるオッズ下落リスク（実運用時の課題）

### リスク管理

- **過学習の防止**: Walk Forward Validationで未来データへの汎化性能を確認
- **ドリフト監視**: 年度による傾向変化（ルール改正、馬場改修）を継続監視
- **条件別評価**: 全体精度だけでなく、条件別の偏りを常にチェック

---

## 🔗 関連ドキュメント

- [特徴量一覧](FEATURE_LIST.md) - 既存特徴量の詳細
- [SHAP分析結果](shap_analysis_report.md) - 特徴量重要度の分析
- [モデル設定](model_configs.json) - 現在のモデル構成
- [ワークフローガイド](MODEL_WORKFLOW_GUIDE.md) - モデル作成の手順

---

**最終更新者**: GitHub Copilot AI Assistant  
**承認日**: 2026年1月19日
