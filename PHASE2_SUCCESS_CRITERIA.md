# Phase 2 成功判断基準

## 📊 ベースライン数値(比較基準)

### ベースラインモデル(2016-2022学習、馬体重特徴量なし、特徴量数20個)

| 年度 | 中長距離的中率 | 中長距離回収率 | 短距離的中率 | 短距離回収率 | 中長距離レース数 | 短距離レース数 |
|------|----------------|----------------|--------------|--------------|------------------|----------------|
| 2023 | 20.00% | 39.85% | 23.53% | 90.98% | 65R | 51R |
| 2024 | 22.50% | 51.00% | 15.62% | 30.94% | 40R | 32R |
| 2025 | 28.07% | 109.65% | 11.63% | 117.44% | 57R | 43R |
| **3年平均** | **23.52%** | **66.83%** | **16.93%** | **79.79%** | **162R** | **126R** |

### 参考: Phase 2モデル(馬体重特徴量あり、特徴量数24個) - 失敗例

| 年度 | 中長距離的中率 | 中長距離回収率 | 短距離的中率 | 短距離回収率 |
|------|----------------|----------------|--------------|--------------|
| 2023 | 16.92% | 39.23% | 11.76% | 75.88% |
| 2024 | 25.00% | 90.00% | 15.62% | 98.75% |
| 2025 | 21.05% | 53.51% | 13.95% | 176.98% |
| **3年平均** | **20.37%** | **60.91%** | **13.49%** | **117.20%** |

**結果分析:**
- ❌ 中長距離的中率: -3.15pt (悪化)
- ❌ 短距離的中率: -3.44pt (悪化)
- ⚠️ 短距離回収率: +37.41pt (改善)
- **判定: 失敗** - 的中率が悪化したため過学習と判断

---

## ✅ 成功判断基準

### 🎯 最低ライン(Phase 2クリア条件)

**【必須条件】ベースラインモデルより改善していること**
```
✅ 中長距離的中率: 23.52% → 25.0%以上 (+1.48pt以上)
✅ 短距離的中率: 16.93% → 20.0%以上 (+3.07pt以上)
✅ 回収率が大きく下がっていない
   - 中長距離: 50%以上維持
   - 短距離: 60%以上維持
✅ 年度間バラつきが許容範囲
   - 最大値 - 最小値 ≤ 10pt
```

### 🌟 理想条件(Phase 2完全達成)

```
✅ 中長距離的中率: 25%以上
✅ 短距離的中率: 25%以上
✅ 回収率: 
   - 中長距離: 80%以上
   - 短距離: 100%以上
✅ 安定性:
   - 3年間すべて的中率20%以上
   - 年度間バラつき ≤ 8pt
✅ 特徴量重要度:
   - 新規追加特徴量が上位5位以内に入る
```

---

## 🔧 評価手順

### ステップ1: 新特徴量の実装

```bash
# 1. model_creator.py と universal_test.py を編集
#    - 馬体重特徴量は既にコメントアウト済み(ベースライン状態)
#    - 新しい特徴量を追加

# 2. SQLクエリも必要に応じて修正
#    - DBから新しいカラムを取得
#    - window関数で過去データを計算
```

### ステップ2: モデル学習

```bash
# 2016-2022データで学習
cd /d/src/Python/KirisameRaceSimulation2
python batch_model_creator.py custom 2016-2022 > model_training_NEW.log 2>&1 &

# 学習完了確認(40秒程度待つ)
tail -30 model_training_NEW.log | iconv -f SHIFT_JIS -t UTF-8

# 特徴量重要度を確認
grep -A 25 "特徴量の重要度" model_training_NEW.log | iconv -f SHIFT_JIS -t UTF-8
```

**チェックポイント:**
- ✅ 新特徴量が重要度上位10位以内に入っているか?
- ✅ エラーなく学習完了しているか?
- ✅ 学習時間が許容範囲(60秒以内)か?

### ステップ3: バックテスト実行

```bash
# model_configs.json を更新して新モデルを指定
# standard_models の model_filename を変更:
#   tokyo_turf_3ageup_long_XXXXX.sav
#   tokyo_turf_3ageup_short_XXXXX.sav

# 2023-2025年でバックテスト(並行実行)
python universal_test.py multi 2023 > test_2023_NEW.log 2>&1 &
python universal_test.py multi 2024 > test_2024_NEW.log 2>&1 &
python universal_test.py multi 2025 > test_2025_NEW.log 2>&1 &

# 完了確認(50秒程度待つ)
sleep 50
tail -15 test_2023_NEW.log | iconv -f SHIFT_JIS -t UTF-8
tail -15 test_2024_NEW.log | iconv -f SHIFT_JIS -t UTF-8
tail -15 test_2025_NEW.log | iconv -f SHIFT_JIS -t UTF-8
```

### ステップ4: 結果集計と判定

```bash
# 結果を集計
echo "年度,中長距離的中率,中長距離回収率,短距離的中率,短距離回収率" > results_summary.csv
# 各ログから数値を抽出して集計
```

**評価チェックリスト:**

#### ✅ 最低限クリア条件
```
□ 中長距離3年平均: 25.0%以上 (vs ベースライン23.52%)
□ 短距離3年平均: 20.0%以上 (vs ベースライン16.93%)
□ 中長距離回収率: 50%以上
□ 短距離回収率: 60%以上
□ 年度間バラつき: 10pt以内
```

#### 🌟 理想的な成功
```
□ 中長距離3年平均: 25%以上
□ 短距離3年平均: 25%以上
□ 中長距離回収率: 80%以上
□ 短距離回収率: 100%以上
□ 3年とも的中率20%以上(安定性)
□ 年度間バラつき: 8pt以内
□ 特徴量重要度: 上位5位以内に新特徴量
```

---

## 📝 判定例

### 例1: 成功(Phase 2クリア) ✅

```
【新特徴量】レース間隔関連(5個追加)
- 前走間隔、平均間隔、連闘フラグ、長期休養フラグ、間隔変化率

【結果】
中長距離: 2023=24%, 2024=26%, 2025=25% → 平均25.0% ✅
短距離: 2023=19%, 2024=21%, 2025=20% → 平均20.0% ✅
回収率: 中長距離70%, 短距離85% ✅
年度間バラつき: 中長距離2pt, 短距離2pt ✅

【特徴量重要度】
- 前走間隔: 15 (4位) ✅
- 連闘フラグ: 8 (7位) ✅

→ 判定: **成功! Phase 2クリア!** 🎉
→ 次アクション: Phase 1フィルター(past_score>60など)を再適用してPhase 3へ
```

### 例2: 微改善だが目標未達 ⚠️

```
【新特徴量】騎手適性関連(3個追加)
- 騎手×距離適性、騎手×馬場適性、騎手×枠適性

【結果】
中長距離: 2023=22%, 2024=24%, 2025=23% → 平均23.0% ❌
短距離: 2023=18%, 2024=19%, 2025=17% → 平均18.0% ❌

→ 判定: **NG** ベースライン(23.52%, 16.93%)より微改善だが目標未達
→ 次アクション: 別の特徴量を試すか、組み合わせを変える
```

### 例3: 過学習が疑われる ❌

```
【新特徴量】複雑な相互作用項(10個追加)

【結果】
中長距離: 2023=18%, 2024=30%, 2025=24% → 平均24.0% ⚠️
短距離: 2023=15%, 2024=25%, 2025=13% → 平均17.7% ⚠️
年度間バラつき: 中長距離12pt, 短距離12pt ❌

→ 判定: **NG** 不安定すぎる(過学習)
→ 次アクション: ハイパーパラメータ調整(正則化強化)または特徴量削減
```

---

## 🚫 NG判断(諦めて別アプローチを試すべき)

以下の条件に該当する場合は、その特徴量を諦めて別のアプローチを試す:

```
❌ ベースラインより悪化した場合
   → 馬体重特徴量のように、的中率が3pt以上下がった

❌ 3回試しても改善幅が+1pt未満
   → 効果が見込めない

❌ 学習時間が2倍以上かかる場合(120秒以上)
   → 実用性が低い

❌ 特徴量重要度が下位10位以下
   → モデルが使っていない

❌ 年度間バラつきが12pt以上
   → 不安定すぎて実運用できない
```

---

## 📊 結果記録フォーマット

各試行ごとに以下のフォーマットで記録することを推奨:

```markdown
## 試行N: [特徴量名]

### 基本情報
- 実装日: YYYY/MM/DD
- 追加特徴量: [特徴量リスト]
- 特徴量数: XX個 → YY個 (+Z個)
- 学習時間: XX秒

### 特徴量重要度(上位10位)
1. feature1: 重要度XX
2. feature2: 重要度XX
...
(新特徴量は太字で強調)

### バックテスト結果

#### 中長距離(1700m以上)
| 年度 | 的中率 | 回収率 | レース数 |
|------|--------|--------|----------|
| 2023 | XX.XX% | XX.XX% | XXR |
| 2024 | XX.XX% | XX.XX% | XXR |
| 2025 | XX.XX% | XX.XX% | XXR |
| **平均** | **XX.XX%** | **XX.XX%** | **XXXR** |

#### 短距離(1000-1600m)
| 年度 | 的中率 | 回収率 | レース数 |
|------|--------|--------|----------|
| 2023 | XX.XX% | XX.XX% | XXR |
| 2024 | XX.XX% | XX.XX% | XXR |
| 2025 | XX.XX% | XX.XX% | XXR |
| **平均** | **XX.XX%** | **XX.XX%** | **XXXR** |

### ベースラインとの比較
- 中長距離的中率: 23.52% → XX.XX% (**±X.XXpt**)
- 短距離的中率: 16.93% → XX.XX% (**±X.XXpt**)
- 年度間バラつき: 中長距離XXpt, 短距離XXpt

### 判定
- [ ] 最低ライン達成
- [ ] 理想条件達成
- 総合判定: **[成功✅ / 微改善⚠️ / 失敗❌]**

### 次のアクション
[次に何をするか記載]
```

---

## 🎯 Phase 2成功後のロードマップ

Phase 2の成功判断基準をクリアした場合:

### ステップ1: Phase 1フィルター再適用
```python
# universal_test.py で以下の条件を有効化:
- past_score > 60  # 過去スコアフィルター
- ninki_scaled <= 0.3  # 人気フィルター(1-3番人気)
```

### ステップ2: Phase 3バックテスト
```bash
# Phase 1フィルター適用後の2023-2025テスト
python universal_test.py multi 2023 > test_2023_phase3.log 2>&1 &
python universal_test.py multi 2024 > test_2024_phase3.log 2>&1 &
python universal_test.py multi 2025 > test_2025_phase3.log 2>&1 &
```

### ステップ3: Phase 3成功判断
```
目標: 回収率110%以上達成
- 中長距離回収率: 110%以上
- 短距離回収率: 110%以上
- 的中率: 15%以上維持(フィルター適用で下がる)
```

---

## 📚 参考情報

### 競馬予測で有効な特徴量候補(優先順位順)

1. **レース間隔パターン** (優先度: 高)
   - 前走からの日数
   - 過去5走の平均間隔
   - 連闘フラグ(14日以内)
   - 長期休養フラグ(180日以上)
   - 間隔変化率

2. **騎手×コース適性** (優先度: 中)
   - 騎手×距離カテゴリスコア
   - 騎手×競馬場スコア
   - 騎手×馬場状態スコア
   - 騎手×枠番スコア

3. **調教データ** (優先度: 中、DB確認必要)
   - 調教タイム偏差値
   - 調教評価点
   - 調教本数

4. **血統情報** (優先度: 低、実装難易度高)
   - 父馬×距離適性
   - 母父馬×馬場適性

5. **EWMスパン最適化** (優先度: 低)
   - 現状span=5 → 最適値探索

### データベース確認コマンド
```sql
-- 利用可能なカラム確認
\d jvd_se  -- レースデータ
\d jvd_uma -- 馬データ
\d jvd_kishu -- 騎手データ
```

---

**最終更新: 2025/11/12**
**作成者: GitHub Copilot**
