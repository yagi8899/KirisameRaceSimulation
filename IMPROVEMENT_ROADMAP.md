# 🎯 競馬予測モデル改善ロードマップ

## 📊 現状と目標

### 現在の性能
- **単勝的中率**: 21-23%
- **単勝回収率**: 56-100%
- **複勝的中率**: 87-88%

### 目標性能 (6ヶ月後)
- **単勝的中率**: 25-27% (+4-6ポイント)
- **単勝回収率**: 130-150% (+30-50ポイント)
- **複勝的中率**: 90-92% (+3-4ポイント)

---

## 🚀 Phase 1: 即効性の高い改善 (Week 1-2)

### Week 1: オッズ活用と資金管理

#### ✅ タスク1-1: オッズベース期待値計算の実装
- **目的**: 予測確率とオッズから期待値を計算し、プラス期待値のレースのみ購入
- **実装内容**:
  ```python
  # expected_value_calculator.py を作成
  - 予測勝率 × オッズ = 期待値
  - 期待値 > 1.2 のレースのみ購入対象
  - バックテストで閾値を最適化 (1.1 ~ 1.5)
  ```
- **期待効果**: 回収率 +10-15ポイント
- **工数**: 2日
- **優先度**: ★★★★★
- **必要スキル**: Python基礎、pandas
- **判断**: [✅] 実施する / [ ] 不要 / [ ]保留

---

#### ✅ タスク1-2: ケリー基準による資金管理
- **目的**: 自信のあるレースに多く賭け、資金効率を最大化
- **実装内容**:
  ```python
  # kelly_criterion.py を作成
  - ケリー基準の計算式実装
  - クォーターケリー(保守的)を採用
  - 最大賭け金を総資金の5%に制限
  - バックテストでパラメータ調整
  ```
- **期待効果**: 資金増加速度 2-3倍
- **工数**: 1日
- **優先度**: ★★★★★
- **必要スキル**: Python基礎、基本的な確率論
- **判断**: [✅] 実施する / [ ] 不要 / [ ]保留

---

#### ✅ タスク1-3: 期待値ベース購入ロジックの統合
- **目的**: universal_test.pyに期待値計算を組み込む
- **実装内容**:
  ```python
  # universal_test.py を修正
  - predict_with_model() に期待値計算を追加
  - 購入判断フラグを追加
  - 購入額をケリー基準で決定
  - 結果をログに記録
  ```
- **期待効果**: 実運用への準備完了
- **工数**: 2日
- **優先度**: ★★★★★
- **必要スキル**: 既存コードの理解
- **判断**: [✅] 実施する / [ ] 不要 / [ ]保留

---

### Week 2: レース選別ロジック

#### ✅ タスク2-1: 予測信頼度スコアの計算 (拡張版: 馬ごとの重み付け)
- **目的**: 的中しやすいレースを選別し、馬ごとの購入確率を最適化する
- **実装内容**:
  ```python
  # race_confidence_scorer.py を作成
  
  【レース全体の信頼度スコア】
  - 予測上位3頭のスコア差 (大きいほど自信あり)
  - 人気分布の偏り度 (集中しているほど堅い)
  - 出走頭数 (少ないほど的中しやすい)
  - 過去の類似条件での的中率
  - 総合信頼度スコアを0-100で算出
  
  【馬ごとの購入確率 (重み付け)】⭐NEW⭐
  - 各馬の予測信頼度を0-100で算出
  - 信頼度70%以上 → 購入確率100% (必ず購入)
  - 信頼度50-70% → 購入確率70% (高確率で購入)
  - 信頼度30-50% → 購入確率30% (低確率で購入)
  - 信頼度30%未満 → 購入確率5% (ほぼ購入しない)
  
  【重み付けロジック】
  - 期待値計算 (タスク1-1) と連携
  - 期待値 × 信頼度重み = 最終購入判断
  - 低信頼度馬への投資額を削減
  - 高信頼度馬へ資金を集中
  
  【完全除外はしない理由】
  - 「絶対に来ない馬」は存在しない (競馬の不確実性)
  - 低確率でも購入 → 高配当的中の可能性を残す
  - 確率的アプローチで期待値を最大化
  ```
- **期待効果**: 
  - レース全体: 的中率 +5-7ポイント
  - 馬ごと重み: 回収率 +5-10ポイント (無駄な購入削減)
- **工数**: 3.5日 (拡張分+0.5日)
- **優先度**: ★★★★★
- **必要スキル**: データ分析、統計の基礎、確率的意思決定
- **判断**: [✅] 実施する / [ ] 不要

---

#### ✅ タスク2-2: レース選別閾値の最適化
- **目的**: 信頼度スコアの閾値を決定
- **実装内容**:
  ```python
  # race_selector_optimizer.py を作成
  - 過去3年のデータで閾値をグリッドサーチ
  - 閾値ごとの的中率・回収率・対象レース数を計算
  - 利益最大化する閾値を選択
  - バックテストで検証
  ```
- **期待効果**: 購入レース最適化
- **工数**: 2日
- **優先度**: ★★★★☆
- **必要スキル**: 最適化、グリッドサーチ
- **判断**: [✅] 実施する / [ ] 不要 / [ ]保留

---

#### ✅ タスク2-3: 荒れるレースの事前検知
- **目的**: 予測困難なレースを避ける
- **実装内容**:
  ```python
  # chaos_race_detector.py を作成
  - 人気上位馬の不安定性
  - 波乱の起きやすい条件 (新馬戦、悪馬場など)
  - 過去データから荒れたレースのパターン抽出
  - 危険度スコアを算出
  ```
- **期待効果**: 大負けレースの回避
- **工数**: 2日
- **優先度**: ★★★★☆
- **必要スキル**: パターン認識
- **判断**: [ ] 実施する / [ ] 不要 / [✅]保留

---

### Week 1-2 のマイルストーン
- [✅] 期待値ベース購入システム完成
- [✅] ケリー基準による資金管理実装
- [✅] レース選別ロジック完成
- [✅] 過去3年データでバックテスト実行
- [✅] 結果レポート作成

**Phase 1 完了時の期待性能 (フル実装):**
- 単勝的中率: 21-23% → 24-26% (+3-5ポイント)
- 単勝回収率: 56-100% → 110-130% (+20-40ポイント)
- **重要**: オッズ・ケリー基準により回収率が大幅改善!利益が見込める!

---

## 🔧 Phase 2: モデル強化 (Week 3-6)

### Week 3-4: アンサンブル学習の導入

#### ✅ タスク3-1: XGBoostモデルの作成
- **目的**: LightGBMと異なる視点で予測
- **実装内容**:
  ```python
  # xgboost_model_creator.py を作成
  - 既存のmodel_creator.pyをベースに改造
  - XGBoost用のハイパーパラメータチューニング
  - 同じ特徴量で学習
  - 7年学習期間で3モデル作成
  ```
- **期待効果**: アンサンブル準備
- **工数**: 3日
- **優先度**: ★★★★☆
- **必要スキル**: XGBoost、Optuna
- **判断**: [ ] 実施する / [ ] 不要

---

#### ✅ タスク3-2: ニューラルネットワークモデルの実験
- **目的**: 非線形パターンの学習
- **実装内容**:
  ```python
  # neural_network_model.py を作成
  - Keras/PyTorchで3層NN構築
  - DropoutとBatch Normalization
  - ランク学習用の損失関数
  - 簡易的な実験のみ(本格導入はPhase 3)
  ```
- **期待効果**: 可能性検証
- **工数**: 4日
- **優先度**: ★★★☆☆
- **必要スキル**: ディープラーニング基礎
- **判断**: [ ] 実施する / [✅] 不要

---

#### ✅ タスク3-3: アンサンブル予測ロジック
- **目的**: 複数モデルの予測を統合
- **実装内容**:
  ```python
  # ensemble_predictor.py を作成
  - 加重平均: LightGBM 60% + XGBoost 40%
  - 投票方式: 各モデルのTop3を集計
  - スタッキング: メタ学習器で最終予測
  - バックテストで最適な組み合わせを決定
  ```
- **期待効果**: 的中率 +2-4ポイント、安定性向上
- **工数**: 3日
- **優先度**: ★★★★☆
- **必要スキル**: アンサンブル学習理論
- **判断**: [ ] 実施する / [ ] 不要

---

### Week 5-6: 時系列特徴量の強化

#### ✅ タスク4-1: EWM(指数加重移動平均)の最適化
- **目的**: 直近の調子を正確に捉える
- **実装内容**:
  ```python
  # universal_test.py を修正
  - 短期EWM (span=3): 直近の調子
  - 長期EWM (span=10): 長期トレンド
  - 調子の加速度: 短期 - 長期
  - 馬ごとに最適なspanをチューニング
  ```
- **期待効果**: 的中率 +1-2ポイント
- **工数**: 2日
- **優先度**: ★★★★☆
- **必要スキル**: 時系列分析
- **判断**: [ ] 実施する / [✅] 不要

---

#### ✅ タスク4-2: 休養明けパターンの分析
- **目的**: 休養期間の最適化
- **実装内容**:
  ```python
  # rest_pattern_analyzer.py を作成
  - 前走からの日数を特徴量化
  - 馬ごとの最適休養期間を学習
  - 休養明け1戦目/2戦目のフラグ
  - 長期休養後のパフォーマンス
  ```
- **期待効果**: 的中率 +1ポイント
- **工数**: 3日
- **優先度**: ★★★☆☆
- **必要スキル**: データ分析
- **判断**: [ ] 実施する / [✅] 不要

---

#### ✅ タスク4-3: レース間隔パターンの特徴量化
- **目的**: 馬ごとのベストローテーションを捉える
- **実装内容**:
  ```python
  # race_interval_features.py を作成
  - 過去5走の間隔パターン
  - 連闘・中間隔・長期休養の成績
  - 同じ間隔での過去成績
  - パターンの一貫性スコア
  ```
- **期待効果**: 的中率 +1ポイント
- **工数**: 2日
- **優先度**: ★★★☆☆
- **必要スキル**: パターン抽出
- **判断**: [✅] 実施する / [ ] 不要

---

### Week 3-6 のマイルストーン
- [❌] XGBoostモデル完成 (実施なし)
- [❌] アンサンブル予測システム構築 (実施なし)
- [✅] 時系列特徴量追加 (タスク4-3のみ: レース間隔パターン)
- [ ] 統合バックテスト実行
- [ ] Phase 1との比較レポート

**Phase 2 完了時の期待性能 (タスク4-3のみ実施):**
- 単勝的中率: 23-25% → 24-26% (+1ポイント)
- 単勝回収率: 70-110% → 75-115% (+5ポイント)
- **注意**: アンサンブル学習を見送ったため、性能向上は小幅

---

## 🎯 Phase 3: 高度な最適化 (Week 7-12)

### Week 7-9: 馬券種の動的選択

#### ✅ タスク5-1: レース特性分析システム
- **目的**: レースごとに最適な馬券種を判断
- **実装内容**:
  ```python
  # race_characteristic_analyzer.py を作成
  - 本命の信頼度 (予測スコアと人気の一致度)
  - 上位の混戦度 (上位3頭のスコア差)
  - 荒れる可能性 (人気薄の上位予測)
  - レースタイプの分類 (堅い/混戦/波乱)
  ```
- **期待効果**: 馬券種選択の準備
- **工数**: 4日
- **優先度**: ★★★★☆
- **必要スキル**: 多変量解析
- **判断**: [ ] 実施する / [ ] 不要 / [✅]保留

---

#### ✅ タスク5-2: 各馬券種の期待配当計算
- **目的**: 期待値を馬券種ごとに計算
- **実装内容**:
  ```python
  # bet_type_optimizer.py を作成
  - 単勝: 予測1位の勝率 × オッズ
  - 馬連: 予測1-2位の的中率 × 平均配当
  - 三連複: 予測1-3位の的中率 × 平均配当
  - 過去データから馬券種別の期待値分布を学習
  ```
- **期待効果**: 最適馬券種の選択
- **工数**: 3日
- **優先度**: ★★★★☆
- **必要スキル**: 確率計算
- **判断**: [ ] 実施する / [ ] 不要 / [✅]保留

---

#### ✅ タスク5-3: 動的馬券種選択ロジック
- **目的**: レースごとに自動で馬券種を選択
- **実装内容**:
  ```python
  # dynamic_bet_selector.py を作成
  - 信頼度が高い → 単勝
  - 混戦 → 三連複
  - 穴馬あり → 馬単・三連単
  - 期待値が最も高い馬券種を自動選択
  - 資金配分も自動調整
  ```
- **期待効果**: 回収率 +15-25ポイント
- **工数**: 4日
- **優先度**: ★★★★☆
- **必要スキル**: 意思決定アルゴリズム
- **判断**: [ ] 実施する / [ ] 不要 / [✅]保留

---

### Week 10-11: 穴馬検出システム

#### ✅ タスク6-1: 穴馬候補のスコアリング
- **目的**: 高配当が期待できる馬を発見
- **実装内容**:
  ```python
  # dark_horse_detector.py を作成
  - 予測順位3-5位 かつ 人気8位以下
  - 過去の類似条件で好走歴
  - 騎手・調教師の近況好調
  - 前走の内容が良い(着差、上がり3Fなど)
  - 穴馬スコアを算出
  ```
- **期待効果**: 高配当的中の増加
- **工数**: 3日
- **優先度**: ★★★☆☆
- **必要スキル**: パターンマッチング
- **判断**: [✅] 実施する / [ ] 不要

---

#### ✅ タスク6-2: 穴馬-本命の組み合わせ最適化
- **目的**: 効率的な馬券構成
- **実装内容**:
  ```python
  # exotic_bet_optimizer.py を作成
  - 穴馬と本命の馬単
  - 穴馬を軸にした三連単
  - 期待配当が10,000円以上の組み合わせ抽出
  - 投資額と期待リターンのバランス
  ```
- **期待効果**: ハイリターン的中の増加
- **工数**: 3日
- **優先度**: ★★★☆☆
- **必要スキル**: 組合せ最適化
- **判断**: [✅] 実施する / [ ] 不要

---

### Week 12: 統合テストと最終調整

#### ✅ タスク7-1: 3年間フルバックテスト
- **目的**: 全ての改善を統合して検証
- **実装内容**:
  ```python
  # full_backtest.py を作成
  - 2023-2025年の全レースで検証
  - Phase 1,2,3の各段階での性能比較
  - レース選別率、馬券種分布の分析
  - 資金推移のシミュレーション
  ```
- **期待効果**: 最終性能の確認
- **工数**: 2日
- **優先度**: ★★★★★
- **必要スキル**: バックテスト設計
- **判断**: [✅] 実施する / [ ] 不要

---

#### ✅ タスク7-2: パラメータの最終チューニング
- **目的**: 全体の最適化
- **実装内容**:
  ```python
  - 期待値の閾値
  - ケリー基準の係数
  - 信頼度スコアの閾値
  - アンサンブルの重み
  - 各パラメータをベイズ最適化
  ```
- **期待効果**: 性能の微調整
- **工数**: 3日
- **優先度**: ★★★★☆
- **必要スキル**: ベイズ最適化
- **判断**: [ ] 実施する / [ ] 不要

---

#### ✅ タスク7-3: 実運用システムの構築
- **目的**: 自動化された予測・購入システム
- **実装内容**:
  ```python
  # auto_betting_system.py を作成
  - 毎週のレース取得
  - 自動予測実行
  - 購入推奨リストの生成
  - 結果の自動記録
  - 週次レポート作成
  ```
- **期待効果**: 運用の自動化
- **工数**: 4日
- **優先度**: ★★★★☆
- **必要スキル**: システム設計
- **判断**: [ ] 実施する / [ ] 不要 / [✅]保留

---

### Week 7-12 のマイルストーン
- [⏸️] 馬券種動的選択システム完成 (保留)
- [✅] 穴馬検出システム完成 (タスク6-1, 6-2実施)
- [✅] 3年間フルバックテスト完了
- [⏸️] 実運用システム構築 (保留)
- [✅] 最終性能レポート

**Phase 3 完了時の期待性能 (タスク6-1, 6-2, 7-1のみ実施):**
- 単勝的中率: 24-26% → 24-27% (+1ポイント)
- 三連単的中率: 4-7% → 6-9% (+2ポイント)
- 単勝回収率: 75-115% → 80-125% (+5-10ポイント)
- 高配当的中の増加 (万馬券の可能性向上)
- **年間利益(500万予算)**: 0-125万円 (変動大)
- **注意**: 馬券種動的選択を保留したため、回収率の大幅改善は期待薄

---

## 📋 オプション: 長期的改善 (Phase 4以降)

### オプション1: 外部データの統合

#### タスク: 調教データの取得と活用
- **目的**: 調教タイム・調教師コメントの分析
- **実装内容**: WebスクレイピングまたはAPI利用
- **期待効果**: 的中率 +2-3ポイント
- **工数**: 4週間
- **コスト**: データ取得費用が必要
- **優先度**: ★★★☆☆
- **判断**: [ ] 実施する / [✅] 不要

---

#### タスク: 血統データの深掘り
- **目的**: 配合理論の自動分析
- **実装内容**: 血統データベース構築と特徴量化
- **期待効果**: 的中率 +1-2ポイント
- **工数**: 3週間
- **優先度**: ★★☆☆☆
- **判断**: [ ] 実施する / [✅] 不要

---

### オプション2: ディープラーニングの本格導入

#### タスク: LSTMによる時系列予測
- **目的**: 複雑な時系列パターンの学習
- **実装内容**: 過去10走のシーケンスからLSTMで予測
- **期待効果**: 的中率 +1-3ポイント
- **工数**: 6週間
- **リスク**: 過学習の可能性大
- **優先度**: ★★☆☆☆
- **判断**: [ ] 実施する / [✅] 不要

---

#### タスク: Transformerによる特徴量抽出
- **目的**: Attention機構で重要特徴を自動抽出
- **実装内容**: BERT系の事前学習モデル応用
- **期待効果**: 的中率 +2-4ポイント (不確実)
- **工数**: 8週間
- **リスク**: 計算コスト大、実用性不明
- **優先度**: ★☆☆☆☆
- **判断**: [ ] 実施する / [✅] 不要

---

## 📊 投資対効果の比較

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase/タスク            工数   効果    優先度   投資対効果
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 1: 即効改善        10日  大幅↑  最優先   ★★★★★
  - オッズ活用           3日   +++++   最優先   ★★★★★
  - ケリー基準           1日   ++++    最優先   ★★★★★
  - レース選別           6日   +++++   最優先   ★★★★★

Phase 2: モデル強化      20日  中幅↑  高      ★★★★☆
  - アンサンブル         10日  +++     高      ★★★★☆
  - 時系列強化           10日  ++      中      ★★★☆☆

Phase 3: 高度最適化      25日  中幅↑  中      ★★★☆☆
  - 馬券種選択           11日  +++     中      ★★★★☆
  - 穴馬検出             6日   ++      中低    ★★★☆☆
  - 統合テスト           8日   ++      高      ★★★★☆

オプション: 外部データ    28日  小幅↑  低      ★★☆☆☆
オプション: DL本格化      56日  不明    最低    ★☆☆☆☆
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🎯 実装プラン (あなたの判断に基づく)

### 🔥 **採用構成: 本気で稼ぐプラン (改訂版)**

#### ✅ **実施タスク (Phase 1: 最優先 - Week 1-2)**:
1. **タスク1-1**: オッズベース期待値計算 (2日) ⭐**超重要**
2. **タスク1-2**: ケリー基準による資金管理 (1日) ⭐**超重要**
3. **タスク1-3**: 期待値ベース購入ロジック統合 (2日) ⭐**超重要**
4. **タスク2-1**: 予測信頼度スコア計算 + 馬ごとの重み付け (3.5日) ⭐**拡張版**
5. **タスク2-2**: レース選別閾値最適化 (2日)

**Phase 1 合計工数**: 10.5日 (2週間強)

#### ✅ **実施タスク (Phase 2-3: 追加機能 - Week 3-5)**:
6. **タスク4-3**: レース間隔パターン特徴量 (2日)
7. **タスク6-1**: 穴馬候補スコアリング (3日)
8. **タスク6-2**: 穴馬-本命組合せ最適化 (3日)
9. **タスク7-1**: 3年間フルバックテスト (2日)

**Phase 2-3 合計工数**: 10日 (2週間)

**全体合計工数**: 20.5日 (4週間強 = 約1ヶ月)

---

#### ⏸️ **保留タスク** (効果を見て判断):
- レース荒れ検知 (タスク2-3)
- 馬券種動的選択 (タスク5-1, 5-2, 5-3)
- 実運用システム (タスク7-3)

**保留理由**: Phase 1で十分な利益が出る可能性が高い。様子見で追加判断

---

#### ❌ **不採用タスク**:
- ニューラルネットワーク (タスク3-2)
- EWM最適化 (タスク4-1)
- 休養パターン分析 (タスク4-2)
- 全オプション機能 (外部データ、DL本格化)

**不採用理由**: 投資対効果が低い、または複雑すぎる

---

### 📊 **期待性能 (カスタムプラン)**:
- **単勝的中率**: 21-23% → 24-27% (+3-6ポイント)
- **三連単的中率**: 4-7% → 6-9% (+2ポイント)
- **単勝回収率**: 56-100% → 80-125% (+20-30ポイント)
- **年間利益(500万予算)**: 0-125万円 (変動あり)

---

### ⚠️ **このプランの特徴と注意点**:

#### 🟢 **メリット**:
- 工数が少ない (13日で完了可能)
- 的中率の向上が見込める
- 穴馬検出で高配当チャンスあり
- 実装が比較的シンプル

#### � **デメリット**:
- **回収率の大幅改善は期待薄**
  - オッズ活用・ケリー基準を保留 → 資金効率悪い
  - 馬券種動的選択を保留 → 最適馬券が選べない
- **利益の安定性が低い**
  - 穴馬検出メイン → 当たれば大きいが外れも多い
  - 的中率向上だけでは利益は保証されない
- **目標の400万円利益は困難**
  - 最大でも125万円程度 (回収率125%想定)
  - 安定的に100万円超は厳しい

---

### 💡 **推奨される追加検討事項**:

このプランで実装後、結果を見て以下を判断することをおすすめするよ:

1. **タスク2-1の効果が高ければ**
   - → タスク1-1, 1-2, 1-3 (オッズ・ケリー) を追加実装
   - → 回収率が大幅アップする可能性大

2. **穴馬検出の精度が高ければ**
   - → タスク5-1, 5-2, 5-3 (馬券種選択) を追加実装
   - → 三連単などで大きく稼げる

3. **全体の効果が低ければ**
   - → タスク3-1, 3-3 (アンサンブル) を再検討
   - → モデル自体の精度を上げる

---

## ⚠️ リスクと注意事項

### 🔴 過学習のリスク
- 改善を重ねるほど過学習の危険性が増す
- **対策**: 必ず別期間でのバックテストで検証

### 🔴 計算コストの増大
- アンサンブルやDLは計算時間が長い
- **対策**: GPU環境の準備、計算の並列化

### 🔴 実装の複雑化
- システムが複雑になるとメンテナンスが困難に
- **対策**: ドキュメント整備、モジュール化

### 🔴 期待値とのズレ
- バックテストの結果が実運用で再現しない可能性
- **対策**: 保守的な目標設定、段階的な資金投入

---

## 📅 次のアクション (本気で稼ぐプラン)

### **Week 1: オッズ・ケリー基準実装 (最優先!)**
- [ ] **Day 1-2**: タスク1-1 (オッズベース期待値計算) ⭐
  - `expected_value_calculator.py` を作成
  - 予測勝率 × オッズ = 期待値の計算
  - 期待値 > 1.2 のレースのみ購入対象
  - バックテストで閾値を最適化 (1.1 ~ 1.5)
  
- [ ] **Day 3**: タスク1-2 (ケリー基準による資金管理) ⭐
  - `kelly_criterion.py` を作成
  - ケリー基準の計算式実装
  - クォーターケリー(保守的)を採用
  - 最大賭け金を総資金の5%に制限
  
- [ ] **Day 4-5**: タスク1-3 (期待値ベース購入ロジック統合) ⭐
  - `universal_test.py` を修正
  - `predict_with_model()` に期待値計算を追加
  - 購入判断フラグを追加
  - 購入額をケリー基準で決定

### **Week 2: レース選別ロジック**
- [ ] **Day 6-8**: タスク2-1 (予測信頼度スコア計算 + 馬ごとの重み付け) ⭐拡張版⭐
  - `race_confidence_scorer.py` を作成
  - 予測スコア差、人気分布、出走頭数から信頼度算出
  - 総合信頼度スコアを0-100で算出
  - **各馬の購入確率を信頼度ベースで算出 (重み付け)**
  - **期待値計算 (タスク1-1) と連携して最終購入判断**
  - **完全除外はせず、確率的アプローチで期待値最大化**
  
- [ ] **Day 9-10**: タスク2-2 (レース選別閾値最適化)
  - `race_selector_optimizer.py` を作成
  - 過去3年のデータで閾値をグリッドサーチ
  - 利益最大化する閾値を選択
  - バックテストで検証

### **Week 3: 特徴量追加と穴馬検出**
- [ ] **Day 11-12**: タスク4-3 (レース間隔パターン)
  - `race_interval_features.py` を作成
  - 過去5走の間隔パターンを特徴量化
  - モデルに組み込んで再学習
  
- [ ] **Day 13-15**: タスク6-1 (穴馬スコアリング)
  - `dark_horse_detector.py` を作成
  - 予測順位と人気のギャップから穴馬を検出
  - 穴馬スコアを算出

### **Week 4: 穴馬組合せと統合テスト**
- [ ] **Day 16-18**: タスク6-2 (穴馬-本命組合せ)
  - `exotic_bet_optimizer.py` を作成
  - 馬単・三連単の組合せ最適化
  - 期待配当計算
  
- [ ] **Day 19-20**: タスク7-1 (3年間フルバックテスト)
  - `full_backtest.py` を作成
  - 2023-2025年で全機能テスト
  - Phase 1,2,3の各段階での性能比較
  - 結果レポート作成

---

### 🚦 **マイルストーン判定基準**

#### ✅ **Phase 1完了時 (Week 2終了)の成功基準**:
- 単勝的中率が24%以上
- **単勝回収率が110%以上** ⭐最重要⭐
- 複勝回収率が100%以上

→ **Phase 2-3へ進む**

#### 🔥 **Phase 1-3完了時 (Week 4終了)の成功基準**:
- 単勝的中率が25%以上
- **単勝回収率が125%以上** ⭐最重要⭐
- 三連単的中率が6%以上

→ **実運用開始!または保留タスク (馬券種選択) を追加検討**

#### ⚠️ **要改善基準**:
- 単勝回収率が100-110%未満

→ **パラメータ再調整 (期待値閾値、ケリー係数など)**

#### ❌ **失敗基準**:
- 単勝回収率が100%未満

→ **根本的な見直し (アンサンブル学習の再検討、または特徴量の大幅見直し)**

---

## 📝 備考

- 各タスクの工数は1人での作業を想定
- 実装順序は変更可能だが、Phase 1を優先推奨
- 途中で性能が目標に達したら以降は省略可能
- 定期的にバックテストで効果を検証すること

---

---

## 📈 実装優先度サマリー (本気で稼ぐプラン)

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
タスク                     判断      工数    期待効果
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【実施: Phase 1 - 最優先!】
タスク1-1: オッズ期待値    ✅実施    2日     回収率+10-15pt⭐
タスク1-2: ケリー基準      ✅実施    1日     資金効率3倍⭐
タスク1-3: 購入ロジック    ✅実施    2日     実運用準備⭐
タスク2-1: 信頼度+重み     ✅実施   3.5日    的中率+5-7pt
                                             回収率+5-10pt⭐
タスク2-2: 選別最適化      ✅実施    2日     的中率+3-5pt
                                  ────    ──────────────
                   Phase 1小計: 10.5日    回収率+25-50pt
                                          的中率+8-12pt

【実施: Phase 2-3】
タスク4-3: レース間隔      ✅実施    2日     的中率+1pt
タスク6-1: 穴馬検出        ✅実施    3日     高配当増加
タスク6-2: 穴馬組合せ      ✅実施    3日     三連単的中増
タスク7-1: 統合テスト      ✅実施    2日     効果測定
                                  ────    ──────────────
                Phase 2-3小計:   10日    回収率+10-20pt
                                          的中率+2-3pt
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                   【合計】:    20.5日    回収率+35-70pt
                                          的中率+10-15pt
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【保留】(効果を見て判断)
タスク2-3: 荒れ検知        ⏸保留    2日     大負け回避
タスク5-1,5-2,5-3: 馬券種  ⏸保留   11日     回収率+15-25pt
タスク7-3: 実運用システム  ⏸保留    4日     自動化
                                  ────    ──────────────
                          小計:    17日    回収率+15-25pt

【不採用】
アンサンブル学習           ❌不要   10日     的中率+2-4pt
EWM最適化                  ❌不要    2日     的中率+1-2pt
休養パターン               ❌不要    3日     的中率+1pt
外部データ統合             ❌不要   28日     的中率+2-3pt
DL本格導入                 ❌不要   56日     不明
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🎯 最終的な期待値 (本気で稼ぐプラン)

### 📊 **Phase 1完了時 (2週間後)**:
- **単勝的中率**: 21-23% → **24-26%** (+3-5ポイント)
- **単勝回収率**: 56-100% → **115-140%** (+25-50ポイント) ⭐⭐⭐⭐ (重み付け効果!)
- **複勝回収率**: 70-95% → **110-125%** (+20-30ポイント)
- **年間利益(500万予算)**: **75-200万円** (安定&高収益!)

### 📊 **Phase 1-3完了時 (4週間後)**:
- **単勝的中率**: 24-26% → **25-28%** (+1-2ポイント)
- **単勝回収率**: 115-140% → **130-155%** (+15ポイント) ⭐⭐⭐⭐⭐
- **三連単的中率**: 4-7% → **6-9%** (+2ポイント)
- **高配当的中**: 万馬券的中率向上
- **年間利益(500万予算)**: **150-275万円** (高収益!)

### 💰 **予算別の年間利益シミュレーション**:

#### 🎰 **500万円予算の場合**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
プラン              回収率    年間利益    評価
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 1のみ         127%      135万円     ⭐⭐⭐⭐
Phase 1+2+3         142%      210万円     ⭐⭐⭐⭐⭐
保留タスクも実施    155%      275万円     ⭐⭐⭐⭐⭐
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 📊 **1000万円予算の場合 (目標400万円達成可能!)**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
プラン              回収率    年間利益    評価
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Phase 1のみ         127%      270万円     ⭐⭐⭐⭐
Phase 1+2+3         142%      420万円✨   ⭐⭐⭐⭐⭐
保留タスクも実施    152%      520万円🎉   ⭐⭐⭐⭐⭐
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 💡 **このプランが最強な理由**

### 🔥 **Phase 1で回収率を確保!**
- オッズ・ケリー基準により、**まず確実に利益を出す土台を作る**
- これだけで年間50-150万円の利益が見込める
- 的中率向上も同時に達成

### 🚀 **Phase 2-3で更に上乗せ!**
- Phase 1の安定収益をベースに
- 穴馬検出で高配当を狙う
- 更に75-100万円の上乗せ

### 💎 **保留タスクで最終調整**
- 回収率が140%以上なら馬券種選択を追加 → 150-160%へ
- 回収率が足りなければアンサンブル学習を追加 → モデル強化

---

## 🎯 **追加実装の判断基準**

Phase 1-3完了後、以下の条件に応じて保留タスクを判断:

1. **回収率が140%以上なら**
   - → タスク5-1, 5-2, 5-3 (馬券種選択) を追加実装
   - → 150-160%を目指す!年間250-300万円の利益へ!

2. **回収率が120-140%なら**
   - → 現状維持で実運用開始
   - → 徐々に資金を増やして複利運用

3. **回収率が110-120%なら**
   - → パラメータ再調整 (期待値閾値、ケリー係数)
   - → タスク2-3 (荒れ検知) を追加して大負けを防ぐ

4. **回収率が110%未満なら**
   - → タスク3-1, 3-3 (アンサンブル) を追加実装
   - → モデル自体を強化して的中率を底上げ

---

## その他（現状の各年の的中率）
◆2023年
単勝：21%
複勝：88%
馬連：22%
ワイド：44%
三連複：6.9%

◆2024年
単勝：23%
複勝：88%
馬連：23%
ワイド：43%
三連複：4.1%

◆2025年
単勝：21%
複勝：87.8%
馬連：22%
ワイド：42%
三連複：4.4%

**作成日**: 2025年11月11日  
**更新日**: 2025年11月11日 (タスク2-1拡張版)  
**バージョン**: 2.1 (馬ごとの重み付け対応)
