# ç«¶é¦¬äºˆæ¸¬ãƒ¢ãƒ‡ãƒ« æ±ç”¨åŒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ğŸ‡

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯æ©Ÿæ¢°å­¦ç¿’ã‚’ä½¿ã£ãŸç«¶é¦¬ã®é †ä½äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
å¾“æ¥ã®é˜ªç¥ç«¶é¦¬å ´é™å®šã‹ã‚‰ã€è¤‡æ•°ã®ç«¶é¦¬å ´ãƒ»æ¡ä»¶ã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«æ±ç”¨åŒ–ã•ã‚Œã¾ã—ãŸï¼

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### ğŸ†• æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ±ç”¨åŒ–å¯¾å¿œï¼‰
- `model_creator.py` - æ±ç”¨çš„ãªãƒ¢ãƒ‡ãƒ«ä½œæˆé–¢æ•°
- `batch_model_creator.py` - è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ä¸€æ‹¬ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `universal_test.py` - æ±ç”¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `keiba_constants.py` - å…±é€šå®šæ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
- `model_configs.json` - ãƒ¢ãƒ‡ãƒ«è¨­å®šï¼ˆJSONå½¢å¼ï¼‰
- `model_config_loader.py` - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- `db_query_builder.py` - **SQLç”Ÿæˆã®å…±é€šåŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«** â­NEW
- `walk_forward_validation.py` - **Walk-Forward Validationè‡ªå‹•å®Ÿè¡Œãƒ„ãƒ¼ãƒ«** â­NEW
- `walk_forward_config.json` - WFVè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœ¬ç•ªç”¨ï¼‰ â­NEW
- `walk_forward_validation_design.md` - WFVå®Œå…¨è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ â­NEW

### ğŸ”¬ åˆ†æãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«
- `model_explainer.py` - SHAPåˆ†æã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«è§£é‡ˆãƒ„ãƒ¼ãƒ«
- `analyze_shap_results.py` - SHAPå€¤ã®çµ±è¨ˆåˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆCLIå¯¾å¿œï¼‰ â­UPDATED
- `batch_shap_analyzer.py` - **è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ä¸€æ‹¬SHAPåˆ†æãƒ„ãƒ¼ãƒ«** â­NEW
- `compare_years_shap.py` - **å¹´åº¦é–“SHAPå€¤æ¯”è¼ƒåˆ†æãƒ„ãƒ¼ãƒ«** â­NEW
- `analyze_threshold.py` - äºˆæ¸¬ã‚¹ã‚³ã‚¢å·®é–¾å€¤ã®æœ€é©åŒ–åˆ†æãƒ„ãƒ¼ãƒ« â­NEW
- `analyze_longshot_predictions.py` - **ç©´é¦¬äºˆæ¸¬è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ** â­NEW
- `test_ewm.py` - EWM(æŒ‡æ•°åŠ é‡ç§»å‹•å¹³å‡)ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `debug_ewm_detail.py` - EWM vs SQLå¹³å‡ã®è©³ç´°æ¯”è¼ƒãƒ„ãƒ¼ãƒ«
- `analyze_ewm_issue.py` - EWMæ€§èƒ½å•é¡Œã®æ ¹æœ¬åŸå› åˆ†æ
- `compare_models.py` - ãƒ¢ãƒ‡ãƒ«é–“æ€§èƒ½æ¯”è¼ƒãƒ„ãƒ¼ãƒ«
- `shap_analysis/` - SHAPåˆ†æçµæœã®ä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

### ğŸ‡ é€Ÿå ±äºˆæ¸¬ãƒ„ãƒ¼ãƒ«
- `sokuho_prediction.py` - **é€Ÿå ±ãƒ‡ãƒ¼ã‚¿ã§ã®äºˆæ¸¬å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ** â­NEW
- `db_query_builder.py` - **SQLç”Ÿæˆã®å…±é€šåŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆé€Ÿå ±å¯¾å¿œï¼‰** â­UPDATED
- `feature_engineering.py` - **ç‰¹å¾´é‡ç”Ÿæˆã®å…±é€šåŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«** â­UPDATED

### ğŸ“š æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
- `create_model_hanshin_shiba_3ageup.py` - é˜ªç¥èŠä¸­é•·è·é›¢ãƒ¢ãƒ‡ãƒ«ä½œæˆï¼ˆæ—§ç‰ˆï¼‰
- `test.py` - é˜ªç¥èŠä¸­é•·è·é›¢ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆæ—§ç‰ˆï¼‰
- `hanshin_shiba_3ageup_model.sav` - æ—¢å­˜ã®é˜ªç¥ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«

## ğŸš€ ä½¿ã„æ–¹ï¼ˆåŸºæœ¬ç·¨ï¼‰

### ğŸ“‹ äº‹å‰æº–å‚™

1. **PostgreSQLã®æº–å‚™**
   - JRAå…¬å¼ãƒ‡ãƒ¼ã‚¿ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ `keiba` ã‚’æº–å‚™
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚’å„Pythonãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®š

2. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª**
   - `model_configs.json` ã§ä½œæˆã—ãŸã„ãƒ¢ãƒ‡ãƒ«ã‚’ç¢ºèªãƒ»ç·¨é›†

### ğŸ¯ ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ï¼ˆã‚ˆãä½¿ã†ã‚„ã¤ï¼‰

#### ğŸ”¥ ãƒ¢ãƒ‡ãƒ«ä½œæˆã‚³ãƒãƒ³ãƒ‰

```bash
# ã€ãƒ¡ã‚¤ãƒ³ã€‘24å€‹ã®æ¨™æº–ãƒ¢ãƒ‡ãƒ«ã‚’ä¸€æ‹¬ä½œæˆï¼ˆæ¨å¥¨ãƒ»2013~2022å¹´ï¼‰
python batch_model_creator.py

# å¹´ç¯„å›²ã‚’æŒ‡å®šã—ã¦ãƒ¢ãƒ‡ãƒ«ä½œæˆï¼ˆä¾‹: 2020~2023å¹´ï¼‰
python batch_model_creator.py 2020-2023

# å˜ä¸€å¹´ã§ãƒ¢ãƒ‡ãƒ«ä½œæˆï¼ˆä¾‹: 2023å¹´ã®ã¿ï¼‰
python batch_model_creator.py 2023

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã®ã¿ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2013~2022å¹´ï¼‰
python batch_model_creator.py custom

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’å¹´ç¯„å›²æŒ‡å®šã§ä½œæˆ
python batch_model_creator.py custom 2020-2023
```

#### ğŸ¯ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# ã€ãƒ¡ã‚¤ãƒ³ã€‘å…¨ãƒ¢ãƒ‡ãƒ«ä¸€æ‹¬ãƒ†ã‚¹ãƒˆï¼ˆæ¨å¥¨ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2023å¹´ï¼‰
python universal_test.py multi

# å¹´ç¯„å›²ã‚’æŒ‡å®šã—ã¦å…¨ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆä¾‹: 2020~2023å¹´ï¼‰
python universal_test.py multi 2020-2023

# å˜ä¸€å¹´ã§å…¨ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆä¾‹: 2024å¹´ã®ã¿ï¼‰
python universal_test.py multi 2024

# å˜ä¸€ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆé˜ªç¥èŠä¸­é•·è·é›¢ã®ã¿ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2023å¹´ï¼‰
python universal_test.py

# å˜ä¸€ãƒ¢ãƒ‡ãƒ«ã‚’å¹´ç¯„å›²æŒ‡å®šã§ãƒ†ã‚¹ãƒˆ
python universal_test.py 2020-2023

# ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®ã¿ãƒ†ã‚¹ãƒˆï¼ˆæ³¨æ„: å¹´ç¯„å›²æŒ‡å®šã¯æœªå¯¾å¿œï¼‰
python universal_test.py single tokyo_turf_3ageup_long.sav
```

#### ğŸ” åˆ†æãƒ»è¨ºæ–­ã‚³ãƒãƒ³ãƒ‰

```bash
# ã€é‡è¦ã€‘ç©´é¦¬äºˆæ¸¬ã®è¨ºæ–­ï¼ˆã‚ªãƒƒã‚º10å€ä»¥ä¸Šã®é¦¬ã®äºˆæ¸¬ç²¾åº¦ã‚’åˆ†æï¼‰
python analyze_longshot_predictions.py

# ã‚ªãƒƒã‚º15å€ä»¥ä¸Šã®å¤§ç©´ã‚’å¯¾è±¡ã«åˆ†æ
python analyze_longshot_predictions.py --odds_threshold 15.0

# ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æ
python analyze_longshot_predictions.py --file results/predicted_results_tokyo_turf_3ageup_long_trainunknown_test2023_all.tsv

# SHAPåˆ†æã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«è§£é‡ˆ
python model_explainer.py

# ãƒ¢ãƒ‡ãƒ«é–“ã®æ€§èƒ½æ¯”è¼ƒ
python compare_models.py
```

#### ğŸ”® é€Ÿå ±ãƒ‡ãƒ¼ã‚¿äºˆæ¸¬ã‚³ãƒãƒ³ãƒ‰ â­NEW

```bash
# ã€ãƒ¡ã‚¤ãƒ³ã€‘æ¨™æº–ãƒ¢ãƒ‡ãƒ«å…¨ã¦ï¼ˆ40å€‹ï¼‰ã§é€Ÿå ±ãƒ‡ãƒ¼ã‚¿ã‚’äºˆæ¸¬
python sokuho_prediction.py --model standard

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«å…¨ã¦ä¸€æ‹¬ã§é€Ÿå ±ãƒ‡ãƒ¼ã‚¿ã‚’äºˆæ¸¬
python sokuho_prediction.py --model custom
```

**é€Ÿå ±äºˆæ¸¬ã®è©³ç´°ï¼š**
- é€Ÿå ±ãƒ‡ãƒ¼ã‚¿ï¼ˆ`apd_sokuho_jvd_ra`/`apd_sokuho_jvd_se`ï¼‰ã‚’ä½¿ç”¨
- éå»ãƒ‡ãƒ¼ã‚¿ï¼ˆ`jvd_se`ï¼‰ã¨çµåˆã—ã¦ç‰¹å¾´é‡ã‚’è¨ˆç®—
- è³¼å…¥æ¨å¥¨ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆäºˆæ¸¬é †ä½â‰¤3ã€äººæ°—é †â‰¤3ã€ã‚ªãƒƒã‚º1.5-20å€ï¼‰ã‚’é©ç”¨
- ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—
- çµæœã¯ `sokuho_results/` ã«ä¿å­˜ã•ã‚Œã‚‹
- è©³ç´°ã¯ [SOKUHO_PREDICTION_GUIDE.md](SOKUHO_PREDICTION_GUIDE.md) ã‚’å‚ç…§

**ç©´é¦¬äºˆæ¸¬è¨ºæ–­ã®è¦‹æ–¹ï¼š**
- äºˆæ¸¬1-3ä½ã®ç©´é¦¬ãŒ15%ä»¥ä¸Š â†’ ãƒ¢ãƒ‡ãƒ«ã¯æ©Ÿèƒ½ã—ã¦ã„ã‚‹ â†’ ãƒ•ã‚£ãƒ«ã‚¿èª¿æ•´ãŒæœ‰åŠ¹
- äºˆæ¸¬1-3ä½ã®ç©´é¦¬ãŒ8%æœªæº€ â†’ ãƒ¢ãƒ‡ãƒ«ãŒæ‰ãˆã‚‰ã‚Œã¦ã„ãªã„ â†’ ç‰¹å¾´é‡æ”¹å–„ãŒå¿…è¦
- ã€Œäºˆæ¸¬ä¸Šä½ Ã— äººæ°—è–„ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æœŸå¾…å›åç‡ãŒ110%è¶… â†’ é«˜æœŸå¾…å€¤ï¼è³¼å…¥å¯¾è±¡ã«ã™ã¹ã

### ğŸ“Š å®Ÿè¡Œæ‰‹é †ï¼ˆåˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼‰

```bash
# 1. ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
python -m venv venv
source venv/Scripts/activate  # Windows bash

# 2. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®šã‚’ç¢ºèª
# ï¼ˆuniversal_test.py, model_creator.pyå†…ã®DBæ¥ç¶šæƒ…å ±ã‚’ç·¨é›†ï¼‰

# 4. æ¨™æº–ãƒ¢ãƒ‡ãƒ«ã‚’24å€‹ä¸€æ‹¬ä½œæˆï¼ˆæ™‚é–“ã‹ã‹ã‚Šã¾ã™ï¼ï¼‰
python batch_model_creator.py

# 5. ä½œæˆã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã§2023å¹´ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚¹ãƒˆ
python universal_test.py multi
```

### ğŸª æ—¥å¸¸çš„ãªä½¿ã„æ–¹

```bash
# ãƒ¢ãƒ‡ãƒ«ãŒæ—¢ã«ä½œæˆæ¸ˆã¿ã®å ´åˆ
python universal_test.py multi

# æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚’è¿½åŠ ã—ãŸå ´åˆ
python batch_model_creator.py custom

# ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã ã‘ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆ
python universal_test.py single hanshin_turf_3ageup_long.sav
```

## ğŸ§ª Walk-Forward Validationï¼ˆãƒ¢ãƒ‡ãƒ«æ±åŒ–æ€§èƒ½æ¤œè¨¼ï¼‰â­NEW

Walk-Forward Validationã¯ã€æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã§å­¦ç¿’æœŸé–“ã‚’å¤‰ãˆãªãŒã‚‰ãƒ¢ãƒ‡ãƒ«ã®æ±åŒ–æ€§èƒ½ã‚’è©•ä¾¡ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
ç•°ãªã‚‹å­¦ç¿’æœŸé–“ï¼ˆä¾‹: 5å¹´ã€7å¹´ã€10å¹´ï¼‰ã§ã®ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ã‚’æ¯”è¼ƒã—ã€**æœ€é©ãªå­¦ç¿’æœŸé–“ã‚’æ±ºå®š**ã—ã¾ã™ï¼

### ğŸ¯ ä½¿ç”¨ç›®çš„

1. **æœ€é©å­¦ç¿’æœŸé–“ã®æ±ºå®š**: éå­¦ç¿’ã‚’é¿ã‘ã€æœ€ã‚‚æ±åŒ–æ€§èƒ½ãŒé«˜ã„å­¦ç¿’æœŸé–“ã‚’ç‰¹å®š
2. **æ™‚ç³»åˆ—ã§ã®æ€§èƒ½å®‰å®šæ€§è©•ä¾¡**: è¤‡æ•°å¹´ã«ã‚ãŸã‚‹ãƒ†ã‚¹ãƒˆçµæœã‚’é›†è¨ˆ
3. **ãƒ¢ãƒ‡ãƒ«é¸æŠã®å®¢è¦³çš„æ ¹æ‹ **: ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãªæ„æ€æ±ºå®š

### ğŸ“ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™

#### å˜ä¸€æœŸé–“ãƒ¢ãƒ¼ãƒ‰ï¼ˆ1ã¤ã®å­¦ç¿’æœŸé–“ã§è©•ä¾¡ï¼‰

`walk_forward_config.json`:
```json
{
  "execution_mode": "single_period",
  "test_years": [2023, 2024, 2025],
  "training_period": 10,
  "models": "all",
  "output_dir": "walk_forward_results",
  "error_handling": {
    "on_model_error": "skip",
    "on_test_error": "skip"
  },
  "logging": {
    "level": "INFO",
    "file": "execution.log"
  }
}
```

#### æœŸé–“æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°ã®å­¦ç¿’æœŸé–“ã‚’æ¯”è¼ƒï¼‰

`walk_forward_config.json`:
```json
{
  "execution_mode": "compare_periods",
  "test_years": [2023, 2024, 2025],
  "training_periods": [5, 7, 10],
  "models": "standard",
  "output_dir": "walk_forward_results"
}
```

### ğŸš€ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# ã€åŸºæœ¬ã€‘è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œ
python walk_forward_validation.py --config walk_forward_config.json

# ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå®Ÿè¡Œè¨ˆç”»ã®ã¿è¡¨ç¤ºã€ãƒ¢ãƒ‡ãƒ«ä½œæˆãƒ»ãƒ†ã‚¹ãƒˆã¯è¡Œã‚ãªã„ï¼‰
python walk_forward_validation.py --config walk_forward_config.json --dry-run

# ä¸­æ–­ã—ãŸã‚¿ã‚¹ã‚¯ã‚’å†é–‹ï¼ˆé€²æ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•å†é–‹ï¼‰
python walk_forward_validation.py --config walk_forward_config.json --resume

# é€²æ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦æœ€åˆã‹ã‚‰å®Ÿè¡Œ
python walk_forward_validation.py --config walk_forward_config.json --clean

# ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆè©³ç´°ãƒ­ã‚°å‡ºåŠ›ï¼‰
python walk_forward_validation.py --config walk_forward_config.json --verbose

# customç”¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œ
python walk_forward_validation.py --config walk_forward_config_custom.json
```

### ğŸ“Š å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
walk_forward_results/
â”œâ”€â”€ period_10/                              # å­¦ç¿’æœŸé–“10å¹´ã®çµæœ
â”‚   â”œâ”€â”€ models/                            # å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â”œâ”€â”€ 2023/
â”‚   â”‚   â”‚   â”œâ”€â”€ tokyo_turf_3ageup_long_2013-2022.sav
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ 2024/
â”‚   â”‚   â””â”€â”€ 2025/
â”‚   â”œâ”€â”€ test_results/                      # ãƒ†ã‚¹ãƒˆçµæœï¼ˆå€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
â”‚   â”‚   â”œâ”€â”€ 2023/
â”‚   â”‚   â”‚   â”œâ”€â”€ predicted_results_..._all.tsv          # å…¨ãƒ¬ãƒ¼ã‚¹
â”‚   â”‚   â”‚   â””â”€â”€ predicted_results_..._skipped.tsv      # è³¼å…¥æ¨å¥¨é¦¬ãƒ‡ãƒ¼ã‚¿
â”‚   â”‚   â”œâ”€â”€ 2024/
â”‚   â”‚   â””â”€â”€ 2025/
â”‚   â”œâ”€â”€ summary_period_10.tsv              # çµ±åˆã‚µãƒãƒªãƒ¼ï¼ˆå…¨ãƒ¢ãƒ‡ãƒ«Ã—å…¨å¹´ï¼‰
â”‚   â””â”€â”€ all_predictions_period_10.tsv      # â­å…¨äºˆæ¸¬çµæœçµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå…¨ãƒ¢ãƒ‡ãƒ«Ã—å…¨å¹´ï¼‰
â”œâ”€â”€ period_7/                               # å­¦ç¿’æœŸé–“7å¹´ã®çµæœ
â”‚   â””â”€â”€ all_predictions_period_7.tsv       # â­å…¨äºˆæ¸¬çµæœçµ±åˆãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ period_5/                               # å­¦ç¿’æœŸé–“5å¹´ã®çµæœ
â”‚   â””â”€â”€ all_predictions_period_5.tsv       # â­å…¨äºˆæ¸¬çµæœçµ±åˆãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ period_comparison.tsv                   # æœŸé–“æ¯”è¼ƒã‚µãƒãƒªãƒ¼ï¼ˆæœŸé–“æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
â”œâ”€â”€ progress.json                           # é€²æ—ç®¡ç†ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â””â”€â”€ execution.log                           # å®Ÿè¡Œãƒ­ã‚°
```

#### â­ å…¨äºˆæ¸¬çµæœçµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`all_predictions_period_10.tsv`ï¼‰

å„å­¦ç¿’æœŸé–“ã”ã¨ã«ã€å…¨ãƒ¢ãƒ‡ãƒ«ãƒ»å…¨å¹´ã®ãƒ†ã‚¹ãƒˆçµæœã‚’1ã¤ã®TSVãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±åˆã—ã¾ã™ã€‚

**ç‰¹å¾´:**
- æœŸé–“ã”ã¨ã®å…¨ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒ1ãƒ•ã‚¡ã‚¤ãƒ«ã«é›†ç´„
- ãƒ¢ãƒ‡ãƒ«åã€å­¦ç¿’æœŸé–“ã€ãƒ†ã‚¹ãƒˆå¹´ã®è­˜åˆ¥åˆ—ã‚’è‡ªå‹•è¿½åŠ 
- Excelã§é–‹ã‘ã°ç°¡å˜ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»é›†è¨ˆå¯èƒ½

**åˆ—æ§‹æˆ:**
```
ãƒ¢ãƒ‡ãƒ«å | å­¦ç¿’æœŸé–“ | ãƒ†ã‚¹ãƒˆå¹´ | ç«¶é¦¬å ´ | é–‹å‚¬å¹´ | é–‹å‚¬æ—¥ | ... (å…ƒã®äºˆæ¸¬çµæœåˆ—)
```

**ä½¿ç”¨ä¾‹:**
```python
import pandas as pd

# çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
df = pd.read_csv('walk_forward_results/period_10/all_predictions_period_10.tsv', 
                 sep='\t', encoding='utf-8')

# ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
tokyo_turf = df[df['ãƒ¢ãƒ‡ãƒ«å'] == 'tokyo_turf_3ageup_long']

# ç‰¹å®šå¹´ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
y2023 = df[df['ãƒ†ã‚¹ãƒˆå¹´'] == '2023']

# çš„ä¸­ç‡è¨ˆç®—
accuracy = (df['äºˆæ¸¬é †ä½'] == 1).sum() / len(df)
```

### ğŸ“ˆ ã‚µãƒãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®è¦‹æ–¹

#### å˜ä¸€æœŸé–“ã‚µãƒãƒªãƒ¼ï¼ˆ`summary_period_10.tsv`ï¼‰

| ãƒ¢ãƒ‡ãƒ«å | å­¦ç¿’æœŸé–“ | ãƒ†ã‚¹ãƒˆå¹´ | ãƒ¬ãƒ¼ã‚¹æ•° | è³¼å…¥æ¨å¥¨é¦¬æ•° | å˜å‹çš„ä¸­ç‡ | å˜å‹å›åç‡ | è¤‡å‹çš„ä¸­ç‡ | è¤‡å‹å›åç‡ | é¦¬é€£çš„ä¸­ç‡ | é¦¬é€£å›åç‡ | ãƒ¯ã‚¤ãƒ‰çš„ä¸­ç‡ | ãƒ¯ã‚¤ãƒ‰å›åç‡ |
|---------|---------|---------|---------|-------------|-----------|-----------|-----------|-----------|-----------|-----------|------------|------------|
| tokyo_turf_3ageup_long | 2013-2022 | 2023 | 65 | 123 | 23.6% | 77.3% | 65.0% | 93.8% | 16.2% | 69.7% | 36.5% | 95.1% |

**èª­ã¿æ–¹:**
- **è¤‡å‹å›åç‡ãŒ90%ä»¥ä¸Š**: ãƒªã‚¹ã‚¯ã‚’æŠ‘ãˆãªãŒã‚‰é«˜ã„å›åç‡ï¼
- **ãƒ¯ã‚¤ãƒ‰å›åç‡ãŒ95%**: è¤‡æ•°ã®é¦¬ã‚’çµ„ã¿åˆã‚ã›ã‚‹ãƒ¯ã‚¤ãƒ‰é¦¬åˆ¸ãŒæœ‰åŠ¹
- **å˜å‹çš„ä¸­ç‡23.6%**: æœ¬å‘½äºˆæ¸¬ã®ç²¾åº¦ãŒé©åˆ‡

#### æœŸé–“æ¯”è¼ƒã‚µãƒãƒªãƒ¼ï¼ˆ`period_comparison.tsv`ï¼‰

| ãƒ¢ãƒ‡ãƒ«å | å­¦ç¿’æœŸé–“ | å¹³å‡çš„ä¸­ç‡ | å¹³å‡å›åç‡ | æ¨™æº–åå·® | å®‰å®šæ€§ã‚¹ã‚³ã‚¢ |
|---------|---------|-----------|-----------|---------|-------------|
| tokyo_turf_3ageup_long | 5å¹´ | 22.1% | 75.2% | 8.3% | B |
| tokyo_turf_3ageup_long | 7å¹´ | 24.5% | 82.1% | 6.1% | A |
| tokyo_turf_3ageup_long | 10å¹´ | 23.8% | 78.9% | 5.2% | A+ |

**é¸æŠåŸºæº–:**
- **å¹³å‡å›åç‡ãŒé«˜ã„** + **æ¨™æº–åå·®ãŒä½ã„** â†’ å®‰å®šã—ã¦åˆ©ç›Šã‚’å‡ºã›ã‚‹å­¦ç¿’æœŸé–“
- **å®‰å®šæ€§ã‚¹ã‚³ã‚¢Aä»¥ä¸Š** â†’ æ¨å¥¨

### âš™ï¸ è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³è©³ç´°

#### ğŸ“‹ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å®Œå…¨ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

##### **å¿…é ˆè¨­å®šé …ç›®**

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ | æŒ‡å®šå¯èƒ½ãªå€¤ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
|-----------|------|-------------|-------------|
| `execution_mode` | å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ | `"single_period"` / `"compare_periods"` | ãªã—ï¼ˆå¿…é ˆï¼‰ |
| `test_years` | ãƒ†ã‚¹ãƒˆå¯¾è±¡å¹´ï¼ˆé…åˆ—ï¼‰ | `[2023, 2024, 2025]` ãªã© | ãªã—ï¼ˆå¿…é ˆï¼‰ |

##### **å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰åˆ¥è¨­å®š**

###### å˜ä¸€æœŸé–“ãƒ¢ãƒ¼ãƒ‰ï¼ˆ`execution_mode: "single_period"`ï¼‰

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ | æŒ‡å®šå¯èƒ½ãªå€¤ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
|-----------|------|-------------|-------------|
| `single_period_settings.training_period` | å­¦ç¿’æœŸé–“ï¼ˆå¹´æ•°ï¼‰ | æ•´æ•°å€¤ï¼ˆä¾‹: `10`ï¼‰ | ãªã—ï¼ˆå¿…é ˆï¼‰ |
| `single_period_settings.models` | å¯¾è±¡ãƒ¢ãƒ‡ãƒ« | `"all"` / `"standard"` / `"custom"` / é…åˆ— | `"all"` |

**`models`ã®è©³ç´°:**
- `"all"`: æ¨™æº–ãƒ¢ãƒ‡ãƒ«ï¼ˆ24å€‹ï¼‰+ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ï¼ˆ2å€‹ï¼‰= åˆè¨ˆ26ãƒ¢ãƒ‡ãƒ«
- `"standard"`: æ¨™æº–ãƒ¢ãƒ‡ãƒ«ã®ã¿ï¼ˆ24å€‹ï¼‰
- `"custom"`: ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã®ã¿ï¼ˆmodel_configs.jsonã®custom_modelsï¼‰
- é…åˆ—æŒ‡å®š: `["tokyo_turf_3ageup_long", "hanshin_turf_3ageup_long"]` ãªã©

**è¨­å®šä¾‹:**
```json
{
  "execution_mode": "single_period",
  "test_years": [2023, 2024, 2025],
  "single_period_settings": {
    "training_period": 10,
    "models": "standard"
  }
}
```

###### æœŸé–“æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ï¼ˆ`execution_mode: "compare_periods"`ï¼‰

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ | æŒ‡å®šå¯èƒ½ãªå€¤ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
|-----------|------|-------------|-------------|
| `compare_periods_settings.training_periods` | æ¯”è¼ƒã™ã‚‹å­¦ç¿’æœŸé–“ï¼ˆé…åˆ—ï¼‰ | `[5, 7, 10]` ãªã© | ãªã—ï¼ˆå¿…é ˆï¼‰ |
| `compare_periods_settings.models` | å¯¾è±¡ãƒ¢ãƒ‡ãƒ« | `"all"` / `"standard"` / `"custom"` / é…åˆ— | `"all"` |

**è¨­å®šä¾‹:**
```json
{
  "execution_mode": "compare_periods",
  "test_years": [2023, 2024, 2025],
  "compare_periods_settings": {
    "training_periods": [5, 7, 10],
    "models": "standard"
  }
}
```

##### **ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šé …ç›®**

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ | æŒ‡å®šå¯èƒ½ãªå€¤ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
|-----------|------|-------------|-------------|
| `output_dir` | å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | ä»»æ„ã®ãƒ‘ã‚¹ | `"walk_forward_results"` |
| `execution.on_model_error` | ãƒ¢ãƒ‡ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼æ™‚ã®å‹•ä½œ | `"skip"` / `"stop"` / `"retry"` | `"skip"` |
| `execution.on_test_error` | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼æ™‚ã®å‹•ä½œ | `"skip"` / `"stop"` / `"retry"` | `"skip"` |
| `logging.level` | ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« | `"DEBUG"` / `"INFO"` / `"WARNING"` / `"ERROR"` | `"INFO"` |
| `logging.file` | ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å | ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«å | `"execution.log"` |

##### **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è©³ç´°ï¼ˆ`execution`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰**

**`on_model_error` - ãƒ¢ãƒ‡ãƒ«ä½œæˆæ™‚ã®ã‚¨ãƒ©ãƒ¼å¯¾å¿œ:**

| å€¤ | å‹•ä½œ | ä½¿ç”¨å ´é¢ |
|-----|------|----------|
| `"skip"` | ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²ã—ã¦ã‚¹ã‚­ãƒƒãƒ—ã€æ¬¡ã®ãƒ¢ãƒ‡ãƒ«/å¹´ã«é€²ã‚€ | **æ¨å¥¨**: å¤§è¦æ¨¡å®Ÿè¡Œã§ä¸€éƒ¨å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œã—ãŸã„å ´åˆ |
| `"stop"` | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«å…¨å‡¦ç†ã‚’å³åº§ã«åœæ­¢ | ãƒ‡ãƒãƒƒã‚°æ™‚ã€ã‚¨ãƒ©ãƒ¼åŸå› ã‚’ç‰¹å®šã—ãŸã„å ´åˆ |
| `"retry"` | æœ€å¤§3å›ã¾ã§è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ | ä¸€æ™‚çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ç­‰ã®å¯¾å¿œ |

**`on_test_error` - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ã‚¨ãƒ©ãƒ¼å¯¾å¿œ:**

| å€¤ | å‹•ä½œ | ä½¿ç”¨å ´é¢ |
|-----|------|----------|
| `"skip"` | ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²ã—ã¦ã‚¹ã‚­ãƒƒãƒ—ã€æ¬¡ã®ãƒ¢ãƒ‡ãƒ«/å¹´ã«é€²ã‚€ | **æ¨å¥¨**: å¤§è¦æ¨¡å®Ÿè¡Œã§ä¸€éƒ¨å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œã—ãŸã„å ´åˆ |
| `"stop"` | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«å…¨å‡¦ç†ã‚’å³åº§ã«åœæ­¢ | ãƒ‡ãƒãƒƒã‚°æ™‚ã€ã‚¨ãƒ©ãƒ¼åŸå› ã‚’ç‰¹å®šã—ãŸã„å ´åˆ |
| `"retry"` | æœ€å¤§3å›ã¾ã§è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ç­‰ã®å¯¾å¿œ |

**è¨­å®šä¾‹:**
```json
{
  "execution": {
    "on_model_error": "skip",
    "on_test_error": "skip"
  }
}
```

##### **ãƒ­ã‚°è¨­å®šè©³ç´°ï¼ˆ`logging`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰**

**`level` - ãƒ­ã‚°å‡ºåŠ›ãƒ¬ãƒ™ãƒ«:**

| å€¤ | å‡ºåŠ›å†…å®¹ | ä½¿ç”¨å ´é¢ |
|-----|----------|----------|
| `"DEBUG"` | å…¨ã¦ã®è©³ç´°æƒ…å ±ï¼ˆSQLã€ä¸­é–“ãƒ‡ãƒ¼ã‚¿ç­‰ï¼‰ | ãƒã‚°èª¿æŸ»ã€è©³ç´°ãªå‹•ä½œç¢ºèª |
| `"INFO"` | å®Ÿè¡ŒçŠ¶æ³ã€é€²æ—ã€çµæœã‚µãƒãƒªãƒ¼ | **æ¨å¥¨**: é€šå¸¸å®Ÿè¡Œ |
| `"WARNING"` | è­¦å‘Šã¨ã‚¨ãƒ©ãƒ¼ã®ã¿ | é™ã‹ã«å®Ÿè¡Œã—ãŸã„å ´åˆ |
| `"ERROR"` | ã‚¨ãƒ©ãƒ¼ã®ã¿ | æœ¬ç•ªç’°å¢ƒã€ã‚¨ãƒ©ãƒ¼ç›£è¦–ã®ã¿ |

**`file` - ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›å…ˆ:**
- æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«åã§`output_dir`å†…ã«ä¿å­˜
- ä¾‹: `"execution.log"` â†’ `walk_forward_results/execution.log`

**è¨­å®šä¾‹:**
```json
{
  "logging": {
    "level": "INFO",
    "file": "execution.log"
  }
}
```

##### **å®Œå…¨ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¾‹**

```json
{
  "execution_mode": "single_period",
  "test_years": [2023, 2024, 2025],
  "single_period_settings": {
    "training_period": 10,
    "models": "all"
  },
  "output_dir": "walk_forward_results",
  "execution": {
    "on_model_error": "skip",
    "on_test_error": "skip"
  },
  "logging": {
    "level": "INFO",
    "file": "execution.log"
  }
}
```

### ğŸ’¡ ä½¿ç”¨ã‚·ãƒ¼ãƒ³

#### ã‚·ãƒ¼ãƒ³1: å°è¦æ¨¡ãƒ†ã‚¹ãƒˆï¼ˆ1ãƒ¢ãƒ‡ãƒ«ã€1å¹´ï¼‰

```json
{
  "execution_mode": "single_period",
  "test_years": [2023],
  "training_period": 10,
  "models": ["tokyo_turf_3ageup_long"],
  "output_dir": "walk_forward_results_test"
}
```

**å®Ÿè¡Œæ™‚é–“**: ç´„5åˆ†  
**ç”¨é€”**: å‹•ä½œç¢ºèªã€è¨­å®šãƒ†ã‚¹ãƒˆ

#### ã‚·ãƒ¼ãƒ³2: æœ¬ç•ªè¦æ¨¡ãƒ†ã‚¹ãƒˆï¼ˆå…¨26ãƒ¢ãƒ‡ãƒ«ã€3å¹´é–“ï¼‰

```json
{
  "execution_mode": "single_period",
  "test_years": [2023, 2024, 2025],
  "training_period": 10,
  "models": "all",
  "output_dir": "walk_forward_results"
}
```

**å®Ÿè¡Œæ™‚é–“**: ç´„21.6æ™‚é–“ï¼ˆ1ãƒ¢ãƒ‡ãƒ«Ã—1å¹´ ç´„15-30åˆ†ï¼‰  
**ç”¨é€”**: æœ¬ç•ªè©•ä¾¡ã€æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ

#### ã‚·ãƒ¼ãƒ³3: æœ€é©å­¦ç¿’æœŸé–“ã®æ±ºå®šï¼ˆæœŸé–“æ¯”è¼ƒï¼‰

```json
{
  "execution_mode": "compare_periods",
  "test_years": [2023, 2024, 2025],
  "training_periods": [5, 7, 10],
  "models": "standard",
  "output_dir": "walk_forward_results"
}
```

**å®Ÿè¡Œæ™‚é–“**: ç´„64.8æ™‚é–“ï¼ˆ24ãƒ¢ãƒ‡ãƒ«Ã—3æœŸé–“Ã—3å¹´ï¼‰  
**ç”¨é€”**: æœ€é©å­¦ç¿’æœŸé–“ã®ç§‘å­¦çš„æ±ºå®š

### ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### å®Ÿè¡ŒãŒé€”ä¸­ã§åœæ­¢ã—ãŸ

```bash
# é€²æ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•å†é–‹
python walk_forward_validation.py --config walk_forward_config.json --resume
```

#### ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ `"on_model_error": "skip"` ã«è¨­å®šã™ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã¦ç¶šè¡Œã—ã¾ã™ã€‚

#### å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸã„

```bash
python walk_forward_validation.py --config walk_forward_config.json --clean
```

### ğŸ“„ è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

è©³ç´°ãªè¨­è¨ˆãƒ»å®Ÿè£…ã«ã¤ã„ã¦ã¯ [walk_forward_validation_design.md](walk_forward_validation_design.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

### 5. å˜ä¸€ãƒ¢ãƒ‡ãƒ«ã®å€‹åˆ¥ä½œæˆ

```python
from model_creator import create_universal_model

create_universal_model(
    track_code='05',           # æ±äº¬ç«¶é¦¬å ´
    kyoso_shubetsu_code='13',  # 3æ­³ä»¥ä¸Š
    surface_type='turf',       # èŠ
    min_distance=1000,         # 1000mä»¥ä¸Š
    max_distance=1600,         # 1600mä»¥ä¸‹
    model_filename='tokyo_turf_short.sav'
)
```

## ğŸŸï¸ ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰

| ã‚³ãƒ¼ãƒ‰ | ç«¶é¦¬å ´ | ã‚³ãƒ¼ãƒ‰ | ç«¶é¦¬å ´ |
|--------|---------|--------|---------|
| 01     | æœ­å¹Œ    | 06     | ä¸­å±±    |
| 02     | å‡½é¤¨    | 07     | ä¸­äº¬    |
| 03     | ç¦å³¶    | 08     | äº¬éƒ½    |
| 04     | æ–°æ½Ÿ    | 09     | é˜ªç¥    |
| 05     | æ±äº¬    | 10     | å°å€‰    |

## ğŸƒ ç«¶äº‰ç¨®åˆ¥ã‚³ãƒ¼ãƒ‰

| ã‚³ãƒ¼ãƒ‰ | ç¨®åˆ¥ |
|--------|------|
| 10     | 2æ­³  |
| 13     | 3æ­³ä»¥ä¸Š |

## ğŸŒ± è·¯é¢ã‚¿ã‚¤ãƒ—

| æŒ‡å®šå€¤ | è·¯é¢ |
|--------|------|
| turf   | èŠ   |
| dirt   | ãƒ€ãƒ¼ãƒˆ |

## ğŸ“Š ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°

### ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ
```
KirisameRaceSimulation2/
â”œâ”€â”€ models/                    # å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«
â”œâ”€â”€ results/                   # ãƒ†ã‚¹ãƒˆçµæœ
â”œâ”€â”€ venv/                     # ä»®æƒ³ç’°å¢ƒï¼ˆ.gitignoreæ¸ˆã¿ï¼‰
â”œâ”€â”€ model_configs.json        # ãƒ¢ãƒ‡ãƒ«è¨­å®š
â””â”€â”€ *.py                      # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```

### ğŸ¯ ãƒ¢ãƒ‡ãƒ«ä½œæˆæ™‚ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«å | å ´æ‰€ | èª¬æ˜ |
|-----------|------|------|
| `{ãƒ¢ãƒ‡ãƒ«å}.sav` | `models/` | å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆpickleå½¢å¼ï¼‰ |

**ä¾‹ï¼š**
```
models/
â”œâ”€â”€ tokyo_turf_3ageup_long.sav    # æ±äº¬èŠä¸­é•·è·é›¢
â”œâ”€â”€ tokyo_turf_3ageup_short.sav   # æ±äº¬èŠçŸ­è·é›¢
â”œâ”€â”€ kyoto_dirt_3age_long.sav      # äº¬éƒ½ãƒ€ãƒ¼ãƒˆä¸­é•·è·é›¢
â””â”€â”€ hanshin_turf_3ageup_long.sav  # é˜ªç¥èŠä¸­é•·è·é›¢
```

### ğŸ“ˆ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«å | èª¬æ˜ | ä¸»ãªå†…å®¹ |
|-----------|------|----------|
| `predicted_results.tsv` | **é€šå¸¸ãƒ¬ãƒ¼ã‚¹çµ±åˆçµæœï¼ˆ38åˆ—ï¼‰** | ã‚¹ã‚³ã‚¢å·®ãŒåŸºæº–å€¤ä»¥ä¸Šã®ãƒ¬ãƒ¼ã‚¹ã®å…¨é¦¬ï¼ˆåˆ†æç”¨åˆ—ãªã—ï¼‰ |
| `predicted_results_skipped.tsv` | **ã‚¹ã‚­ãƒƒãƒ—ãƒ¬ãƒ¼ã‚¹çµ±åˆçµæœï¼ˆ43åˆ—ï¼‰** | ã‚¹ã‚³ã‚¢å·®ãŒåŸºæº–å€¤æœªæº€ã®ãƒ¬ãƒ¼ã‚¹ã®å…¨é¦¬ï¼ˆåˆ†æç”¨åˆ—ã‚ã‚Šï¼‰ |
| `predicted_results_{ãƒ¢ãƒ‡ãƒ«å}.tsv` | å€‹åˆ¥ãƒ¢ãƒ‡ãƒ«è©³ç´°çµæœ | å„ãƒ¢ãƒ‡ãƒ«å˜ä½“ã®äºˆæ¸¬çµæœ |
| `betting_summary_{ãƒ¢ãƒ‡ãƒ«å}.tsv` | çš„ä¸­ç‡ãƒ»å›åç‡ã¾ã¨ã‚ | å˜å‹ãƒ»è¤‡å‹ãƒ»é¦¬é€£ãªã©ã®æˆç¸¾ |
| `model_comparison.tsv` | ãƒ¢ãƒ‡ãƒ«æ€§èƒ½æ¯”è¼ƒè¡¨ | å…¨ãƒ¢ãƒ‡ãƒ«ã®æˆç¸¾ã‚’æ¨ªä¸¦ã³æ¯”è¼ƒ |

### ğŸ“‹ äºˆæ¸¬çµæœãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ—æ§‹æˆ

#### `predicted_results.tsv` (é€šå¸¸ãƒ¬ãƒ¼ã‚¹çµ±åˆçµæœ - 38åˆ—)
| åˆ—å | èª¬æ˜ | ä¾‹ |
|------|------|-----|
| ç«¶é¦¬å ´ | ç«¶é¦¬å ´å | é˜ªç¥ |
| é–‹å‚¬å¹´ | é–‹å‚¬å¹´ | 2023 |
| é–‹å‚¬æ—¥ | é–‹å‚¬æœˆæ—¥ | 1223 |
| ãƒ¬ãƒ¼ã‚¹ç•ªå· | ãƒ¬ãƒ¼ã‚¹ç•ªå· | 11 |
| **èŠãƒ€åŒºåˆ†** | èŠãƒ»ãƒ€ãƒ¼ãƒˆåŒºåˆ† | èŠ / ãƒ€ãƒ¼ãƒˆ |
| é¦¬ç•ª | é¦¬ç•ª | 7 |
| é¦¬å | é¦¬å | ã‚­ã‚¿ã‚µãƒ³ãƒ–ãƒ©ãƒƒã‚¯ |
| å˜å‹ã‚ªãƒƒã‚º | å˜å‹ã‚ªãƒƒã‚º | 2.8 |
| äººæ°—é † | äººæ°—é † | 1 |
| ç¢ºå®šç€é † | å®Ÿéš›ã®ç€é † | 1 |
| äºˆæ¸¬é †ä½ | äºˆæ¸¬é †ä½ | 1 |
| äºˆæ¸¬ã‚¹ã‚³ã‚¢ | äºˆæ¸¬ã‚¹ã‚³ã‚¢(0-1) | 0.85 |

#### `predicted_results_skipped.tsv` (ã‚¹ã‚­ãƒƒãƒ—ãƒ¬ãƒ¼ã‚¹çµ±åˆçµæœ - 43åˆ—)
**é€šå¸¸ãƒ¬ãƒ¼ã‚¹ã®38åˆ—ã«åŠ ãˆã¦ä»¥ä¸‹ã®5åˆ—:**

| åˆ—å | èª¬æ˜ | ä¾‹ |
|------|------|-----|
| ã‚¹ã‚³ã‚¢å·® | 1ä½ã¨2ä½ã®äºˆæ¸¬ã‚¹ã‚³ã‚¢å·® | 0.006 |
| ã‚¹ã‚­ãƒƒãƒ—ç†ç”± | ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸç†ç”± | low_score_diff |
| è³¼å…¥æ¨å¥¨ | è³¼å…¥æ¨å¥¨ãƒ•ãƒ©ã‚° | False |
| è³¼å…¥é¡ | è³¼å…¥é¡ | 0 |
| ç¾åœ¨è³‡é‡‘ | ç¾åœ¨ã®è³‡é‡‘æ®‹é«˜ | 1000000 |

#### `betting_summary_{ãƒ¢ãƒ‡ãƒ«å}.tsv` (çš„ä¸­ç‡ãƒ»å›åç‡)
| åˆ¸ç¨® | çš„ä¸­æ•° | è³¼å…¥æ•° | çš„ä¸­ç‡(%) | æŠ•è³‡é¡ | æ‰•æˆ»é¡ | å›åç‡(%) |
|------|--------|--------|-----------|--------|--------|-----------|
| å˜å‹ | 15 | 65 | 23.08 | 6500 | 9850 | 151.54 |
| è¤‡å‹ | 42 | 65 | 64.62 | 6500 | 6200 | 95.38 |
| é¦¬é€£ | 8 | 65 | 12.31 | 6500 | 5430 | 83.54 |

## ğŸ’¡ ä½¿ç”¨ä¾‹

### ä¾‹1: åœ°æ–¹ç«¶é¦¬å ´ã®çŸ­è·é›¢æˆ¦ãƒ¢ãƒ‡ãƒ«
```python
# å°å€‰ç«¶é¦¬å ´ã®èŠçŸ­è·é›¢ãƒ¢ãƒ‡ãƒ«
create_universal_model(
    track_code='10',
    kyoso_shubetsu_code='13',
    surface_type='turf',
    min_distance=1000,
    max_distance=1400,
    model_filename='kokura_turf_sprint.sav'
)
```

### ä¾‹2: ãƒ€ãƒ¼ãƒˆé•·è·é›¢å°‚é–€ãƒ¢ãƒ‡ãƒ«
```python
# æ±äº¬ç«¶é¦¬å ´ã®ãƒ€ãƒ¼ãƒˆé•·è·é›¢ãƒ¢ãƒ‡ãƒ«
create_universal_model(
    track_code='05',
    kyoso_shubetsu_code='13',
    surface_type='dirt',
    min_distance=2000,
    max_distance=9999,
    model_filename='tokyo_dirt_long.sav'
)
```

### ä¾‹3: 2æ­³æˆ¦å°‚é–€ãƒ¢ãƒ‡ãƒ«
```python
# é˜ªç¥ç«¶é¦¬å ´ã®2æ­³æˆ¦èŠãƒ¢ãƒ‡ãƒ«
create_universal_model(
    track_code='09',
    kyoso_shubetsu_code='10',
    surface_type='turf',
    min_distance=1000,
    max_distance=9999,
    model_filename='hanshin_turf_2age.sav'
)
```

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«æ¡ä»¶ã‚’è¿½åŠ ã—ãŸã„å ´åˆ

**æ–¹æ³•1: JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç·¨é›†ï¼ˆæ¨å¥¨ï¼‰**

`model_configs.json`ã®`custom_models`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æ–°ã—ã„è¨­å®šã‚’è¿½åŠ ï¼š

```json
{
  "custom_models": [
    {
      "track_code": "04",
      "kyoso_shubetsu_code": "13",
      "surface_type": "turf",
      "min_distance": 1000,
      "max_distance": 1600,
      "model_filename": "niigata_turf_3ageup_short.sav",
      "description": "æ–°æ½ŸèŠçŸ­è·é›¢3æ­³ä»¥ä¸Š"
    }
  ]
}
```

**æ–¹æ³•2: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‹•çš„ã«è¿½åŠ **

```python
from model_config_loader import add_custom_model

add_custom_model(
    track_code='04',
    kyoso_shubetsu_code='13',
    surface_type='turf',
    min_distance=1000,
    max_distance=1600,
    model_filename='niigata_turf_3ageup_short.sav',
    description='æ–°æ½ŸèŠçŸ­è·é›¢3æ­³ä»¥ä¸Š'
)
```

### ç«¶é¦¬å ´ã‚„ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ãŸã„å ´åˆ

`keiba_constants.py`ã§ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰ã‚„å„ç¨®å®šæ•°ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™

### ç‰¹å¾´é‡ã‚’å¤‰æ›´ã—ãŸã„å ´åˆ

`model_creator.py`ã®ç‰¹å¾´é‡é¸æŠéƒ¨åˆ†ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ï¼š

```python
X = df.loc[:, [
    "kyori",
    "tenko_code",  
    "babajotai_code",
    # ã“ã“ã«æ–°ã—ã„ç‰¹å¾´é‡ã‚’è¿½åŠ 
]].astype(float)
```

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–: Optunaä½¿ç”¨ï¼ˆ50è©¦è¡Œï¼‰
- æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : LightGBMï¼ˆLambdaRankï¼‰
- æ™‚ç³»åˆ—åˆ†å‰²: 75%è¨“ç·´ç”¨ã€25%ãƒ†ã‚¹ãƒˆç”¨

## ğŸ” çµæœã®è¦‹æ–¹

### çš„ä¸­ç‡ãƒ»å›åç‡
- **çš„ä¸­ç‡**: äºˆæƒ³ãŒå½“ãŸã£ãŸå‰²åˆï¼ˆ%ï¼‰
- **å›åç‡**: æŠ•è³‡ã«å¯¾ã™ã‚‹æ‰•æˆ»ã®å‰²åˆï¼ˆ%ï¼‰
- **å›åç‡100%è¶…**: åˆ©ç›ŠãŒå‡ºã¦ã„ã‚‹çŠ¶æ…‹ ğŸ‰

### äºˆæ¸¬çµæœãƒ•ã‚¡ã‚¤ãƒ«
- TSVå½¢å¼ã§ä¿å­˜ï¼ˆExcelã§é–‹ã‘ã¾ã™ï¼‰
- å„é¦¬ã®äºˆæ¸¬é †ä½ã¨å®Ÿéš›ã®ç€é †ã‚’æ¯”è¼ƒå¯èƒ½
- ã‚ªãƒƒã‚ºæƒ…å ±ã‚‚å«ã¾ã‚Œã¦ã„ã‚‹ã®ã§åæ”¯è¨ˆç®—ãŒã§ãã¾ã™

## âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ğŸ” ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

#### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼
```
psycopg2.OperationalError: could not connect to server
```
**è§£æ±ºæ–¹æ³•ï¼š**
- PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
- `universal_test.py` ã¨ `model_creator.py` ã®DBæ¥ç¶šæƒ…å ±ã‚’ç¢ºèª
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ `keiba` ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

#### 2. ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„
```
âŒ ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« tokyo_turf_3ageup_long.sav ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
```
**è§£æ±ºæ–¹æ³•ï¼š**
- ã¾ãš `python batch_model_creator.py` ã§ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ
- `models/` ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

#### 3. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸è¶³ã‚¨ãƒ©ãƒ¼
```
ModuleNotFoundError: No module named 'lightgbm'
```
**è§£æ±ºæ–¹æ³•ï¼š**
- ä»®æƒ³ç’°å¢ƒãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- `pip install -r requirements.txt` ã‚’å®Ÿè¡Œ

#### 4. ãƒ¡ãƒ¢ãƒªä¸è¶³ãƒ»å‡¦ç†ãŒé‡ã„
**è§£æ±ºæ–¹æ³•ï¼š**
- ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦ãƒ¡ãƒ¢ãƒªã‚’ç¢ºä¿
- ãƒãƒƒãƒå‡¦ç†ã®å ´åˆã¯æ™‚é–“ã‚’ãŠã„ã¦å†å®Ÿè¡Œ
- ã‚ˆã‚Šé«˜æ€§èƒ½ãªãƒã‚·ãƒ³ã§ã®å®Ÿè¡Œã‚’æ¤œè¨

#### 5. ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼
```
PermissionError: [Errno 13] Permission denied
```
**è§£æ±ºæ–¹æ³•ï¼š**
- çµæœãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.tsvï¼‰ãŒExcelãªã©ã§é–‹ã‹ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
- `results/` ãƒ•ã‚©ãƒ«ãƒ€ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ç¢ºèª

### ğŸ§ª ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒãƒ³ãƒ‰

```bash
# è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python universal_test.py multi 2>&1 | tee debug_log.txt

# ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®ã¿ã§å•é¡Œã‚’åˆ‡ã‚Šåˆ†ã‘
python universal_test.py single hanshin_turf_3ageup_long.sav

# Pythonã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
python --version
pip list | grep -E "(lightgbm|pandas|numpy|scikit-learn)"
```

## ğŸ’¾ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶

### æ¨å¥¨ç’°å¢ƒ
- **OS**: Windows 10/11, macOS, Linux
- **Python**: 3.8ä»¥ä¸Šï¼ˆ3.10æ¨å¥¨ï¼‰
- **RAM**: 8GBä»¥ä¸Šï¼ˆ16GBæ¨å¥¨ï¼‰
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: ç©ºãå®¹é‡10GBä»¥ä¸Š
- **PostgreSQL**: 12ä»¥ä¸Š

### å‡¦ç†æ™‚é–“ã®ç›®å®‰
- **ãƒ¢ãƒ‡ãƒ«ä½œæˆ**: 1å€‹ã‚ãŸã‚Š5-15åˆ†ï¼ˆãƒã‚¤ãƒ‘ãƒ©æœ€é©åŒ–å«ã‚€ï¼‰
- **24å€‹ä¸€æ‹¬ä½œæˆ**: 2-6æ™‚é–“
- **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**: 1å€‹ã‚ãŸã‚Š1-3åˆ†
- **å…¨ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆ**: 15-30åˆ†

## ğŸš¨ æ³¨æ„äº‹é …

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š**: PostgreSQLã«ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™
2. **è¨ˆç®—æ™‚é–“**: æœ€é©åŒ–å‡¦ç†ã§æ•°åˆ†ã€œæ•°ååˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
3. **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ãŸã‚ã€8GBä»¥ä¸Šã®RAMæ¨å¥¨
4. **æŠ•è³‡ã¯è‡ªå·±è²¬ä»»**: å®Ÿéš›ã®é¦¬åˆ¸è³¼å…¥ã¯æ…é‡ã«ï¼

## ğŸ“‹ è©³ç´°ã‚³ãƒãƒ³ãƒ‰ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### ğŸ”§ batch_model_creator.py

**æ¦‚è¦**: JSONè¨­å®šã«åŸºã¥ã„ã¦ãƒ¢ãƒ‡ãƒ«ã‚’ä¸€æ‹¬ä½œæˆ

```bash
# æ¨™æº–ãƒ¢ãƒ‡ãƒ«24å€‹ã‚’ä¸€æ‹¬ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2013~2022å¹´ï¼‰
python batch_model_creator.py

# å¹´ç¯„å›²ã‚’æŒ‡å®šã—ã¦æ¨™æº–ãƒ¢ãƒ‡ãƒ«ä½œæˆï¼ˆä¾‹: 2020~2023å¹´ï¼‰
python batch_model_creator.py 2020-2023

# å˜ä¸€å¹´ã§æ¨™æº–ãƒ¢ãƒ‡ãƒ«ä½œæˆï¼ˆä¾‹: 2023å¹´ã®ã¿ï¼‰
python batch_model_creator.py 2023

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã®ã¿ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2013~2022å¹´ï¼‰
python batch_model_creator.py custom

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’å¹´ç¯„å›²æŒ‡å®šã§ä½œæˆ
python batch_model_creator.py custom 2020-2023

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’å˜ä¸€å¹´ã§ä½œæˆ
python batch_model_creator.py custom 2023
```

**å‡¦ç†å†…å®¹:**
- `model_configs.json` ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
- Optunaä½¿ç”¨ã§ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–ï¼ˆ50è©¦è¡Œï¼‰
- `models/` ãƒ•ã‚©ãƒ«ãƒ€ã« `.sav` ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
- **ğŸ†• å¹´ç¯„å›²æŒ‡å®š**: ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®å¹´ç¯„å›²ã‚’æŸ”è»Ÿã«å¤‰æ›´å¯èƒ½

### ğŸ¯ universal_test.py

**æ¦‚è¦**: ä½œæˆæ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ¢ãƒ‡ãƒ«ä¸€æ‹¬ãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2023å¹´ï¼‰
python universal_test.py multi

# å¹´ç¯„å›²ã‚’æŒ‡å®šã—ã¦å…¨ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆä¾‹: 2020~2023å¹´ï¼‰
python universal_test.py multi 2020-2023

# å˜ä¸€å¹´ã§å…¨ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆä¾‹: 2024å¹´ã®ã¿ï¼‰
python universal_test.py multi 2024

# å˜ä¸€ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2023å¹´ï¼‰
python universal_test.py

# å˜ä¸€ãƒ¢ãƒ‡ãƒ«ã‚’å¹´ç¯„å›²æŒ‡å®šã§ãƒ†ã‚¹ãƒˆ
python universal_test.py 2020-2023

# å˜ä¸€ãƒ¢ãƒ‡ãƒ«ã‚’å˜ä¸€å¹´ã§ãƒ†ã‚¹ãƒˆ
python universal_test.py 2024

# ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®ã¿ãƒ†ã‚¹ãƒˆï¼ˆæ³¨æ„: å¹´ç¯„å›²æŒ‡å®šã¯æœªå¯¾å¿œï¼‰
python universal_test.py single hanshin_turf_3ageup_long.sav
```

**å‡¦ç†å†…å®¹:**
- 2023å¹´ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- **ğŸ†• å¹´ç¯„å›²æŒ‡å®š**: ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å¹´ç¯„å›²ã‚’æŸ”è»Ÿã«å¤‰æ›´å¯èƒ½
- çš„ä¸­ç‡ãƒ»å›åç‡è¨ˆç®—
- `results/` ãƒ•ã‚©ãƒ«ãƒ€ã«çµæœä¿å­˜

### ğŸ› ï¸ model_creator.py

**æ¦‚è¦**: å˜ä¸€ãƒ¢ãƒ‡ãƒ«ä½œæˆç”¨é–¢æ•°ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰

```python
from model_creator import create_universal_model

# åŸºæœ¬çš„ãªä½¿ã„æ–¹
create_universal_model(
    track_code='05',           # ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰
    kyoso_shubetsu_code='13',  # ç«¶äº‰ç¨®åˆ¥ã‚³ãƒ¼ãƒ‰
    surface_type='turf',       # è·¯é¢ã‚¿ã‚¤ãƒ—
    min_distance=1700,         # æœ€å°è·é›¢
    max_distance=9999,         # æœ€å¤§è·é›¢
    model_filename='my_model.sav',  # ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å
    year_start=2013,           # å­¦ç¿’ãƒ‡ãƒ¼ã‚¿é–‹å§‹å¹´ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2013ï¼‰
    year_end=2022              # å­¦ç¿’ãƒ‡ãƒ¼ã‚¿çµ‚äº†å¹´ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2022ï¼‰
)

# å¹´ç¯„å›²ã‚’æŒ‡å®šã—ãŸä¾‹
create_universal_model(
    track_code='05',
    kyoso_shubetsu_code='13',
    surface_type='turf',
    min_distance=1700,
    max_distance=9999,
    model_filename='tokyo_turf_2020_2023.sav',
    year_start=2020,           # 2020å¹´ã‹ã‚‰
    year_end=2023              # 2023å¹´ã¾ã§
)
```

### ğŸ“ model_config_loader.py

**æ¦‚è¦**: JSONè¨­å®šç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

```python
from model_config_loader import load_model_configs, add_custom_model

# è¨­å®šèª­ã¿è¾¼ã¿
configs = load_model_configs()

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«è¿½åŠ 
add_custom_model(
    track_code='04',
    kyoso_shubetsu_code='13',
    surface_type='turf',
    min_distance=1000,
    max_distance=1600,
    model_filename='niigata_turf_short.sav',
    description='æ–°æ½ŸèŠçŸ­è·é›¢3æ­³ä»¥ä¸Š'
)
```

### ğŸ—ƒï¸ keiba_constants.py

**æ¦‚è¦**: å…±é€šå®šæ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°

```python
from keiba_constants import get_track_name, get_surface_name, get_kyoso_shubetsu_name

# ç«¶é¦¬å ´åå–å¾—
track_name = get_track_name('05')  # â†’ 'æ±äº¬'

# è·¯é¢åå–å¾—  
surface_name = get_surface_name(1)  # â†’ 'èŠ'

# ç«¶äº‰ç¨®åˆ¥åå–å¾—
kyoso_name = get_kyoso_shubetsu_name('13')  # â†’ '3æ­³ä»¥ä¸Š'
```

## ğŸ¯ å®Ÿè·µçš„ãªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# 1. ç’°å¢ƒæº–å‚™
python -m venv venv
source venv/Scripts/activate
pip install -r requirements.txt

# 2. æ¨™æº–ãƒ¢ãƒ‡ãƒ«ä¸€æ‹¬ä½œæˆï¼ˆæ•°æ™‚é–“ã‹ã‹ã‚Šã¾ã™ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2013~2022å¹´ï¼‰
python batch_model_creator.py

# 3. å…¨ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python universal_test.py multi
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: æ–°ã—ã„ç«¶é¦¬å ´ã‚’è¿½åŠ 
```bash
# 1. model_configs.json ã® custom_models ã«è¨­å®šè¿½åŠ 
# 2. ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ä½œæˆ
python batch_model_creator.py custom

# 3. æ–°ãƒ¢ãƒ‡ãƒ«ã‚‚å«ã‚ã¦ãƒ†ã‚¹ãƒˆ
python universal_test.py multi
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®æ€§èƒ½ç¢ºèª
```bash
# ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®ã¿ãƒ†ã‚¹ãƒˆ
python universal_test.py single tokyo_turf_3ageup_long.sav

# çµæœç¢ºèª
cat results/betting_summary_tokyo_turf_3ageup_long.tsv
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: ğŸ†• å¹´ç¯„å›²ã‚’æŒ‡å®šã—ã¦ãƒ¢ãƒ‡ãƒ«ä½œæˆ&ãƒ†ã‚¹ãƒˆ
```bash
# 2020å¹´~2023å¹´ã®ãƒ‡ãƒ¼ã‚¿ã§ãƒ¢ãƒ‡ãƒ«ä½œæˆ
python batch_model_creator.py 2020-2023

# 2024å¹´ã®ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ
python universal_test.py multi 2024
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³5: ğŸ” é–¾å€¤ã®æœ€é©åŒ–åˆ†æï¼ˆãƒ¢ãƒ‡ãƒ«æ”¹å–„ï¼‰
```bash
# äºˆæ¸¬çµæœã®ã‚¹ã‚³ã‚¢å·®é–¾å€¤ã‚’åˆ†æ
python analyze_threshold.py

# ã‚°ãƒ©ãƒ•ã¨åˆ†æçµæœã‚’ç¢ºèª
# results/score_diff_distribution.png
# results/threshold_optimization.png
```

## ğŸ”¬ åˆ†æãƒ„ãƒ¼ãƒ«è©³ç´°

### ğŸ“Š analyze_threshold.py - é–¾å€¤æœ€é©åŒ–ãƒ„ãƒ¼ãƒ«

**æ¦‚è¦**: 
`universal_test.py`ã§å‡ºåŠ›ã•ã‚Œã‚‹`predicted_results_all.tsv`ã‚’åˆ†æã—ã€äºˆæ¸¬ã‚¹ã‚³ã‚¢å·®ã®é–¾å€¤ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚ç¾åœ¨ã®é–¾å€¤ã§å®Ÿéš›ã«ã©ã‚Œã ã‘çš„ä¸­ã—ã¦ã„ã‚‹ã‹ã€åˆ¥ã®é–¾å€¤ã«ã™ã‚Œã°ã©ã†å¤‰ã‚ã‚‹ã‹ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ã«æ¤œè¨¼ã—ã¾ã™ã€‚

**ä½¿ã„æ–¹:**
```bash
# åŸºæœ¬å®Ÿè¡Œï¼ˆpredicted_results_all.tsvãŒå¿…è¦ï¼‰
python analyze_threshold.py
```

**å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«:**
- `results/predicted_results_all.tsv` - universal_test.pyã®multiå®Ÿè¡Œæ™‚ã«è‡ªå‹•ç”Ÿæˆ

**å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«:**
- `results/score_diff_distribution.png` - ã‚¹ã‚³ã‚¢å·®ã®åˆ†å¸ƒãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
- `results/threshold_optimization.png` - é–¾å€¤ã¨çš„ä¸­ç‡ã®é–¢ä¿‚ã‚°ãƒ©ãƒ•

**åˆ†æå†…å®¹:**
1. **ã‚¹ã‚³ã‚¢å·®ã®åˆ†å¸ƒåˆ†æ**
   - å…¨ãƒ¬ãƒ¼ã‚¹ã®1ä½ã¨2ä½ã®ã‚¹ã‚³ã‚¢å·®ã‚’é›†è¨ˆ
   - å¹³å‡å€¤ã€ä¸­å¤®å€¤ã€æ¨™æº–åå·®ã‚’ç®—å‡º
   - ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã§å¯è¦–åŒ–

2. **é–¾å€¤åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ**
   - 0.00 ~ 0.10ã®ç¯„å›²ã§0.01åˆ»ã¿ã§é–¾å€¤ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
   - å„é–¾å€¤ã§ã®çš„ä¸­ç‡ã€å¯¾è±¡ãƒ¬ãƒ¼ã‚¹æ•°ã€ã‚¹ã‚­ãƒƒãƒ—ç‡ã‚’è¨ˆç®—
   - æœ€é©é–¾å€¤ã‚’è‡ªå‹•ææ¡ˆ

3. **ç¾åœ¨ã®é–¾å€¤è©•ä¾¡**
   - universal_test.pyã§ä½¿ç”¨ä¸­ã®é–¾å€¤ï¼ˆ0.05ï¼‰ã§ã®å®Ÿç¸¾ã‚’ç¢ºèª
   - ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸãƒ¬ãƒ¼ã‚¹æ•°ã¨çš„ä¸­ç‡ã‚’æ¤œè¨¼

**å‡ºåŠ›ä¾‹:**
```
=== ã‚¹ã‚³ã‚¢å·®ã®çµ±è¨ˆæƒ…å ± ===
ãƒ‡ãƒ¼ã‚¿æ•°: 117ãƒ¬ãƒ¼ã‚¹
å¹³å‡: 0.025
ä¸­å¤®å€¤: 0.019
æ¨™æº–åå·®: 0.022
æœ€å°å€¤: 0.000
æœ€å¤§å€¤: 0.097

=== ç¾åœ¨ã®é–¾å€¤ (0.05) ã§ã®çµæœ ===
ã‚¹ã‚­ãƒƒãƒ—ç‡: 84.5% (98/116ãƒ¬ãƒ¼ã‚¹)
æ®‹å­˜ãƒ¬ãƒ¼ã‚¹: 18ãƒ¬ãƒ¼ã‚¹
çš„ä¸­æ•°: 3ãƒ¬ãƒ¼ã‚¹
çš„ä¸­ç‡: 16.7%

=== æœ€é©é–¾å€¤ã®ææ¡ˆ ===
æ¨å¥¨é–¾å€¤: 0.08
äºˆæƒ³çš„ä¸­ç‡: 66.7%
å¯¾è±¡ãƒ¬ãƒ¼ã‚¹æ•°: 3ãƒ¬ãƒ¼ã‚¹
```

**æ´»ç”¨ã‚·ãƒ¼ãƒ³:**
- ãƒ¢ãƒ‡ãƒ«æ”¹å–„å¾Œã®é–¾å€¤å†èª¿æ•´
- çš„ä¸­ç‡ã¨ãƒªã‚¹ã‚¯ã®ãƒãƒ©ãƒ³ã‚¹æœ€é©åŒ–
- ã‚¹ã‚³ã‚¢å·®ã®æ„å‘³ãŒãƒ¢ãƒ‡ãƒ«ç²¾åº¦ã«é©ã—ã¦ã„ã‚‹ã‹æ¤œè¨¼

**æ³¨æ„ç‚¹:**
- ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ç²¾åº¦ãŒä½ã„å ´åˆã€é–¾å€¤ã ã‘ã§ã¯æ ¹æœ¬è§£æ±ºã«ãªã‚‰ãªã„
- å¯¾è±¡ãƒ¬ãƒ¼ã‚¹æ•°ã¨çš„ä¸­ç‡ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ã¾ãš`python universal_test.py multi`ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹ã“ã¨

---

## ğŸ¯ å®Ÿè·µçš„ãªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç¶šãï¼‰

# åŒã˜æœŸé–“ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python universal_test.py multi 2020-2023

# 2023å¹´ã®ã¿ã§ãƒ¢ãƒ‡ãƒ«ä½œæˆ
python batch_model_creator.py 2023

# 2023å¹´ã®ã¿ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python universal_test.py multi 2023

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚‚2020~2023å¹´ã§ä½œæˆ&ãƒ†ã‚¹ãƒˆ
python batch_model_creator.py custom 2020-2023
python universal_test.py multi 2020-2023
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³5: è¤‡æ•°ã®æœŸé–“ã§ãƒ¢ãƒ‡ãƒ«ã‚’æ¯”è¼ƒ
```bash
# 2013~2022å¹´ã®ãƒ¢ãƒ‡ãƒ«ä½œæˆ&ãƒ†ã‚¹ãƒˆ
python batch_model_creator.py 2013-2022
python universal_test.py multi 2023
# â†’ 2023å¹´ãƒ‡ãƒ¼ã‚¿ã§æ¤œè¨¼

# 2020~2023å¹´ã®ãƒ¢ãƒ‡ãƒ«ä½œæˆ&ãƒ†ã‚¹ãƒˆ
python batch_model_creator.py 2020-2023
python universal_test.py multi 2024
# â†’ 2024å¹´ãƒ‡ãƒ¼ã‚¿ã§æ¤œè¨¼ï¼ˆæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ã®æ€§èƒ½ç¢ºèªï¼‰

# çµæœæ¯”è¼ƒ
# â†’ results/model_comparison.tsv ã§æœŸé–“ã”ã¨ã®ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ã‚’æ¯”è¼ƒå¯èƒ½
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³6: éå»ãƒ‡ãƒ¼ã‚¿ã§ã®ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
```bash
# 2013~2019å¹´ã§ãƒ¢ãƒ‡ãƒ«ä½œæˆ
python batch_model_creator.py 2013-2019

# 2020~2022å¹´ã§ãƒ†ã‚¹ãƒˆï¼ˆæœªçŸ¥ãƒ‡ãƒ¼ã‚¿ã§ã®æ€§èƒ½è©•ä¾¡ï¼‰
python universal_test.py multi 2020-2022
```

## ğŸ”¬ SHAPåˆ†ææ©Ÿèƒ½

### SHAPåˆ†æã¨ã¯ï¼Ÿ
SHAP (SHapley Additive exPlanations) ã¯ã€æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ç†ç”±ã‚’æ•°å€¤åŒ–ãƒ»å¯è¦–åŒ–ã™ã‚‹æŠ€è¡“ã§ã™ã€‚
å„ç‰¹å¾´é‡ãŒã©ã‚Œã ã‘äºˆæ¸¬ã«è²¢çŒ®ã—ãŸã‹ã‚’å®šé‡çš„ã«è©•ä¾¡ã§ãã¾ã™ã€‚

---

### ğŸ› ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

SHAPåˆ†æãƒ„ãƒ¼ãƒ«ã¯ `db_config.json` ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¾ã™ã€‚

**`db_config.json` ã‚’ä½œæˆ:**
```json
{
  "database": {
    "host": "localhost",
    "port": 5432,
    "user": "your_username",
    "password": "your_password",
    "dbname": "keiba"
  },
  "shap_analysis": {
    "output_base_dir": "shap_analysis",
    "default_sample_size": 500,
    "default_individual_samples": 5
  }
}
```

**âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„:**
- `db_config.json` ã¯ `.gitignore` ã«å«ã¾ã‚Œã¦ãŠã‚Šã€Gitç®¡ç†å¤–ã§ã™
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã®æ©Ÿå¯†æƒ…å ±ã¯çµ¶å¯¾ã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„

---

### ğŸ“Š åŸºæœ¬çš„ãªä½¿ã„æ–¹

#### 1ã¤ã®ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦SHAPåˆ†æ

```bash
# ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ãƒ»å¹´åº¦ã§SHAPåˆ†æå®Ÿè¡Œ
python model_explainer.py \
  --model models/tokyo_turf_3ageup_long.sav \
  --test-year 2023 \
  --track-code 05 \
  --surface-type turf \
  --min-distance 1700 \
  --max-distance 9999 \
  --kyoso-shubetsu-code 13

# SHAP CSVã®è©³ç´°åˆ†æ
python analyze_shap_results.py \
  --input shap_analysis/tokyo_turf_3ageup_long_importance.csv \
  --model-name tokyo_turf_3ageup_long \
  --output-dir shap_analysis/tokyo_turf_3ageup_long/2023
```

#### ãƒãƒƒãƒåˆ†æï¼ˆè¤‡æ•°ãƒ¢ãƒ‡ãƒ«ä¸€æ‹¬å®Ÿè¡Œï¼‰

```bash
# æ¨™æº–ãƒ¢ãƒ‡ãƒ«ã™ã¹ã¦ã«å¯¾ã—ã¦2023å¹´ã®SHAPåˆ†æ
python batch_shap_analyzer.py --models standard --year 2023

# ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã™ã¹ã¦ã«å¯¾ã—ã¦2024å¹´ã®SHAPåˆ†æ
python batch_shap_analyzer.py --models custom --year 2024

# ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦å®Ÿè¡Œ
python batch_shap_analyzer.py --models all --year 2023

# ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã®ã¿å®Ÿè¡Œï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
python batch_shap_analyzer.py \
  --model-names tokyo_turf_3ageup_long,hanshin_turf_3ageup_short \
  --year 2023

# è©³ç´°ãƒ­ã‚°ã‚’éè¡¨ç¤ºã«ã™ã‚‹
python batch_shap_analyzer.py --models standard --year 2023 --quiet
```

#### å¹´åº¦é–“æ¯”è¼ƒåˆ†æ

```bash
# ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®2021-2023å¹´ã‚’æ¯”è¼ƒ
python compare_years_shap.py \
  --model tokyo_turf_3ageup_long \
  --years 2021 2022 2023

# é˜ªç¥ãƒ€ãƒ¼ãƒˆçŸ­è·é›¢ã®2022-2024å¹´ã‚’æ¯”è¼ƒ
python compare_years_shap.py \
  --model hanshin_dirt_3ageup_short \
  --years 2022 2023 2024

# å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
python compare_years_shap.py \
  --model tokyo_turf_3ageup_long \
  --years 2021 2022 2023 \
  --output shap_year_comparison

# è¡¨ç¤ºã™ã‚‹ä¸Šä½ç‰¹å¾´é‡æ•°ã‚’å¤‰æ›´
python compare_years_shap.py \
  --model tokyo_turf_3ageup_long \
  --years 2021 2022 2023 \
  --top-n 30
```

---

### ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

#### å€‹åˆ¥ãƒ¢ãƒ‡ãƒ«åˆ†æçµæœ
```
shap_analysis/
â”œâ”€â”€ {model_name}_importance.csv          # SHAPé‡è¦åº¦CSV
â””â”€â”€ {model_name}/
    â””â”€â”€ {year}/
        â”œâ”€â”€ {model_name}_analysis_report.md    # è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
        â”œâ”€â”€ detailed_analysis.png              # è©³ç´°åˆ†æãƒ—ãƒ­ãƒƒãƒˆ
        â””â”€â”€ pareto_chart.png                   # ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³
```

#### å¹´åº¦é–“æ¯”è¼ƒçµæœ
```
shap_analysis/
â””â”€â”€ {model_name}/
    â””â”€â”€ year_comparison/
        â”œâ”€â”€ {model_name}_year_comparison_report.md     # æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ
        â”œâ”€â”€ {model_name}_year_comparison_bars.png      # å¹´åº¦åˆ¥æ£’ã‚°ãƒ©ãƒ•
        â”œâ”€â”€ {model_name}_year_correlation_heatmap.png  # ç›¸é–¢ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
        â””â”€â”€ {model_name}_year_trend.png                # æ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰
```

---

### ğŸ¯ åˆ†æçµæœã®è¦‹æ–¹

#### é‡è¦åº¦ã®è§£é‡ˆ
- **SHAPå€¤ãŒé«˜ã„ç‰¹å¾´é‡**: ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ã«å¤§ããè²¢çŒ®
- **SHAPå€¤ãŒä½ã„ç‰¹å¾´é‡**: ãƒ¢ãƒ‡ãƒ«ã«ã»ã¨ã‚“ã©ä½¿ã‚ã‚Œã¦ã„ãªã„ï¼ˆå‰Šé™¤å€™è£œï¼‰

#### å¹´åº¦é–“æ¯”è¼ƒã®æ´»ç”¨
1. **ç›¸é–¢ä¿‚æ•°ï¼ˆSpearman Ïï¼‰**:
   - `0.9ä»¥ä¸Š`: å¹´åº¦é–“ã§ã»ã¼åŒã˜ç‰¹å¾´é‡ãŒé‡è¦ï¼ˆãƒ¢ãƒ‡ãƒ«å®‰å®šï¼‰
   - `0.7-0.9`: ä¸­ç¨‹åº¦ã®ä¸€è²«æ€§
   - `0.7æœªæº€`: å¹´åº¦ã«ã‚ˆã‚Šé‡è¦ç‰¹å¾´é‡ãŒå¤§ããå¤‰åŒ–ï¼ˆè¦æ³¨æ„ï¼‰

2. **ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ**:
   - é‡è¦åº¦ãŒå¹´ã€…ä¸Šæ˜‡: ãã®ç‰¹å¾´é‡ã®å½±éŸ¿åŠ›ãŒå¢—åŠ å‚¾å‘
   - é‡è¦åº¦ãŒå¹´ã€…ä¸‹é™: ãã®ç‰¹å¾´é‡ã®å½±éŸ¿åŠ›ãŒæ¸›å°‘å‚¾å‘

---

### ğŸš€ å®Ÿç”¨çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾‹

#### ã‚·ãƒŠãƒªã‚ª1: æ–°ãƒ¢ãƒ‡ãƒ«ã®ç‰¹å¾´é‡åˆ†æ

```bash
# 1. ãƒ¢ãƒ‡ãƒ«ä½œæˆ
python model_creator.py

# 2. SHAPåˆ†æå®Ÿè¡Œ
python batch_shap_analyzer.py --models standard --year 2023

# 3. çµæœç¢ºèª
cat shap_analysis/tokyo_turf_3ageup_long/2023/tokyo_turf_3ageup_long_analysis_report.md
```

#### ã‚·ãƒŠãƒªã‚ª2: ç‰¹å¾´é‡ã®çµŒå¹´å¤‰åŒ–ã‚’è¿½è·¡

```bash
# 1. è¤‡æ•°å¹´åº¦ã®SHAPåˆ†æï¼ˆæœªå®Ÿæ–½ã®å ´åˆï¼‰
python batch_shap_analyzer.py --models standard --year 2021
python batch_shap_analyzer.py --models standard --year 2022
python batch_shap_analyzer.py --models standard --year 2023

# 2. å¹´åº¦é–“æ¯”è¼ƒå®Ÿè¡Œ
python compare_years_shap.py \
  --model tokyo_turf_3ageup_long \
  --years 2021 2022 2023

# 3. ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ—ãƒ­ãƒƒãƒˆç¢ºèª
open shap_analysis/tokyo_turf_3ageup_long/year_comparison/tokyo_turf_3ageup_long_year_trend.png
```

#### ã‚·ãƒŠãƒªã‚ª3: ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®æ·±å €ã‚Šåˆ†æ

```bash
# 1. æœ€æ–°å¹´åº¦ã®SHAPåˆ†æ
python model_explainer.py \
  --model models/hanshin_turf_3ageup_short.sav \
  --test-year 2024 \
  --track-code 04 \
  --surface-type turf \
  --min-distance 1000 \
  --max-distance 1600 \
  --kyoso-shubetsu-code 13

# 2. è©³ç´°çµ±è¨ˆåˆ†æ
python analyze_shap_results.py \
  --input shap_analysis/hanshin_turf_3ageup_short_importance.csv \
  --model-name hanshin_turf_3ageup_short \
  --output-dir shap_analysis/hanshin_turf_3ageup_short/2024

# 3. ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª
cat shap_analysis/hanshin_turf_3ageup_short/2024/hanshin_turf_3ageup_short_analysis_report.md
```

---

### ğŸ“š SHAPåˆ†æçµæœã‚µãƒ³ãƒ—ãƒ«

**æœ€é‡è¦ç‰¹å¾´é‡ï¼ˆtop5ï¼‰:**
1. `past_avg_sotai_chakujun` (0.211) - éå»å¹³å‡ç›¸å¯¾ç€é †
2. `time_index` (0.165) - ã‚¿ã‚¤ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
3. `past_score` (0.132) - éå»ã‚¹ã‚³ã‚¢
4. `umaban_kyori_interaction` (0.127) - é¦¬ç•ªÃ—è·é›¢ã®ç›¸äº’ä½œç”¨
5. `kohan_3f_index` (0.113) - å¾ŒåŠ3Fã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

**å‰Šé™¤å€™è£œç‰¹å¾´é‡ï¼ˆSHAP < 0.005ï¼‰:**
- `barei_peak_short`, `barei_peak_distance`, `baba_condition_score`
- `futan_juryo`, `distance_change_adaptability`, `wakuban_bias_score`

---

## ğŸ“ˆ LightGBM Gain vs SHAP ç›¸é–¢åˆ†æ

### 2ã¤ã®æŒ‡æ¨™ã®é•ã„

ãƒ¢ãƒ‡ãƒ«ã®ç‰¹å¾´é‡é‡è¦åº¦ã‚’æ¸¬ã‚‹2ã¤ã®ç•°ãªã‚‹æŒ‡æ¨™ãŒã‚ã‚Šã€ãã‚Œãã‚Œé•ã†å´é¢ã‚’è©•ä¾¡ã—ã¾ã™ï¼š

#### ğŸ”§ LightGBM Gainï¼ˆå†…éƒ¨è©•ä¾¡ï¼‰

**å®šç¾©**: ãƒ¢ãƒ‡ãƒ«å†…éƒ¨ã§ã®åˆ†å²æ”¹å–„é‡ã®åˆè¨ˆ

**ä»•çµ„ã¿:**
- LightGBMãŒæ±ºå®šæœ¨ã‚’ä½œã‚‹ã¨ãã€å„ãƒãƒ¼ãƒ‰ã§ã€Œã©ã®ç‰¹å¾´é‡ã§åˆ†å²ã™ã‚‹ã‹ã€ã‚’æ±ºå®š
- åˆ†å²ã™ã‚‹ã“ã¨ã§**æå¤±é–¢æ•°ãŒã©ã‚Œã ã‘æ¸›ã£ãŸã‹**ï¼ˆ= Gainï¼‰ã‚’è¨ˆç®—
- ãã®ç‰¹å¾´é‡ãŒå…¨æ±ºå®šæœ¨ã§è²¢çŒ®ã—ãŸGainã®åˆè¨ˆå€¤

**ä¾‹:**
```
æ±ºå®šæœ¨ã®åˆ†å²:
â”œâ”€ [past_avg_sotai_chakujun < 0.5] ã§åˆ†å² â†’ æå¤± -100æ¸›å°‘ = Gain +100
â”œâ”€ [umaban_kyori_interaction < 15] ã§åˆ†å² â†’ æå¤± -80æ¸›å°‘ = Gain +80  
â””â”€ [past_avg_sotai_chakujun < 0.7] ã§åˆ†å² â†’ æå¤± -120æ¸›å°‘ = Gain +120

â†’ past_avg_sotai_chakujunã®Total Gain = 100 + 120 = 220
```

**ç‰¹å¾´:**
- âœ… ãƒ¢ãƒ‡ãƒ«ãŒã©ã‚Œã ã‘ä½¿ã£ãŸã‹ã‚’ç¤ºã™
- âœ… è¨ˆç®—ãŒé€Ÿã„ï¼ˆå­¦ç¿’æ™‚ã«è‡ªå‹•è¨ˆç®—ï¼‰
- âŒ å®Ÿéš›ã®äºˆæ¸¬ã¸ã®å½±éŸ¿ã¯ä¸æ˜
- âŒ éå‰°ã«åˆ†å²ã•ã‚Œã¦ã‚‹å¯èƒ½æ€§ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ï¼‰

#### ğŸ¯ SHAPå€¤ï¼ˆå¤–éƒ¨è©•ä¾¡ï¼‰

**å®šç¾©**: äºˆæ¸¬çµæœã¸ã®å®Ÿéš›ã®è²¢çŒ®åº¦ï¼ˆShapleyå€¤ãƒ™ãƒ¼ã‚¹ï¼‰

**ä»•çµ„ã¿:**
- å„ç‰¹å¾´é‡ãŒ**äºˆæ¸¬å€¤ã‚’ã©ã‚Œã ã‘å‹•ã‹ã—ãŸã‹**ã‚’æ¸¬å®š
- ã‚²ãƒ¼ãƒ ç†è«–ã®ã€Œå„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è²¢çŒ®åº¦ã€ã‚’å¿œç”¨
- å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã§è¨ˆç®— â†’ å¹³å‡å€¤ãŒé‡è¦åº¦

**ä¾‹:**
```
äºˆæ¸¬: ãƒ™ãƒ¼ã‚¹äºˆæ¸¬0.3 â†’ æœ€çµ‚äºˆæ¸¬0.8

å„ç‰¹å¾´é‡ã®è²¢çŒ®:
- past_avg_sotai_chakujun: +0.35 (ã‚ã£ã¡ã‚ƒä¸Šã’ãŸï¼)
- umaban_kyori_interaction: +0.15 (ãã“ãã“ä¸Šã’ãŸ)
- futan_per_barei: +0.05 (ã¡ã‚‡ã£ã¨ä¸Šã’ãŸ)
- ãã®ä»–: -0.05 (ã¡ã‚‡ã£ã¨ä¸‹ã’ãŸ)

åˆè¨ˆ: 0.3 + 0.35 + 0.15 + 0.05 - 0.05 = 0.8 âœ…
```

**ç‰¹å¾´:**
- âœ… äºˆæ¸¬ã¸ã®å®Ÿéš›ã®å½±éŸ¿ã‚’æ¸¬å®š
- âœ… ç†è«–çš„ã«å®Œå…¨ï¼ˆShapleyå€¤ã®å…¬å¹³æ€§ä¿è¨¼ï¼‰
- âœ… ç‰¹å¾´é‡é–“ã®ç›¸äº’ä½œç”¨ã‚‚è€ƒæ…®
- âŒ è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ï¼ˆäº‹å¾Œåˆ†æï¼‰

---

### ç›¸é–¢åˆ†æã®èª­ã¿æ–¹

#### ç›¸é–¢ä¿‚æ•°ã®æ„å‘³

**ä¾‹: tokyo_turf_3ageup_long.sav ã®çµæœ = 0.9518**

| ç›¸é–¢ä¿‚æ•° | è©•ä¾¡ | æ„å‘³ |
|----------|------|------|
| **0.95ä»¥ä¸Š** | âœ… å„ªç§€ | ãƒ¢ãƒ‡ãƒ«ãŒåŠ¹ç‡çš„ã«å­¦ç¿’ã—ã¦ã„ã‚‹ |
| 0.8~0.95 | âš ï¸ ã¾ã‚ã¾ã‚ | ä¸€éƒ¨ã«ç„¡é§„ãªåˆ†å²ãŒã‚ã‚‹ |
| 0.8æœªæº€ | âŒ è¦æ³¨æ„ | GainãŒé«˜ã„ã‘ã©å½¹ã«ç«‹ã£ã¦ãªã„ç‰¹å¾´é‡ãŒå¤šã„ |

---

### ä¹–é›¢åˆ†æï¼šãªãœå·®ãŒç”Ÿã¾ã‚Œã‚‹ã®ã‹ï¼Ÿ

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: GainãŒé«˜ã„ã®ã«SHAPãŒä½ã„ = éå‰°ä½¿ç”¨ âš ï¸

**å®Ÿä¾‹ï¼ˆtokyo_turf_3ageup_longãƒ¢ãƒ‡ãƒ«ï¼‰:**

| ç‰¹å¾´é‡ | LightGBM Gain | SHAPå€¤ | æ¯”ç‡ | è©•ä¾¡ |
|--------|---------------|--------|------|------|
| kishu_popularity_score | 583.52 | 0.0122 | 47.93 | âŒ éå‰° |
| futan_percentile | 688.63 | 0.0153 | 44.86 | âŒ éå‰° |
| futan_zscore | 737.70 | 0.0176 | 41.90 | âŒ éå‰° |
| time_index | 1266.99 | 0.0348 | 36.38 | âš ï¸ ã‚„ã‚„éå‰° |

**å•é¡Œç‚¹:**
- ãƒ¢ãƒ‡ãƒ«ãŒç´°ã‹ãåˆ†å²ã—ã™ã â†’ ãƒã‚¤ã‚ºã‚’å­¦ç¿’
- è¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ã®ç„¡é§„
- ã‚ªãƒ¼ãƒãƒ¼ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã®ã‚µã‚¤ãƒ³

**å¯¾ç­–:**
```python
# æœ¨ã®æ·±ã•ã‚’åˆ¶é™
params = {
    'max_depth': 6,  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ-1(ç„¡åˆ¶é™) â†’ 6ã«åˆ¶é™
    'min_data_in_leaf': 30,  # è‘‰ã®æœ€å°ãƒ‡ãƒ¼ã‚¿æ•°ã‚’å¢—ã‚„ã™
}
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: SHAPãŒé«˜ã„ã®ã«GainãŒä½ã„ = åŠ¹ç‡çš„ âœ…

**å®Ÿä¾‹ï¼ˆtokyo_turf_3ageup_longãƒ¢ãƒ‡ãƒ«ï¼‰:**

| ç‰¹å¾´é‡ | LightGBM Gain | SHAPå€¤ | æ¯”ç‡ | è©•ä¾¡ |
|--------|---------------|--------|------|------|
| past_avg_sotai_chakujun | 3723.10 | 0.1874 | 19.86 | â­ ç†æƒ³çš„ |
| futan_per_barei | 1232.65 | 0.0625 | 19.72 | â­ ç†æƒ³çš„ |
| umaban_kyori_interaction | 1832.68 | 0.1326 | 13.82 | â­ ç†æƒ³çš„ |

**åˆ©ç‚¹:**
- å°‘ãªã„åˆ†å²ã§å¤§ããªåŠ¹æœ
- ã‚·ãƒ³ãƒ—ãƒ«ã§æ±åŒ–æ€§èƒ½ãŒé«˜ã„
- **ã•ã‚‰ã«å¼·åŒ–ã™ã¹ãç‰¹å¾´é‡ï¼**

**å¼·åŒ–æ¡ˆ:**
```python
# æŒ‡æ•°åŠ é‡å¹³å‡ã§æœ€æ–°ãƒ¬ãƒ¼ã‚¹ã‚’é‡è¦–
weights = [0.5, 0.3, 0.2]  # æœ€æ–°ã€2èµ°å‰ã€3èµ°å‰
past_avg_sotai_chakujun = np.average(past_3_races, weights=weights)

# éç·šå½¢å¤‰æ›ã§ç›¸äº’ä½œç”¨ã‚’å¼·åŒ–
if kyori >= 2400 and umaban >= 13:
    umaban_kyori_interaction *= 1.5  # é•·è·é›¢Ã—å¤–æ ãƒšãƒŠãƒ«ãƒ†ã‚£
elif kyori <= 1800 and umaban <= 3:
    umaban_kyori_interaction *= 0.7  # çŸ­è·é›¢Ã—å†…æ ãƒœãƒ¼ãƒŠã‚¹
```

---

### å®Ÿè·µçš„ãªæ´»ç”¨æ–¹æ³•

#### ã‚¹ãƒ†ãƒƒãƒ—1: SHAPåˆ†æã‚’å®Ÿè¡Œ

```bash
# ãƒ¢ãƒ‡ãƒ«ã®è©³ç´°åˆ†æ
python analyze_shap_results.py
```

**å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«:**
- `shap_analysis_report.md` - è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
- `shap_analysis/detailed_analysis.png` - 4ã¤ã®å¯è¦–åŒ–ã‚°ãƒ©ãƒ•
- `shap_analysis/pareto_chart.png` - ãƒ‘ãƒ¬ãƒ¼ãƒˆå›³

#### ã‚¹ãƒ†ãƒƒãƒ—2: ç›¸é–¢ä¿‚æ•°ã‚’ç¢ºèª

```
ã€LightGBM Gain vs SHAPå€¤ã®ç›¸é–¢ã€‘
ãƒ”ã‚¢ã‚½ãƒ³ç›¸é–¢ä¿‚æ•°: 0.9518
```

- **0.95ä»¥ä¸Š** â†’ å¥å…¨ï¼ãã®ã¾ã¾ç¶™ç¶š
- **0.8~0.95** â†’ ä¸€éƒ¨èª¿æ•´æ¤œè¨
- **0.8æœªæº€** â†’ å¤§å¹…ãªè¦‹ç›´ã—å¿…è¦

#### ã‚¹ãƒ†ãƒƒãƒ—3: ä¹–é›¢ãŒå¤§ãã„ç‰¹å¾´é‡ã‚’ç‰¹å®š

**å‰Šé™¤æ¤œè¨ï¼ˆGainé«˜/SHAPä½ï¼‰:**
```
GainãŒé«˜ã„ã®ã«SHAPãŒä½ã„ç‰¹å¾´é‡(ãƒ¢ãƒ‡ãƒ«ãŒéå‰°ã«ä½¿ç”¨):
  kishu_popularity_score    Gain=583.52  SHAP=0.0122  æ¯”ç‡=47.93
  â†‘ å‰Šé™¤å€™è£œã¾ãŸã¯æœ¨ã®æ·±ã•åˆ¶é™
```

**å¼·åŒ–æ¤œè¨ï¼ˆSHAPé«˜/Gainä½ï¼‰:**
```
SHAPãŒé«˜ã„ã®ã«GainãŒä½ã„ç‰¹å¾´é‡(åŠ¹ç‡çš„ãªç‰¹å¾´é‡):
  past_avg_sotai_chakujun   Gain=3723.10 SHAP=0.1874  æ¯”ç‡=19.86
  â†‘ æŒ‡æ•°åŠ é‡å¹³å‡ãªã©ã€ã•ã‚‰ã«å¼·åŒ–ã™ã¹ã
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: æ”¹å–„ã‚’å®Ÿè£…

1. **éå‰°ä½¿ç”¨ç‰¹å¾´é‡ã®å¯¾ç­–:**
   - æœ¨ã®æ·±ã•åˆ¶é™ï¼ˆ`max_depth`ï¼‰
   - è‘‰ã®æœ€å°ãƒ‡ãƒ¼ã‚¿æ•°å¢—åŠ ï¼ˆ`min_data_in_leaf`ï¼‰
   - ã¾ãŸã¯å‰Šé™¤æ¤œè¨

2. **åŠ¹ç‡çš„ç‰¹å¾´é‡ã®å¼·åŒ–:**
   - æŒ‡æ•°åŠ é‡å¹³å‡
   - éç·šå½¢å¤‰æ›
   - ç›¸äº’ä½œç”¨é …ã®è¿½åŠ 

3. **ãƒ¢ãƒ‡ãƒ«å†å­¦ç¿’:**
   ```bash
   # æ”¹å–„å¾Œã€ãƒ¢ãƒ‡ãƒ«å†ä½œæˆ
   python batch_model_creator.py
   
   # åŠ¹æœæ¤œè¨¼
   python universal_test.py multi
   ```

---

### ã¾ã¨ã‚

| é …ç›® | LightGBM Gain | SHAPå€¤ |
|------|---------------|--------|
| **ä½•ã‚’æ¸¬ã‚‹ï¼Ÿ** | ãƒ¢ãƒ‡ãƒ«ãŒã©ã‚Œã ã‘ä½¿ã£ãŸã‹ | äºˆæ¸¬ã«ã©ã‚Œã ã‘è²¢çŒ®ã—ãŸã‹ |
| **è¦–ç‚¹** | å†…éƒ¨è©•ä¾¡ï¼ˆãƒ¢ãƒ‡ãƒ«è¦–ç‚¹ï¼‰ | å¤–éƒ¨è©•ä¾¡ï¼ˆçµæœè¦–ç‚¹ï¼‰ |
| **è¨ˆç®—é€Ÿåº¦** | é€Ÿã„ï¼ˆå­¦ç¿’æ™‚è‡ªå‹•ï¼‰ | é…ã„ï¼ˆäº‹å¾Œåˆ†æï¼‰ |
| **ç†è«–çš„å®Œå…¨æ€§** | ãªã— | ã‚ã‚Šï¼ˆShapleyå€¤ï¼‰ |
| **å®Ÿç”¨æ€§** | éå­¦ç¿’ã®æ¤œå‡º | ç‰¹å¾´é‡é¸æŠãƒ»å¼·åŒ– |

**ç›¸é–¢0.95ä»¥ä¸Š = å¥å…¨ãªãƒ¢ãƒ‡ãƒ«ï¼** ğŸ‰

---

## ğŸ“Š EWMå®Ÿé¨“ãƒ¬ãƒãƒ¼ãƒˆ

### å®Ÿé¨“æ¦‚è¦
`past_avg_sotai_chakujun`ï¼ˆéå»å¹³å‡ç›¸å¯¾ç€é †ï¼‰ã«EWMï¼ˆæŒ‡æ•°åŠ é‡ç§»å‹•å¹³å‡ï¼‰ã‚’é©ç”¨ã—ã€
å˜ç´”ç§»å‹•å¹³å‡ã¨æ¯”è¼ƒæ¤œè¨¼ã—ã¾ã—ãŸã€‚

### å®Ÿé¨“çµæœã‚µãƒãƒªãƒ¼

| æ‰‹æ³• | span | å˜å‹çš„ä¸­ç‡ | è¤‡å‹çš„ä¸­ç‡ | ä¸‰é€£è¤‡çš„ä¸­ç‡ | è©•ä¾¡ |
|------|------|------------|------------|--------------|------|
| **SQLå¹³å‡** | - | **23.08%** | **49.23%** | **7.69%** | âœ… å®‰å®š |
| EWM | 3 | 18.46% | - | - | âŒ æœ€æ‚ª |
| EWM | 5 | 20.00% | - | - | âŒ æ”¹å–„ä¸è¶³ |
| EWM | 7 | 26.15% | 47.18% | 6.15% | âš ï¸ å˜å‹â†‘è¤‡å‹â†“ |

### çµè«–
**EWMã¯ç«¶é¦¬äºˆæ¸¬ã«ã¯ä¸å‘ã**ã¨åˆ¤æ˜ï¼š
- âœ… å˜å‹äºˆæ¸¬ï¼ˆspan=7ï¼‰: 26.15%ã¨æ”¹å–„
- âŒ è¤‡å‹ãƒ»ä¸‰é€£è¤‡: æ‚ªåŒ–ï¼ˆ47.18% â†’ 49.23%ãŒç†æƒ³ï¼‰
- ğŸ” åŸå› : EWMã®ã€Œæ…£æ€§ã€å•é¡Œ - é¦¬ã®èª¿å­æ€¥é™ä¸‹ã‚’æ¤œå‡ºã—ã¥ã‚‰ã„

**æœ€çµ‚åˆ¤æ–­:** SQLå˜ç´”ç§»å‹•å¹³å‡ã‚’ç¶™ç¶šä½¿ç”¨

è©³ç´°: `shap_analysis_report.md` ã¨å„åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆå‚ç…§

## ğŸ”§ ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„

### SQLç”Ÿæˆã®å…±é€šåŒ–ï¼ˆ2026/01/10å®Ÿè£…ï¼‰

**èƒŒæ™¯:**
- `model_creator.py`ã€`universal_test.py`ã€`model_explainer.py`ã§ç´„700è¡Œã®SQLç”Ÿæˆã‚³ãƒ¼ãƒ‰ãŒé‡è¤‡
- å¾®å¦™ãªå·®ç•°ï¼ˆã‚«ãƒ©ãƒ é †åºã€è¨ˆç®—å¼ï¼‰ã«ã‚ˆã‚Šä¿å®ˆæ€§ãŒä½ä¸‹
- å­¦ç¿’ã¨äºˆæ¸¬ã§ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã®ãƒªã‚¹ã‚¯

**å®Ÿè£…å†…å®¹:**
- **`db_query_builder.py`ã‚’æ–°è¦ä½œæˆ**
  - `build_race_data_query()`é–¢æ•°ã§SQLç”Ÿæˆã‚’ä¸€å…ƒåŒ–
  - `model_creator.py`ã®SQLæ§‹é€ ã‚’ãƒ™ãƒ¼ã‚¹ã«æ¡ç”¨
  - æ‰•ã„æˆ»ã—æƒ…å ±ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¯¾å¿œï¼ˆ`include_payout`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
  - ç«¶é¦¬å ´åCASEæ–‡ã€time_saé‡ã¿ä»˜ã‘ã€past_scoreã‚°ãƒ¬ãƒ¼ãƒ‰ä¿‚æ•°ã‚’å…¨ã¦å«ã‚€

**é©ç”¨çŠ¶æ³:**
- âœ… `model_creator.py` - ç´„210è¡Œå‰Šæ¸›
- âœ… `universal_test.py` - ç´„270è¡Œå‰Šæ¸›
- â­ï¸ `model_explainer.py` - æœªé©ç”¨ï¼ˆç´„200è¡Œå‰Šæ¸›è¦‹è¾¼ã¿ï¼‰

**ä½¿ç”¨ä¾‹:**
```python
from db_query_builder import build_race_data_query

# ãƒ¢ãƒ‡ãƒ«ä½œæˆæ™‚ï¼ˆæ‰•ã„æˆ»ã—æƒ…å ±ä¸è¦ï¼‰
sql = build_race_data_query(
    track_code='05',
    year_start=2013,
    year_end=2022,
    surface_type='turf',
    distance_min=1700,
    distance_max=9999,
    kyoso_shubetsu_code='13',
    include_payout=False
)

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ï¼ˆæ‰•ã„æˆ»ã—æƒ…å ±å¿…è¦ï¼‰
sql = build_race_data_query(
    track_code='05',
    year_start=2023,
    year_end=2023,
    surface_type='turf',
    distance_min=1700,
    distance_max=9999,
    kyoso_shubetsu_code='13',
    include_payout=True  # è¤‡å‹ãƒ»é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ãªã©ã®æ‰•æˆ»æƒ…å ±ã‚’å–å¾—
)
```

**é‡è¦ãªä¿®æ­£ï¼ˆãƒã‚°ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼‰:**
1. **`kakutei_chakujun_numeric`ã®çµ±ä¸€**
   - SQL: `18 - cast(seum.kakutei_chakujun as integer) + 1`ï¼ˆå¤§ãã„ã»ã©è‰¯ã„ç€é †ï¼‰
   - å…¨ã¦ã®è¨ˆç®—å¼ã§çµ±ä¸€ï¼ˆ10ç®‡æ‰€ä¿®æ­£ï¼‰
   - èª¤: `(1 - kakutei_chakujun_numeric / 18.0)` â†’ æ­£: `kakutei_chakujun_numeric / 18.0`

2. **çš„ä¸­åˆ¤å®šã®è‡´å‘½çš„ãƒã‚°ä¿®æ­£**
   - å•é¡Œ: `kakutei_chakujun_numeric`ï¼ˆ18=1ç€ï¼‰ã‚’ãã®ã¾ã¾ã€Œç¢ºå®šç€é †ã€ã¨ã—ã¦åˆ¤å®š
   - çµæœ: 18ç€ã‚’1ç€ã¨èª¤åˆ¤å®š â†’ çš„ä¸­ç‡ã»ã¼0%
   - ä¿®æ­£: `actual_chakujun`åˆ—è¿½åŠ ï¼ˆ`19 - kakutei_chakujun_numeric`ï¼‰ã§å…ƒã®ç€é †ã«æˆ»ã™

**åŠ¹æœ:**
- âœ… ç´„480è¡Œã®ã‚³ãƒ¼ãƒ‰å‰Šæ¸›
- âœ… SQLãƒ­ã‚¸ãƒƒã‚¯ã®ä¸€å…ƒç®¡ç†ã§ä¿å®ˆæ€§å‘ä¸Š
- âœ… å­¦ç¿’ã¨äºˆæ¸¬ã§ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºä¿
- âœ… çš„ä¸­ç‡ãŒæ­£å¸¸ã«ç®—å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£
- âœ… é€Ÿå ±äºˆæ¸¬ç”¨ã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆç›´è¿‘5å¹´ã«çµã‚‹ï¼‰ â­NEW
- âœ… é€Ÿå ±äºˆæ¸¬æ™‚ã®ç‰¹å¾´é‡ä¸æ•´åˆã‚’ä¿®æ­£ â­NEW

## ğŸ‡ é€Ÿå ±äºˆæ¸¬æ©Ÿèƒ½ã«ã¤ã„ã¦ï¼ˆ2026-01-18æ›´æ–°ï¼‰

### é€Ÿå ±äºˆæ¸¬ã®æœ€é©åŒ–

é€Ÿå ±ãƒ‡ãƒ¼ã‚¿ã§ã®äºˆæ¸¬ã‚’é«˜é€ŸåŒ–ãƒ»å®‰å®šåŒ–ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®æ”¹å–„ã‚’å®Ÿæ–½ï¼š

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - éå»ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ç›´è¿‘5å¹´ã«é™å®šï¼ˆå‹•çš„ã«ç¾åœ¨å¹´-5å¹´ã‚’è¨ˆç®—ï¼‰
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·ã‚’å¤§å¹…å‰Šæ¸›
   - ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã‚’æœ€å°åŒ–

2. **ç‰¹å¾´é‡ã®å®Œå…¨å¯¾å¿œ**
   - é€Ÿå ±äºˆæ¸¬ç”¨SQLã«å…¨ç‰¹å¾´é‡ã‚’è¿½åŠ 
   - å­¦ç¿’æ™‚ã¨äºˆæ¸¬æ™‚ã®ç‰¹å¾´é‡ã‚’å®Œå…¨ä¸€è‡´
   - `umaban_percentile`, `futan_zscore`, `futan_percentile` ç­‰ã‚’è¿½åŠ 

3. **ç‰¹å¾´é‡ã®æœ€é©åŒ–**
   - `baba_change_adaptability` å‰Šé™¤ï¼ˆSHAPåˆ†æã§ä½é‡è¦åº¦ã®ãŸã‚ï¼‰
   - `kishu_popularity_score` å‰Šé™¤ï¼ˆé€Ÿå ±æ™‚ã«ã‚ªãƒƒã‚ºæƒ…å ±ãŒä¸å®Œå…¨ãªãŸã‚ï¼‰
   - **ç¾åœ¨ã®ç‰¹å¾´é‡æ•°: 16å€‹**ï¼ˆãƒ™ãƒ¼ã‚¹ï¼‰

4. **æ³¨æ„äº‹é …**
   - âš ï¸ æ—¢å­˜ãƒ¢ãƒ‡ãƒ«ï¼ˆ.savãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¯17å€‹ã®ç‰¹å¾´é‡ã§å­¦ç¿’ã•ã‚Œã¦ã„ã¾ã™
   - âš ï¸ é€Ÿå ±äºˆæ¸¬ã‚’ä½¿ç”¨ã™ã‚‹å‰ã«**å…¨ãƒ¢ãƒ‡ãƒ«ã®å†å­¦ç¿’ãŒå¿…è¦**ã§ã™
   - âš ï¸ ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å…¨ãƒ¢ãƒ‡ãƒ«ã‚’å†ä½œæˆã—ã¦ãã ã•ã„ï¼š
     ```bash
     python batch_model_creator.py
     ```

## ğŸ¯ ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

- [x] SHAPåˆ†æã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦è©•ä¾¡ âœ…
- [x] EWM(æŒ‡æ•°åŠ é‡ç§»å‹•å¹³å‡)ã®æ¤œè¨¼ âœ…
- [x] SQLç”Ÿæˆã®å…±é€šåŒ– âœ…
- [x] é€Ÿå ±äºˆæ¸¬æ©Ÿèƒ½ã®å®Ÿè£… âœ…
- [x] é€Ÿå ±äºˆæ¸¬ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– âœ…
- [x] ç‰¹å¾´é‡ã®é€Ÿå ±äºˆæ¸¬å¯¾å¿œ âœ…
- [x] **ç©´é¦¬äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…ï¼ˆPhase 2ï¼‰** âœ…
- [x] **ç©´é¦¬äºˆæ¸¬ã®æ—¢å­˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ±åˆï¼ˆPhase 2.5ï¼‰** âœ… **NEW!**
- [x] å…¨ç«¶é¦¬å ´å¯¾å¿œã®æ±ç”¨ç©´é¦¬åˆ†é¡å™¨è¨“ç·´ï¼ˆuniversal modelï¼‰
- [x] universal_test.pyç©´é¦¬äºˆæ¸¬çµ±åˆ
- [ ] **Phase 2.5ãƒã‚°ä¿®æ­£ã¨ç²¾åº¦å‘ä¸Š** ğŸš§ **é€²è¡Œä¸­ - URGENT**
- [ ] å±•é–‹è¦å› ç‰¹å¾´é‡ã®ä¿®æ­£ï¼ˆSHAPå€¤0.0å•é¡Œï¼‰â­CRITICAL
- [ ] ãƒ‡ãƒ¼ã‚¿æœŸé–“å»¶é•·ï¼ˆ2013-2023å¹´ã€10å¹´åˆ†ï¼‰â­HIGH
- [ ] TimeSeriesSplitå°å…¥ï¼ˆæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
- [ ] ç«¶é¦¬å ´åˆ¥é–¾å€¤æœ€é©åŒ–ï¼ˆå‡½é¤¨å•é¡Œè§£æ±ºï¼‰
- [ ] batch_model_creator.py --with-upsetå®Ÿè£…
- [ ] walk_forward_validationç©´é¦¬å¯¾å¿œ
- [ ] å…¨ãƒ¢ãƒ‡ãƒ«ã®å†å­¦ç¿’ï¼ˆç‰¹å¾´é‡å¤‰æ›´å¯¾å¿œï¼‰ â­URGENT
- [ ] model_explainer.pyã¸ã®SQLå…±é€šåŒ–é©ç”¨
- [ ] ä½é‡è¦åº¦ç‰¹å¾´é‡ã®å‰Šé™¤ã«ã‚ˆã‚‹ç²¾åº¦å‘ä¸Š
- [ ] é¨æ‰‹ãƒ»èª¿æ•™å¸«æƒ…å ±ã®è¿½åŠ 
- [ ] è¡€çµ±æƒ…å ±ã®çµ„ã¿è¾¼ã¿
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äºˆæ¸¬æ©Ÿèƒ½
- [ ] Web UI ã®ä½œæˆ
- [ ] ã‚¯ãƒ©ã‚¦ãƒ‰å¯¾å¿œ
- [ ] ä»–å¹´åº¦ãƒ‡ãƒ¼ã‚¿ã§ã®è‡ªå‹•æ¤œè¨¼
- [ ] ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ã®å¯è¦–åŒ–æ©Ÿèƒ½

---

## ğŸ§  Universal Ranker ã¨ç©´é¦¬åˆ†é¡å™¨ã®ä»•çµ„ã¿ (NEW!)

### ğŸ“š æ¦‚å¿µã®æ•´ç†

ç«¶é¦¬äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ã¯**2æ®µéšã®ãƒ¢ãƒ‡ãƒ«**ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 1: Rankerï¼ˆé †ä½äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ï¼‰                           â”‚
â”‚  â†’ å‡ºé¦¬è¡¨ã‹ã‚‰ç€é †ã‚’äºˆæ¸¬ï¼ˆLightGBM Rankerï¼‰                   â”‚
â”‚  â†’ ä¾‹: æ±äº¬èŠ3æ­³ä»¥ä¸Šé•·è·é›¢ã€é˜ªç¥ãƒ€ãƒ¼ãƒˆ3æ­³çŸ­è·é›¢ ãªã©         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    äºˆæ¸¬é †ä½ãƒ»ã‚¹ã‚³ã‚¢
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 2: ç©´é¦¬åˆ†é¡å™¨ï¼ˆUpset Classifierï¼‰                     â”‚
â”‚  â†’ Rankerã®äºˆæ¸¬ã‚’ä½¿ã£ã¦ã€Œç©´é¦¬ã«ãªã‚Šãã†ã‹ã€ã‚’åˆ¤å®š            â”‚
â”‚  â†’ å‡ºåŠ›: ç©´é¦¬ç¢ºç‡ï¼ˆ0.0ï½1.0ï¼‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸŒ Universal Ranker ã¨ã¯ï¼Ÿ

**Universal Ranker = å…¨ç«¶é¦¬å ´ãƒ»å…¨èŠãƒ€ãƒ¼ãƒˆãƒ»å…¨å¹´é½¢æ¡ä»¶ã«å¯¾å¿œã™ã‚‹æ±ç”¨é †ä½äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«**

#### å¾“æ¥ã®Rankerã®å•é¡Œç‚¹

```python
# å¾“æ¥: ç«¶é¦¬å ´ãƒ»èŠãƒ€ãƒ¼ãƒˆãƒ»å¹´é½¢ã”ã¨ã«å€‹åˆ¥ãƒ¢ãƒ‡ãƒ«
tokyo_turf_3ageup_long.sav      # æ±äº¬ãƒ»èŠãƒ»3æ­³ä»¥ä¸Šãƒ»é•·è·é›¢
hanshin_dirt_3age_short.sav     # é˜ªç¥ãƒ»ãƒ€ãƒ¼ãƒˆãƒ»3æ­³ãƒ»çŸ­è·é›¢
# ... åˆè¨ˆ24ãƒ¢ãƒ‡ãƒ« + ã‚«ã‚¹ã‚¿ãƒ 2ãƒ¢ãƒ‡ãƒ« = 26å€‹
```

**å•é¡Œç‚¹:**
1. **è¨“ç·´ãƒ‡ãƒ¼ã‚¿ä¸è¶³**: æ±äº¬èŠ3æ­³ä»¥ä¸Šé•·è·é›¢ã®ãƒ¬ãƒ¼ã‚¹ã ã‘ã§ã¯æ•°ãŒå°‘ãªã„
2. **ç©´é¦¬åˆ†é¡å™¨ã®é‡è¤‡**: å„ãƒ¢ãƒ‡ãƒ«ã”ã¨ã«ç©´é¦¬åˆ†é¡å™¨ã‚’ä½œã‚‹ã¨26å€‹å¿…è¦
3. **ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¯**: ç‰¹å®šã®ç«¶é¦¬å ´ã ã‘ã§å­¦ç¿’ã™ã‚‹ã¨éå­¦ç¿’ã—ã‚„ã™ã„
4. **çµ±åˆå›°é›£**: è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ã‚’æ¯”è¼ƒãƒ»çµ±åˆã—ã¥ã‚‰ã„

#### Universal Rankerã®è§£æ±ºç­–

```python
# Universal Ranker: 1ã¤ã®ãƒ¢ãƒ‡ãƒ«ã§å…¨æ¡ä»¶ã‚«ãƒãƒ¼
universal_ranker_all_tracks_all_ages.sav
# â†‘ å…¨10ç«¶é¦¬å ´ Ã— èŠ/ãƒ€ãƒ¼ãƒˆ Ã— å…¨å¹´é½¢ â†’ 1ãƒ¢ãƒ‡ãƒ«
```

**åˆ©ç‚¹:**
1. **å¤§é‡ã®è¨“ç·´ãƒ‡ãƒ¼ã‚¿**: å…¨ç«¶é¦¬å ´ãƒ»å…¨æ¡ä»¶ã®ãƒ¬ãƒ¼ã‚¹ã‚’ä½¿ãˆã‚‹ â†’ æ•°ä¸‡ï½æ•°åä¸‡ãƒ¬ãƒ¼ã‚¹
2. **æ±åŒ–æ€§èƒ½å‘ä¸Š**: å¤šæ§˜ãªãƒ¬ãƒ¼ã‚¹ã§å­¦ç¿’ â†’ ç‰¹å®šæ¡ä»¶ã¸ã®éå­¦ç¿’ã‚’é˜²ã
3. **ç©´é¦¬åˆ†é¡å™¨ã®çµ±ä¸€**: Universal Rankerã®äºˆæ¸¬ã‚’ä½¿ãˆã°ã€ç©´é¦¬åˆ†é¡å™¨ã‚‚1ã¤ã§OK
4. **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®¹æ˜“**: 26ãƒ¢ãƒ‡ãƒ« â†’ 1ãƒ¢ãƒ‡ãƒ«ã«é›†ç´„

#### è¨­å®šæ–¹æ³•ï¼ˆ`model_configs.json`ï¼‰

```json
{
  "upset_classifier_models": [
    {
      "model_name": "universal_ranker_all_tracks_all_ages",
      "track_code": null,              // â† null = å…¨ç«¶é¦¬å ´
      "surface_type": null,            // â† null = èŠ/ãƒ€ãƒ¼ãƒˆä¸¡æ–¹
      "kyoso_shubetsu_code": null,     // â† null = å…¨å¹´é½¢æ¡ä»¶
      "min_distance": 0,
      "max_distance": 9999,
      "training_start_year": 2013,
      "training_end_year": 2022
    }
  ]
}
```

**SQLã‚¯ã‚¨ãƒªã®å‹•çš„ç”Ÿæˆ:**
```python
# db_query_builder.py ãŒ null ã‚’å‡¦ç†
track_code = None       â†’ WHEREå¥ã« "track_code" æ¡ä»¶ã‚’è¿½åŠ ã—ãªã„
surface_type = None     â†’ WHEREå¥ã« "èŠ/ãƒ€ãƒ¼ãƒˆ" æ¡ä»¶ã‚’è¿½åŠ ã—ãªã„
kyoso_shubetsu = None   â†’ WHEREå¥ã« "å¹´é½¢æ¡ä»¶" æ¡ä»¶ã‚’è¿½åŠ ã—ãªã„

# çµæœ: å…¨ãƒ¬ãƒ¼ã‚¹ãŒå¯¾è±¡ã«ãªã‚‹
```

### ğŸ¯ ç©´é¦¬åˆ†é¡å™¨ï¼ˆUpset Classifierï¼‰ã¨ã¯ï¼Ÿ

**ç©´é¦¬åˆ†é¡å™¨ = Rankerã®äºˆæ¸¬ã‚’ä½¿ã£ã¦ã€Œã“ã®é¦¬ã¯å¤§ç©´ã§å¥½èµ°ã—ãã†ã‹ï¼Ÿã€ã‚’åˆ¤å®šã™ã‚‹ãƒ¢ãƒ‡ãƒ«**

#### ç©´é¦¬ã®å®šç¾©

```python
# ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€Œ7ï½12ç•ªäººæ°—ã§3ç€ä»¥å†…ã€ã‚’ç©´é¦¬ã¨å®šç¾©
is_upset = (äººæ°—é †ä½ >= 7) and (äººæ°—é †ä½ <= 12) and (ç€é † <= 3)
```

**ãªãœ7ï½12ç•ªäººæ°—ï¼Ÿ**
- 1ï½6ç•ªäººæ°—: æœ¬å‘½ãƒ»å¯¾æŠ—é¦¬ï¼ˆRankerã§äºˆæ¸¬ã—ã‚„ã™ã„ï¼‰
- 7ï½12ç•ªäººæ°—: ä¸­ç©´ï½å¤§ç©´ï¼ˆã‚ªãƒƒã‚ºå¦™å‘³ã‚ã‚Šã€äºˆæ¸¬å›°é›£ï¼‰
- 13ç•ªäººæ°—ä»¥é™: è¶…å¤§ç©´ï¼ˆç¢ºç‡ä½ã™ãã¦å®Ÿç”¨æ€§ä½ã„ï¼‰

#### äºŒæ®µéšäºˆæ¸¬ã®æµã‚Œ

```python
# Step 1: Universal Rankerã§å…¨é¦¬ã®é †ä½äºˆæ¸¬
ranker_predictions = universal_ranker.predict(race_data)
# â†’ [äºˆæ¸¬é †ä½1ä½: é¦¬A, äºˆæ¸¬é †ä½2ä½: é¦¬B, ...]

# Step 2: ç©´é¦¬åˆ†é¡å™¨ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
upset_features = extract_upset_features(ranker_predictions)
upset_probs = upset_classifier.predict_proba(upset_features)
# â†’ [é¦¬A: 0.03, é¦¬B: 0.42, é¦¬C: 0.78, ...]  # ç©´é¦¬ç¢ºç‡

# Step 3: é–¾å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä¾‹: 0.4ä»¥ä¸Šï¼‰
upset_candidates = [é¦¬ for é¦¬ in å…¨é¦¬ if upset_probs[é¦¬] >= 0.4]
# â†’ [é¦¬C, é¦¬D]  # ç©´é¦¬å€™è£œ
```

#### è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆæ–¹æ³•

```bash
# 1. Universal Rankerã§éå»ãƒ¬ãƒ¼ã‚¹ã®äºˆæ¸¬ã‚’ç”Ÿæˆ
python analyze_upset_patterns.py --all-tracks
```

**å†…éƒ¨å‡¦ç†:**
```python
# éå»10å¹´ã®å…¨ãƒ¬ãƒ¼ã‚¹ï¼ˆ2013-2022å¹´ï¼‰ã‚’å¯¾è±¡
for race in all_races:
    # Universal Rankerã§äºˆæ¸¬
    predictions = universal_ranker.predict(race)
    
    # å®Ÿéš›ã®çµæœã¨æ¯”è¼ƒ
    for horse in race.horses:
        features = {
            'äºˆæ¸¬é †ä½': predictions[horse.id],
            'äºˆæ¸¬ã‚¹ã‚³ã‚¢': scores[horse.id],
            'äººæ°—é †ä½': horse.popularity,
            'ã‚ªãƒƒã‚º': horse.odds,
            'æ ç•ª': horse.frame_number,
            'æ¨å®šè„šè³ª': estimate_running_style(horse),
            # ... ä»–ã®ç‰¹å¾´é‡
        }
        
        # ãƒ©ãƒ™ãƒ«: å®Ÿéš›ã«ç©´é¦¬ã ã£ãŸã‹ï¼Ÿ
        label = 1 if is_upset(horse) else 0
        
        training_data.append((features, label))
```

**å‡ºåŠ›ä¾‹:**
```
results/upset_training_data_universal.tsv
â†’ 485,272ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆå…¨é¦¬ï¼‰
  ã†ã¡ç©´é¦¬: 4,327é ­ï¼ˆç´„0.89%ï¼‰â† æ¥µç«¯ãªä¸å‡è¡¡ï¼
```

#### ã‚¯ãƒ©ã‚¹ä¸å‡è¡¡å•é¡Œã®å¯¾å‡¦

```python
# SMOTEï¼ˆSynthetic Minority Over-sampling Techniqueï¼‰
from imblearn.over_sampling import SMOTE

# è¨“ç·´å‰: ç©´é¦¬ 4,327é ­ vs é€šå¸¸é¦¬ 480,945é ­ï¼ˆ1:111ï¼‰
X_resampled, y_resampled = SMOTE().fit_resample(X_train, y_train)
# è¨“ç·´å¾Œ: ç©´é¦¬ 480,945é ­ vs é€šå¸¸é¦¬ 480,945é ­ï¼ˆ1:1ï¼‰â† ãƒãƒ©ãƒ³ã‚¹
```

**SMOTE ã®ä»•çµ„ã¿:**
- å°‘æ•°ã‚¯ãƒ©ã‚¹ï¼ˆç©´é¦¬ï¼‰ã®è¿‘å‚ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰åˆæˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã®ã§ã¯ãªãã€ç‰¹å¾´é‡ç©ºé–“ã§è£œé–“

#### è¨“ç·´ã¨è©•ä¾¡

```bash
# 2. ç©´é¦¬åˆ†é¡å™¨ã®è¨“ç·´ï¼ˆTimeSeriesSplitæ¨å¥¨ï¼‰
python upset_classifier_creator.py --timeseries-cv
```

**CVçµæœä¾‹:**
```
=== TimeSeriesSplit Cross-Validation ===
Fold 1: Precision=0.0512, Recall=0.6234, F1=0.0946, AUC=0.8234
Fold 2: Precision=0.0498, Recall=0.6187, F1=0.0921, AUC=0.8156
Fold 3: Precision=0.0521, Recall=0.6301, F1=0.0964, AUC=0.8289
Fold 4: Precision=0.0505, Recall=0.6245, F1=0.0934, AUC=0.8201
Fold 5: Precision=0.0489, Recall=0.6098, F1=0.0905, AUC=0.8112

å¹³å‡: Precision=0.0505, Recall=0.6213, F1=0.0934, AUC=0.8198
```

**æŒ‡æ¨™ã®æ„å‘³:**
- **Precisionï¼ˆé©åˆç‡ï¼‰**: ã€Œç©´é¦¬å€™è£œã€ã¨ã—ãŸé¦¬ã®ã†ã¡ã€å®Ÿéš›ã«å¥½èµ°ã—ãŸå‰²åˆ
  - 5.05% = 100é ­ä¸­5é ­å½“ãŸã‚‹
- **Recallï¼ˆå†ç¾ç‡ï¼‰**: å®Ÿéš›ã®ç©´é¦¬ã®ã†ã¡ã€ã‚·ã‚¹ãƒ†ãƒ ãŒæ¤œå‡ºã§ããŸå‰²åˆ
  - 62.13% = ç©´é¦¬ã®ç´„6å‰²ã‚’ã‚«ãƒãƒ¼
- **AUC**: åˆ†é¡æ€§èƒ½ã®ç·åˆæŒ‡æ¨™ï¼ˆ0.5=ãƒ©ãƒ³ãƒ€ãƒ ã€1.0=å®Œç’§ï¼‰
  - 0.8198 = ã‹ãªã‚Šè‰¯å¥½

#### ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«

```bash
models/
â”œâ”€â”€ upset_classifier_2013-2022_all.sav  # Universal Rankerç”¨ç©´é¦¬åˆ†é¡å™¨
â””â”€â”€ universal_ranker_all_tracks_all_ages.sav  # Universal Rankeræœ¬ä½“
```

### ğŸ”„ Walk-Forward Validation ã§ã®çµ±åˆ

**å¾“æ¥ã®å•é¡Œ:**
- å„ãƒ¢ãƒ‡ãƒ«ï¼ˆ26å€‹ï¼‰ã”ã¨ã«ç©´é¦¬åˆ†é¡å™¨ã‚’ä½œæˆ â†’ 26å€‹ã®åˆ†é¡å™¨
- è¨“ç·´ãƒ‡ãƒ¼ã‚¿ä¸è¶³ â†’ éå­¦ç¿’ãƒªã‚¹ã‚¯
- é‡è¤‡è¨ˆç®— â†’ ç„¡é§„ãªå‡¦ç†æ™‚é–“

**æ”¹å–„å¾Œï¼ˆUniversalçµ±åˆï¼‰:**
```python
# Walk-Forwardå®Ÿè¡Œæ™‚
for training_period in [5, 7, 10]:
    # 1. Universal Rankerã‚’ä½œæˆï¼ˆ1å›ã ã‘ï¼‰
    if not exists('universal_ranker.sav'):
        create_universal_ranker(training_period)
    
    # 2. Universal Rankerã§è¨“ç·´ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆ1å›ã ã‘ï¼‰
    if not exists('upset_training_data.tsv'):
        generate_training_data_with_universal_ranker()
    
    # 3. ç©´é¦¬åˆ†é¡å™¨ã‚’è¨“ç·´ï¼ˆ1å›ã ã‘ï¼‰
    if not exists(f'upset_classifier_{training_period}.sav'):
        train_upset_classifier()
    
    # 4. å€‹åˆ¥ãƒ¢ãƒ‡ãƒ«ï¼ˆ26å€‹ï¼‰ã‚’ä½œæˆ
    for model_config in all_model_configs:
        create_individual_ranker(model_config)
    
    # 5. ãƒ†ã‚¹ãƒˆæ™‚: å€‹åˆ¥Ranker + å…±é€šã®ç©´é¦¬åˆ†é¡å™¨
    for test_year in test_years:
        for model in all_models:
            predictions = model.predict(test_data)
            upset_probs = upset_classifier.predict(predictions)
            # â†‘ åŒã˜ç©´é¦¬åˆ†é¡å™¨ã‚’å…¨ãƒ¢ãƒ‡ãƒ«ã§å…±æœ‰
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- **åŠ¹ç‡åŒ–**: 26å›ã®åˆ†é¡å™¨è¨“ç·´ â†’ 1å›ã®ã¿
- **ãƒ‡ãƒ¼ã‚¿å¢—åŠ **: 1ç«¶é¦¬å ´ã®ãƒ¬ãƒ¼ã‚¹ â†’ å…¨ç«¶é¦¬å ´ã®ãƒ¬ãƒ¼ã‚¹
- **çµ±ä¸€æ€§**: å…¨ãƒ¢ãƒ‡ãƒ«ã§åŒã˜åŸºæº–ã®ç©´é¦¬åˆ¤å®š
- **ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¯å›é¿**: Universal Rankerã®è¨“ç·´ã§å€‹åˆ¥ãƒ¢ãƒ‡ãƒ«ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã‚ãªã„

### ğŸ“ ã¾ã¨ã‚

| é …ç›® | å¾“æ¥ã®æ–¹å¼ | Universalçµ±åˆå¾Œ |
|-----|-----------|----------------|
| **Rankerãƒ¢ãƒ‡ãƒ«æ•°** | 26å€‹ï¼ˆç«¶é¦¬å ´Ã—æ¡ä»¶åˆ¥ï¼‰ | 1å€‹ï¼ˆUniversalï¼‰ + 26å€‹ï¼ˆå€‹åˆ¥ï¼‰ |
| **ç©´é¦¬åˆ†é¡å™¨æ•°** | 26å€‹ï¼ˆå„ãƒ¢ãƒ‡ãƒ«åˆ¥ï¼‰ | 1å€‹ï¼ˆUniversalç”¨ã®ã¿ï¼‰ |
| **è¨“ç·´ãƒ‡ãƒ¼ã‚¿é‡** | å°‘ãªã„ï¼ˆæ¡ä»¶é™å®šï¼‰ | å¤šã„ï¼ˆå…¨æ¡ä»¶çµ±åˆï¼‰ |
| **éå­¦ç¿’ãƒªã‚¹ã‚¯** | é«˜ã„ | ä½ã„ |
| **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§** | ä½ã„ï¼ˆ26ã‚»ãƒƒãƒˆç®¡ç†ï¼‰ | é«˜ã„ï¼ˆ1ã‚»ãƒƒãƒˆç®¡ç†ï¼‰ |
| **ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¯** | æ³¨æ„å¿…è¦ | è‡ªå‹•å›é¿ |

---

## ğŸ† ç©´é¦¬äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ  (NEW!)

**é˜ªç¥ç«¶é¦¬å ´ èŠä¸­é•·è·é›¢ã§å®Ÿç”¨çš„ãªç©´é¦¬ï¼ˆ7-12ç•ªäººæ°—ï¼‰äºˆæ¸¬ã‚’å®Ÿç¾ï¼**

### ğŸ“Š å®Ÿè£…æˆæœ

**Phase 2: äºŒæ®µéšåˆ†é¡ãƒ¢ãƒ‡ãƒ«ï¼ˆé˜ªç¥å°‚ç”¨ï¼‰**
- âœ… **é©åˆç‡ 4.97%** - ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆ2.87%ï¼‰ã®1.7å€
- âœ… **ROI 241.5%** - æŠ•è³‡é¡ã®2.4å€å›åï¼
- âœ… **å¹´é–“ç´„45é ­ã®å€™è£œæŠ½å‡º** - å®Ÿç”¨çš„ãªçµã‚Šè¾¼ã¿
- âœ… **4å¹´é–“ã§æ¤œè¨¼æ¸ˆã¿** (2019, 2021, 2022, 2023)

**Phase 2.5: å…¨10ç«¶é¦¬å ´çµ±åˆãƒ¢ãƒ‡ãƒ«ï¼ˆ2023å¹´ãƒ†ã‚¹ãƒˆçµæœï¼‰**
- âœ… **é˜ªç¥èŠçŸ­è·é›¢**: é©åˆç‡17.14%ã€ROI 562.3% â­æœ€é«˜æ€§èƒ½
- âœ… **é˜ªç¥èŠä¸­é•·è·é›¢**: é©åˆç‡8.70%ã€ROI 363.0%ï¼ˆPhase 2ã®1.75å€å‘ä¸Šï¼‰
- âš ï¸ **æ±äº¬èŠä¸­é•·è·é›¢**: é©åˆç‡6.90%ã€ROI 260.7%ï¼ˆéå‰°æ¤œå‡ºå‚¾å‘ï¼‰
- âŒ **å‡½é¤¨èŠä¸­é•·è·é›¢**: é©åˆç‡0.00%ã€ROI 0.0%ï¼ˆå€™è£œä¸è¶³å•é¡Œï¼‰
- ğŸ“ˆ **è¨“ç·´ãƒ‡ãƒ¼ã‚¿**: 20,201é ­ã€ç©´é¦¬122é ­ï¼ˆPhase 2ã®ç´„9å€ï¼‰
- ğŸ¯ **universal model**: å˜ä¸€ãƒ¢ãƒ‡ãƒ«ã§å…¨10ç«¶é¦¬å ´å¯¾å¿œ

### å¹´åº¦åˆ¥æˆç¸¾ï¼ˆé–¾å€¤0.4æ¨å¥¨ï¼‰

| å¹´ | å€™è£œæ•° | çš„ä¸­æ•° | é©åˆç‡ | ROI |
|---|---|---|---|---|
| 2019 | 33é ­ | 2é ­ | 6.06% | 294.5% |
| 2021 | 54é ­ | 3é ­ | 5.56% | 268.0% |
| 2022 | 46é ­ | 2é ­ | 4.35% | 291.5% |
| 2023 | 48é ­ | 2é ­ | 4.17% | 112.1% |
| **å¹³å‡** | **45é ­** | **2.25é ­** | **4.97%** | **241.5%** |

### ğŸš€ ä½¿ç”¨æ–¹æ³•

**ç¾åœ¨ã®é‹ç”¨æ–¹æ³•ï¼ˆPhase 2ï¼‰:**
```bash
# 1. è¨“ç·´ãƒ‡ãƒ¼ã‚¿ä½œæˆ
python analyze_upset_patterns.py

# 2. åˆ†é¡å™¨ã®è¨“ç·´
python upset_classifier_creator.py

# 3. ç©´é¦¬äºˆæ¸¬å®Ÿè¡Œï¼ˆæ¨å¥¨è¨­å®šï¼‰
python upset_predictor.py --year 2023 --threshold 0.4

# 4. é–¾å€¤æœ€é©åŒ–å®Ÿé¨“
python optimize_upset_threshold.py
```

**Phase 2.5ã®é‹ç”¨æ–¹æ³•ï¼ˆuniversal modelçµ±åˆï¼‰:**
```bash
# 1. å…¨10ç«¶é¦¬å ´çµ±åˆã®è¨“ç·´ãƒ‡ãƒ¼ã‚¿ä½œæˆ
python analyze_upset_patterns.py --all-tracks

# 2. universalç©´é¦¬åˆ†é¡å™¨ã®è¨“ç·´
python upset_classifier_creator.py
# â†’ models/upset_classifier_universal.sav ç”Ÿæˆ

# 3. ç©´é¦¬äºˆæ¸¬çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆcustomãƒ¢ãƒ‡ãƒ«æ¨å¥¨ï¼‰
python universal_test.py --custom 2023
# â†’ predicted_results_*_all.tsv ã«ç©´é¦¬ç¢ºç‡ãƒ»å€™è£œãƒ»å®Ÿéš›ã®ãƒ•ãƒ©ã‚°ä»˜åŠ 

# 4. çµæœåˆ†æ
python analyze_phase25_results.py
```

**æ¬¡æœŸå®Ÿè£…äºˆå®šï¼ˆãƒã‚°ä¿®æ­£ã¨ç²¾åº¦å‘ä¸Šï¼‰:**
```bash
# å±•é–‹è¦å› ä¿®æ­£+ãƒ‡ãƒ¼ã‚¿æœŸé–“å»¶é•·å¾Œã®å†è¨“ç·´
python analyze_upset_patterns.py --all-tracks --years 2013-2023
python upset_classifier_creator.py --timeseries-cv

# ç«¶é¦¬å ´åˆ¥é–¾å€¤æœ€é©åŒ–
python optimize_upset_threshold.py --by-track

# ãƒ¢ãƒ‡ãƒ«ä½œæˆæ™‚ã«ç©´é¦¬åˆ†é¡å™¨ã‚‚åŒæ™‚è¨“ç·´ï¼ˆæœªå®Ÿè£…ï¼‰
python batch_model_creator.py --config custom --with-upset

# Walk-Forwardæ¤œè¨¼ï¼ˆæœªå®Ÿè£…ï¼‰
python walk_forward_validation.py --with-upset
```

### ğŸ“ ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«

- `analyze_upset_patterns.py` - ãƒ‡ãƒ¼ã‚¿åˆ†æ & è¨“ç·´ãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆå…¨10ç«¶é¦¬å ´å¯¾å¿œï¼‰
- `upset_classifier_creator.py` - äºŒå€¤åˆ†é¡å™¨ã®è¨“ç·´ï¼ˆSMOTE + LightGBMï¼‰
- `upset_predictor.py` - äºŒæ®µéšäºˆæ¸¬ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆPhase 2ç”¨ã€é˜ªç¥å°‚ç”¨ï¼‰
- `universal_test.py` - çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆPhase 2.5ã€ç©´é¦¬äºˆæ¸¬çµ±åˆæ¸ˆã¿ï¼‰
- `optimize_upset_threshold.py` - é–¾å€¤æœ€é©åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `analyze_phase25_results.py` - Phase 2.5çµæœè©³ç´°åˆ†æ
- `models/upset_classifier_universal.sav` - è¨“ç·´æ¸ˆã¿æ±ç”¨åˆ†é¡å™¨ï¼ˆ5-fold CVï¼‰
- `results/upset_training_data_universal.tsv` - è¨“ç·´ãƒ‡ãƒ¼ã‚¿ï¼ˆ20,201é ­ï¼‰
- `UPSET_IMPLEMENTATION_GUIDE.md` - è©³ç´°è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### ğŸ”‘ æŠ€è¡“çš„ç‰¹å¾´

1. **äºŒæ®µéšã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**
   - Stage 1: Rankerã§é †ä½äºˆæ¸¬
   - Stage 2: Classifierã§ç©´é¦¬ç¢ºç‡äºˆæ¸¬

2. **ãƒ‡ãƒ¼ã‚¿ä¸å‡è¡¡å¯¾ç­–**
   - SMOTE ã‚ªãƒ¼ãƒãƒ¼ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆ1:207 â†’ 1:1ï¼‰
   - 5-fold Stratified Cross Validation

3. **å±•é–‹è¦å› ã®è€ƒæ…®**
   - æ¨å®šè„šè³ªï¼ˆ4ã‚³ãƒ¼ãƒŠãƒ¼ä½ç½®ã‹ã‚‰ç®—å‡ºï¼‰
   - è·é›¢å¤‰åŒ–ã€å†…å¤–æ ã€å‰èµ°ç€é †å¤‰åŒ–

è©³ç´°ã¯ [UPSET_IMPLEMENTATION_GUIDE.md](UPSET_IMPLEMENTATION_GUIDE.md) ã‚’å‚ç…§ï¼

### ğŸš§ Phase 2.5ã®å•é¡Œç‚¹ã¨æ”¹å–„è¨ˆç”»

**âœ… çµ±åˆå®Œäº†ï¼ˆ2026-01-19ï¼‰:**
- universal_test.pyã«ç©´é¦¬äºˆæ¸¬ã‚’å®Œå…¨çµ±åˆ
- ç€é †äºˆæ¸¬ï¼‹ç©´é¦¬å€™è£œã‚’åŒæ™‚å‡ºåŠ›ï¼ˆ--customã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- å…¨10ç«¶é¦¬å ´å¯¾å¿œã®universal modelè¨“ç·´å®Œäº†
- ã‚µãƒ³ãƒ—ãƒ«æ•°122é ­ï¼ˆPhase 2ã®9å€ï¼‰ã§SMOTEåŠ¹æœå‘ä¸Š

**ğŸ”´ ç™ºè¦‹ã•ã‚ŒãŸè‡´å‘½çš„å•é¡Œï¼ˆ2026-01-19ï¼‰:**

1. **å±•é–‹è¦å› 4ç‰¹å¾´é‡ãŒå®Œå…¨ç„¡åŠ¹åŒ–**
   - `estimated_running_style`, `distance_change`, `avg_4corner_position`, `prev_rank_change`
   - ç‰¹å¾´é‡é‡è¦åº¦ï¼šå…¨ã¦**SHAPå€¤0.0**ï¼ˆå®Œå…¨ã«ä½¿ã‚ã‚Œã¦ã„ãªã„ï¼‰
   - åŸå› ï¼šè¨“ç·´ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆæ™‚ã«add_upset_features()ãŒæ©Ÿèƒ½ã—ã¦ã„ãªã„å¯èƒ½æ€§
   - å½±éŸ¿ï¼šé˜ªç¥çŸ­è·é›¢ã®æˆåŠŸè¦å› ï¼ˆæ ç•ªÃ—å±•é–‹ï¼‰ãŒä»–ç«¶é¦¬å ´ã«é©ç”¨ã•ã‚Œã¦ã„ãªã„

2. **ãƒ‡ãƒ¼ã‚¿æœŸé–“ãŒçŸ­ã„ï¼ˆ4å¹´ã®ã¿ï¼‰**
   - ç¾åœ¨ï¼š2019, 2021, 2022, 2023å¹´ã®4å¹´åˆ†ã®ã¿
   - Phase 1ï¼š2013-2022å¹´ã®10å¹´åˆ†ã§è¨“ç·´
   - å•é¡Œï¼š6å¹´åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ã—ã¦ã„ãªã„
   - å½±éŸ¿ï¼šã‚µãƒ³ãƒ—ãƒ«æ•°122é ­ â†’ å»¶é•·å¾Œ360é ­ï¼ˆç´„3å€ï¼‰ãŒæœŸå¾…å¯èƒ½

**ğŸ“ˆ æ”¹å–„è¨ˆç”»ï¼ˆå„ªå…ˆé †ä½é †ï¼‰:**

| Step | å†…å®¹ | å„ªå…ˆåº¦ | æœŸå¾…åŠ¹æœ | å®Ÿè£…æ™‚é–“ |
|------|------|--------|----------|----------|
| 1 | å±•é–‹è¦å› ç‰¹å¾´é‡ã®ä¿®æ­£ | ğŸ”´ CRITICAL | é©åˆç‡5%â†’7-8% | 2-3æ™‚é–“ |
| 2 | ãƒ‡ãƒ¼ã‚¿æœŸé–“å»¶é•·ï¼ˆ2013-2023ï¼‰ | ğŸ”´ HIGH | ã‚µãƒ³ãƒ—ãƒ«3å€ã€æ±åŒ–æ€§èƒ½å‘ä¸Š | 1æ™‚é–“ |
| 3 | TimeSeriesSplitå°å…¥ | ğŸŸ¡ MEDIUM | æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¯é˜²æ­¢ | 2æ™‚é–“ |
| 4 | é¨æ‰‹æƒ…å ±ç‰¹å¾´é‡è¿½åŠ  | ğŸŸ¡ MEDIUM | é©åˆç‡+1-2% | 3-4æ™‚é–“ |
| 5 | ç«¶é¦¬å ´åˆ¥é–¾å€¤æœ€é©åŒ– | ğŸŸ¢ HIGH | å‡½é¤¨å•é¡Œè§£æ±ºã€ROIæœ€å¤§åŒ– | 2-3æ™‚é–“ |
| 6 | ç¢ºç‡å¸¯åˆ¥æŠ•è³‡æˆ¦ç•¥ | ğŸŸ¢ HIGH | ROI 240%â†’350% | 2-3æ™‚é–“ |
| 7 | Optunaãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ– | ğŸŸ¢ MEDIUM | é©åˆç‡+0.5-1.5% | 4-6æ™‚é–“ |
| 8 | batch_model_creator --with-upset | ğŸŸ¢ LOW | é‹ç”¨è‡ªå‹•åŒ– | 2-3æ—¥ |
| 9 | walk_forward_validationçµ±åˆ | ğŸŸ¢ LOW | æ™‚ç³»åˆ—æ¤œè¨¼ | 4-5æ—¥ |

**ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹æœ€çµ‚æ€§èƒ½:**
- é©åˆç‡ï¼š5% â†’ **10-12%**ï¼ˆ2å€ä»¥ä¸Šå‘ä¸Šï¼‰
- ROIï¼š240% â†’ **400-500%**
- é˜ªç¥çŸ­è·é›¢ï¼š17% â†’ **20-25%**ï¼ˆROI 700%ä»¥ä¸Šç‹™ã„ï¼‰
- å‡½é¤¨å•é¡Œï¼šçš„ä¸­0é ­ â†’ **2-3é ­**ï¼ˆé–¾å€¤0.3ã§è§£æ±ºï¼‰

è©³ç´°ã¯ [UPSET_IMPLEMENTATION_GUIDE.md - Phase 2.5](UPSET_IMPLEMENTATION_GUIDE.md#phase-25-æ—¢å­˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ±åˆè¨ˆç”»ä¸­-) å‚ç…§ã€‚

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆãƒ»ãŠå•ã„åˆã‚ã›

**å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆï¼š**
1. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å…¨æ–‡ã‚’ã‚³ãƒ”ãƒ¼
2. å®Ÿè¡Œã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜éŒ²
3. ç’°å¢ƒæƒ…å ±ï¼ˆOSã€Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã‚’ç¢ºèª
4. GitHubã®Issuesã§å ±å‘Šã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«é€£çµ¡

**é€£çµ¡å…ˆ**: GitHub Issues ã¾ãŸã¯ [ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹]

---

ğŸ”¥ **æ¥½ã—ã„ç«¶é¦¬äºˆæƒ³ãƒ©ã‚¤ãƒ•ã‚’ï¼** ğŸ”¥

ä½•ã‹è³ªå•ãŒã‚ã£ãŸã‚‰æ°—è»½ã«èã„ã¦ã­ã€œâœ¨