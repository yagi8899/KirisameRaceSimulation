# 競馬予測モデル 特徴量一覧

## 📋 概要
このドキュメントでは、競馬予測モデルで使用されている全特徴量を説明します。
特徴量は「基本特徴量」「派生特徴量」「距離適性」「馬場適性」「騎手・調教師」「短距離特化」の6カテゴリに分類されています。

---

## 🏇 基本特徴量（SQLクエリで計算済み）

### 1. **past_score** (過去成績スコア)
- **説明**: 過去3走の着順とレースグレードを掛け合わせたスコア
- **計算方法**: 
  - 着順スコア: 1着=100点、2着=80点、3着=60点...
  - グレード重み: G1=3.0倍、G2=2.0倍、G3=1.5倍、OP=1.0倍
  - 過去3走の合計値
- **範囲**: 0～900 (G1を3連勝した場合が最高)
- **重要度**: ⭐⭐⭐⭐⭐ (最重要)

### 2. **past_avg_sotai_chakujun** (着差考慮相対着順平均)
- **説明**: 過去3走の相対着順を着差で重み付け平均したスコア
- **計算方法**: 
  - 相対着順: (1 - 着順/出走頭数)
  - 着差補正: 1着(×1.00), 0.5秒差以内(×0.85), 1.0秒差(×0.70)...
  - 過去3走の平均値
- **範囲**: 0.0～1.0 (1.0が最高)
- **重要度**: ⭐⭐⭐⭐⭐ (最重要)
- **備考**: Pattern 2の着差係数を採用(0.20-1.00の範囲)

### 3. **time_index** (タイム指数)
- **説明**: 過去3走の平均速度(距離/時間)
- **計算方法**: 距離(m) ÷ 走破タイム(秒) の過去3走平均
- **範囲**: 通常10～20 m/s程度
- **重要度**: ⭐⭐⭐⭐

### 4. **kohan_3f_index** (後半3F指数)
- **説明**: 過去3走の後半3Fタイムと距離別標準値の差
- **計算方法**: 平均後半3Fタイム - 距離別標準タイム
  - 1600m以下: 33.5秒
  - 1601-2000m: 35.0秒
  - 2001-2400m: 36.0秒
  - 2401m以上: 37.0秒
- **範囲**: マイナスが優秀(標準より速い)
- **重要度**: ⭐⭐⭐⭐ (長距離で重要、短距離では重要度低)

---

## 🔧 派生特徴量

### 5. **wakuban_ratio** (枠番比率)
- **説明**: 枠番をレース出走頭数で正規化
- **計算方法**: 枠番 ÷ 最大枠番
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐
- **備考**: 短距離モデルでは削除される(効果薄)

### 6. **futan_per_barei** (斤量/馬齢比)
- **説明**: 斤量を馬齢で割った負担度指標
- **計算方法**: 斤量(kg) ÷ 馬齢(歳)
- **範囲**: 通常10～15程度
- **重要度**: ⭐⭐⭐

### 7. **futan_per_barei_log** (斤量/馬齢比 対数変換)
- **説明**: futan_per_bareiの対数変換版
- **計算方法**: log(futan_per_barei)
- **重要度**: ⭐⭐

### 8. **futan_deviation** (期待斤量との差分)
- **説明**: 実際の斤量と馬齢別期待斤量との差
- **計算方法**: 実斤量 - 馬齢別期待斤量
  - 2歳: 48kg、3歳: 52kg、4歳: 55kg、5-6歳: 57kg
- **範囲**: ±5kg程度
- **重要度**: ⭐⭐

### 9. **umaban_kyori_interaction** (馬番×距離相互作用)
- **説明**: 馬番と距離の相互作用(外枠は距離が長い方が有利)
- **計算方法**: 馬番 × 距離(m) ÷ 1000
- **範囲**: 0～36程度(18番×2000m)
- **重要度**: ⭐⭐⭐

### 10. **umaban_percentile** (馬番パーセンタイル)
- **説明**: 馬番をレース内で正規化(0-1)
- **計算方法**: (馬番 - 1) ÷ (最大馬番 - 1)
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐

### 11. **futan_zscore** (斤量Zスコア)
- **説明**: レース内での斤量の相対的位置(標準化)
- **計算方法**: (斤量 - レース内平均) ÷ レース内標準偏差
- **範囲**: 通常-2.0～+2.0
- **重要度**: ⭐⭐⭐

### 12. **futan_percentile** (斤量パーセンタイル)
- **説明**: レース内での斤量の順位を0-1に正規化
- **計算方法**: レース内での斤量順位を0-1スケールに変換
- **範囲**: 0.0～1.0 (1.0が最重斤量)
- **重要度**: ⭐⭐⭐

---

## 📏 距離適性特徴量

### 13. **past_score_short / past_score_mile / past_score_middle / past_score_long** (距離帯別成績スコア) 🔄
- **説明**: 4つの距離帯での過去5走の平均成績スコア（SQLで計算）
- **距離帯定義**: 
  - `past_score_short`: 1000-1400m（短距離）
  - `past_score_mile`: 1401-1800m（マイル）
  - `past_score_middle`: 1801-2400m（中距離）
  - `past_score_long`: 2401m以上（長距離）
- **計算方法**: 
  - 基本スコア: (1 - 着順/出走頭数)
  - time_sa補正: 1着(×1.00), 0.5秒差以内(×0.85), 1.0秒差(×0.70), 2.0秒差(×0.50), 3.0秒差(×0.30), 3.0秒超(×0.20)
  - 過去5走の該当距離帯のみの平均値
- **範囲**: 0.0～1.0 (該当距離帯の実績がなければNULL)
- **重要度**: ⭐⭐⭐⭐⭐ (SQLで算出、Pythonで統合)
- **備考**: 過去の`distance_category_score`をSQL化して4つに分割

### 14. **similar_distance_score** (距離適性スコア - 重み付け平均版) 🔄
- **説明**: 4つの距離帯別スコアを距離の近さで重み付け平均したスコア（Pythonで計算）
- **計算方法**: 
  - 各距離帯の中心値（短=1200, マイル=1600, 中=2100, 長=2600）から今回距離までの差を計算
  - 重み = 0.8 ^ (距離差 / 200) で距離が近いほど高重み
  - weighted_average(scores, weights)
  - 実績が全くない場合は0.5（中立）
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐⭐⭐
- **例**: 1500mのレースの場合、マイル帯（中心1600）の重みが最大、短距離（1200）が次点、中距離（2100）が三番手
- **備考**: 未経験距離でも周辺距離帯の実績から滑らかに推定可能

---

## 🌿 馬場適性特徴量

### 15. **surface_aptitude_score** (路面適性スコア)
- **説明**: 芝/ダート別の過去10走の成績
- **計算方法**: 同じ路面での過去10走の相対着順平均
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐
- **備考**: 芝短距離モデルでは削除される(効果なし)

### 16. **baba_change_adaptability** (馬場変化対応力)
- **説明**: 馬場状態が変わった時の対応力
- **計算方法**: 前走と異なる馬場状態での過去5走の成績平均
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐⭐

---

## 🏆 騎手・調教師特徴量

### 17. **kishu_skill_score** (騎手実力スコア) 🔄
- **説明**: 騎手の過去30走の平均成績スコア（SQLで計算）
- **計算方法**: 過去30走の(1 - 着順/出走頭数)平均、10走未満なら0.5（中立）
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐⭐⭐
- **備考**: 過去N走方式に統一、オッズ情報不要でsokuho対応

### 18. **kishu_popularity_score** (騎手人気差スコア)
- **説明**: 騎手による人気とオッズの乖離
- **計算方法**: 直近3ヶ月の(単勝人気 - オッズ順位)平均
- **範囲**: -10～+10程度
- **重要度**: ⭐⭐⭐
- **備考**: Pythonで計算（オッズ情報必要、sokuho非対応）

### 19. **kishu_surface_score** (騎手路面適性) 🔄
- **説明**: 騎手の芝/ダート別過去50走の平均成績（SQLで計算）
- **計算方法**: 同路面での過去50走の(1 - 着順/出走頭数)平均、5走未満なら0.5（中立）
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐⭐
- **備考**: 過去N走方式に統一

### 20. **chokyoshi_recent_score** (調教師最近成績) 🔄
- **説明**: 調教師の過去20走の平均成績スコア（SQLで計算）
- **計算方法**: 過去20走の(1 - 着順/出走頭数)平均、5走未満なら0.5（中立）
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐⭐

---

## 🏁 短距離特化特徴量 (1600m以下専用)

### 21. **wakuban_kyori_interaction** (枠番×距離相互作用) 🆕
- **説明**: 短距離ほど内枠が有利になる効果を数値化
- **計算方法**: 枠番 × (2000 - 距離) ÷ 1000
- **範囲**: 0～8程度 (8枠1200mで最大)
- **重要度**: ⭐⭐⭐ (短距離専用)
- **備考**: 1600m以下のモデルでのみ使用

### 22. **zenso_kyori_sa** (前走距離差) 🆕
- **説明**: 前走からの距離変化(絶対値)
- **計算方法**: |今回距離 - 前走距離|
- **範囲**: 0～1600m程度
- **重要度**: ⭐⭐⭐ (短距離専用)
- **備考**: 短距離では距離変化の影響が大きい

### 23. **start_index** (スタート指数) 🆕
- **説明**: 過去10走の第1コーナー通過順位から算出
- **計算方法**: 
  - 位置取りスコア: 1.0 - (平均通過順位 ÷ 18)
  - 安定性ボーナス: 0.2 - (標準偏差 ÷ 10) (最大+0.2)
  - 合計: 位置取りスコア + 安定性ボーナス
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐⭐⭐ (短距離専用)
- **備考**: 短距離はスタートが勝負を決める

### 24. **corner_position_score** (コーナー通過位置スコア) 🆕
- **説明**: 過去3走の全コーナー(1-4)通過位置の平均と安定性
- **計算方法**: 
  - 位置取りスコア: 1.0 - (平均通過順位 ÷ 18)
  - 安定性ボーナス: 0.3 - (標準偏差 ÷ 10) (最大+0.3)
  - 合計: 位置取りスコア + 安定性ボーナス (最大1.0)
- **範囲**: 0.0～1.0
- **重要度**: ⭐⭐⭐⭐ (短距離専用)
- **備考**: 安定して前方にいる馬を評価、馬連・ワイドの精度向上に寄与

---

## 🏇 長距離特化特徴量 (2200m以上専用)

### 25. **long_distance_experience_count** (長距離経験回数) 🆕
- **説明**: 過去の長距離レース(≥2400m)の経験回数
- **計算方法**: 過去レースで距離≥2400mの回数をカウント
- **範囲**: 0～30回程度 (経験豊富な馬ほど多い)
- **重要度**: ⭐⭐⭐ (長距離専用)
- **備考**: 2200m以上のモデルでのみ使用、スタミナ適性の簡易指標

---

## 📊 特徴量選択ルール

### 路面×距離別の特徴量調整

#### 🌿 芝中長距離 (1700-2199m)
- **使用特徴量**: ベース特徴量20個
- **特徴量数**: 20個
- **備考**: 最も安定したベースモデル

#### 🌿 芝長距離 (2200m以上)
- **使用特徴量**: ベース特徴量20個
- **追加特徴量**: `long_distance_experience_count`
- **特徴量数**: 21個
- **備考**: スタミナ適性評価が重要

#### 🌿 芝短距離 (1600m以下)
- **削除特徴量**: 
  - `kohan_3f_index` (SHAP 0.030 - 後半の脚は重要度低)
  - `surface_aptitude_score` (SHAP 0.000 - 完全に無意味)
  - `wakuban_ratio` (SHAP 0.008 - ほぼ無効)
- **追加特徴量**: 
  - `wakuban_kyori_interaction`
  - `zenso_kyori_sa`
  - `start_index`
  - `corner_position_score`
- **特徴量数**: 24個

#### 🏜️ ダート中長距離 (1700-2199m)
- **使用特徴量**: ベース特徴量20個
- **特徴量数**: 20個

#### 🏜️ ダート長距離 (2200m以上)
- **使用特徴量**: ベース特徴量20個
- **追加特徴量**: `long_distance_experience_count`
- **特徴量数**: 21個

#### 🏜️ ダート短距離 (1600m以下)
- **削除特徴量**: 
  - `kohan_3f_index`
  - `surface_aptitude_score`
  - `wakuban_ratio`
- **追加特徴量**: 短距離特化4個
  - `wakuban_kyori_interaction`
  - `zenso_kyori_sa`
  - `start_index`
  - `corner_position_score`
- **特徴量数**: 24個

---

## 📈 SHAP分析結果 (東京芝短距離モデル)

| 順位 | 特徴量 | SHAP重要度 | 備考 |
|------|--------|-----------|------|
| 1 | distance_category_score | 0.274 | 距離適性が最重要 |
| 2 | past_avg_sotai_chakujun | 0.243 | 着差考慮成績 |
| 3 | kishu_surface_score | 0.171 | 騎手路面適性 |
| 4 | futan_per_barei | 0.122 | 負担重量 |
| 5 | past_score | 0.113 | グレード別成績 |
| 6 | time_index | 0.082 | タイム指数 |
| 7 | umaban_kyori_interaction | 0.075 | 馬番×距離 |

---

## 🔄 変更履歴

### 2025-11-10
- ✅ `wakuban_kyori_interaction`追加 (短距離特化)
- ✅ `zenso_kyori_sa`追加 (短距離特化)
- ✅ `start_index`追加 (短距離特化)
- ✅ 路面×距離別の特徴量選択を実装
- ❌ `pace_suitability`追加→削除 (精度悪化のため)

### 2025-11-09
- ✅ `past_avg_sotai_chakujun`に着差考慮を追加 (Pattern 2採用)

### 2025-11-08
- ✅ グレード重み付け強化 (G1=3.0x, G2=2.0x, G3=1.5x)

---

## 💡 追加予定の特徴量

なし (現在実装待ちの特徴量はありません)

### 🟡 条件付き採用

#### 4. early_pace_performance
- **説明**: 前半ペース適性 (前半3Fスピードと成績の相関)
- **条件**: zenpan_3f (前半3Fタイム) データが利用可能な場合のみ
- **実装難易度**: 中 (データ確認 + 相関計算)

#### 5. long_distance_stamina_score
- **説明**: 長距離レース (≥2000m) での平均後半3F指数
- **条件**: 十分な長距離データがある場合のみ
- **実装難易度**: 中 (データ量確認が必要)

### ❌ 却下

- **distance_transition_trend**: 距離変化トレンド → 実装したが精度悪化のため削除
- **distance_performance_gradient**: similar_distance_scoreと情報重複
- **lap_consistency_score**: ラップタイムデータ不足の可能性大
- **mid_distance_consistency**: 情報量少なく効果疑問

---

## 🔄 変更履歴

### 2026-01-18
- ✅ 距離適性特徴量を全面リニューアル（SQL化 + 重み付け平均）
  - `past_avg_kyori`削除（単純平均では性能情報なし）
  - `past_score_short`, `past_score_mile`, `past_score_middle`, `past_score_long`追加（SQLで4距離帯別成績を算出）
  - `similar_distance_score`を重み付け平均版に刷新（未経験距離でも周辺距離帯から推定可能）
- ✅ 騎手・調教師スコアを過去N走方式に統一（sokuho対応）
  - `kishu_skill_score`: 過去30走平均
  - `kishu_surface_score`: 同路面過去50走平均
  - `chokyoshi_recent_score`: 過去20走平均

### 2025-11-10
- ✅ `wakuban_kyori_interaction`追加 (短距離特化)
- ✅ `zenso_kyori_sa`追加 (短距離特化)
- ✅ `start_index`追加 (短距離特化)
- ✅ `corner_position_score`追加 (短距離特化) → 安定性ボーナス追加で全券種的中率向上
- ✅ `long_distance_experience_count`追加 (長距離特化 2200m以上)
- ✅ 路面×距離別の特徴量選択を実装
- ✅ 新規特徴量8案を評価 → 3つ採用、2つ実装完了
- ✅ corner_2, corner_3, corner_4カラムをデータベースから取得
- ❌ `pace_suitability`追加→削除 (精度悪化のため)
- ❌ `distance_transition_trend`追加→削除 (精度悪化のため)

### 2025-11-09
- ✅ `past_avg_sotai_chakujun`に着差考慮を追加 (Pattern 2採用)

### 2025-11-08
- ✅ グレード重み付け強化 (G1=3.0x, G2=2.0x, G3=1.5x)

---

**最終更新**: 2025年11月10日
**作成者**: Copilot AI Assistant
