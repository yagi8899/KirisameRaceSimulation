# SHAP分析レポート - 東京芝1700m以上3歳以上モデル

## 📊 実行日: 2025年12月29日

---

## 🎯 重要な発見

### 1️⃣ **過去成績系の特徴量が圧倒的に重要**

**Top 3の特徴量:**
1. **past_avg_sotai_chakujun** (0.187) - 過去の相対着順
   - SHAP値: 0.187 (ぶっちぎり1位)
   - LightGBM Gain: 3723.1
   - 意味: 直近3走の相対着順(1-(着順/出走頭数))の平均
   - **結論**: 馬の直近パフォーマンスが最も重要!

2. **umaban_kyori_interaction** (0.133) - 馬番×距離の相互作用
   - SHAP値: 0.133
   - LightGBM Gain: 1832.7
   - 意味: 馬番と距離の組み合わせ効果
   - **結論**: 内枠/外枠と長距離の組み合わせが重要

3. **futan_per_barei** (0.063) - futan_per_barei
   - SHAP値: 0.063
   - LightGBM Gain: 1232.6

**Top3だけで全体影響の50.3%を占める!**
- past_avg_sotai_chakujun: 0.187 / 0.761 = 24.6%
- umaban_kyori_interaction: 0.133 / 0.761 = 17.4%
- futan_per_barei: 0.063 / 0.761 = 8.2%

---

### 2️⃣ **カテゴリ別特徴量の重要度**

**特徴量カテゴリ別寄与率:**
- **過去成績系** (36.8%) - 3個の特徴量
- **馬番・枠番系** (23.2%) - 3個の特徴量
- **斤量系** (14.5%) - 4個の特徴量
- **騎手系** (12.7%) - 3個の特徴量
- **馬場適性系** (9.8%) - 3個の特徴量

**分析:**
- 過去成績系が36.8%でトップ
- モデルは馬の基本能力を最も重視している

---

### 3️⃣ **削除推奨特徴量の分析**

**削除推奨の特徴量はありません ✅**

最下位3つの特徴量でも一定の貢献度があります:
- `kishu_popularity_score` (SHAP=0.0122)
- `wakuban_ratio` (SHAP=0.0115)
- `baba_change_adaptability` (SHAP=0.0102)

すべての特徴量が意味のある貢献をしています！

---

### 4️⃣ **累積寄与率分析**

- **累積寄与率 50%**: Top3個の特徴量
- **累積寄与率 70%**: Top6個の特徴量
- **累積寄与率 80%**: Top8個の特徴量
- **累積寄与率 90%**: Top12個の特徴量

**パレートの法則:**
- 上位3個（全体の17.6%）で全体の50%を説明
- 理想的な重要度分布を実現！

---

## 🔥 改善提案

### ✅ すぐできる改善

#### 2. **Top3特徴量の強化**

**past_avg_sotai_chakujun強化案:**
- 現在: 直近3走の平均
- 改善: **指数加重平均**(最新レースを重視)
  - 3走前: 重み0.2
  - 2走前: 重み0.3
  - 1走前: 重み0.5

**umaban_kyori_interaction強化案:**
- 現在: umaban × kyori / 1000
- 改善: **非線形変換**
  - 長距離(2400m+) × 外枠(13番+) → ペナルティ大
  - 短距離(1800m-) × 内枠(1-3番) → ボーナス

---

## 📈 統計サマリー

- **全特徴量数**: 17個
- **SHAP値合計**: 0.7610
- **SHAP値平均**: 0.0448
- **SHAP値中央値**: 0.0322
- **SHAP値標準偏差**: 0.0476
- **LightGBM Gain相関**: 0.9518

---

## 🎲 次のアクション

### 優先度高(すぐやる)
1. ✅ **Top3特徴量を強化**（指数加重平均、非線形変換）
2. ✅ **バックテストで効果検証**
3. ⏳ **閾値の再調整**

### 優先度中(検証後に実施)
4. ⏳ **中位特徴量の改善**（非線形変換、相互作用追加）
5. ⏳ **過去成績参照期間の調整**（3走→5走など）
6. ⏳ **騎手特徴量の精緻化**（競馬場別に分割）

### 優先度低(余裕があれば)
7. 🔮 **騎手×馬の相性特徴量を追加**
8. 🔮 **賞金額ベースの特徴量を追加**

---

## 💡 結論

**SHAP分析から得られた最大の知見:**

> **「past_avg_sotai_chakujunが全体の24.6%を占め、他のすべてを圧倒している」**

現在のモデルは:
- ✅ 馬の過去成績を正しく評価できている
- ✅ 騎手の能力も適切に考慮している
- ✅ 斤量の影響も捉えている
- ✅ すべての特徴量が意味のある貢献をしている
- ❌ Top特徴量の作り方に改善余地あり

**次のステップ:**
1. Top3特徴量を強化（指数加重平均、非線形変換）
2. バックテストで実際の的中率改善を確認
3. さらなる特徴量エンジニアリング
