# SHAP分析レポート - 東京芝1700m以上3歳以上モデル

## 📊 実行日: 2025年11月10日

---

## 🎯 重要な発見

### 1️⃣ **過去成績系の特徴量が圧倒的に重要**

**Top 3の特徴量:**
1. **past_avg_sotai_chakujun** (0.211) - 過去の相対着順
   - SHAP値: 0.211 (ぶっちぎり1位)
   - LightGBM Gain: 1727.2
   - 意味: 直近3走の相対着順(1-(着順/出走頭数))の平均
   - **結論**: 馬の直近パフォーマンスが最も重要!

2. **umaban_kyori_interaction** (0.130) - 馬番×距離の相互作用
   - SHAP値: 0.130
   - LightGBM Gain: 844.4
   - 意味: 馬番と距離の組み合わせ効果
   - **結論**: 内枠/外枠と長距離の組み合わせが重要

3. **past_score** (0.076) - グレード別過去成績スコア
   - SHAP値: 0.076
   - LightGBM Gain: 631.6
   - 意味: レースグレードを考慮した過去3走の重み付けスコア
   - **結論**: G1で1着は重く評価される

**Top3だけで全体影響の51.8%を占める!**
- past_avg_sotai_chakujun: 0.211 / 0.408 = 51.7%
- umaban_kyori_interaction: 0.130 / 0.408 = 31.9%
- past_score: 0.076 / 0.408 = 18.6%

---

### 2️⃣ **騎手の能力も重要(4位, 5位, 7位)**

**騎手関連の特徴量:**
- **kishu_surface_score** (5位, 0.061) - 騎手の芝/ダート適性
- **kishu_skill_score** (7位, 0.052) - 騎手の直近実力
- **kishu_popularity_score** (14位, 0.014) - 人気を上回る能力

**分析:**
- 騎手の「馬場適性」が「実力」より重要
- 芝が得意な騎手 vs ダートが得意な騎手の差が大きい
- 人気補正スコアは影響小(14位) → オッズはすでに騎手実力を織り込み済み

---

### 3️⃣ **斤量(体重負担)が4位、6位、10位、12位に登場**

**斤量関連の特徴量:**
- **futan_per_barei** (4位, 0.069) - 斤量/馬齢
- **kohan_3f_index** (6位, 0.052) - 後半3F指数(間接的に体力消耗に関連)
- **futan_zscore** (10位, 0.019) - 斤量の標準化スコア
- **futan_percentile** (12位, 0.017) - 斤量の相対位置

**分析:**
- 若い馬に重い斤量 = 不利
- 年齢相応の斤量が重要
- レース内での相対的な斤量差も影響

---

### 4️⃣ **タイム系の特徴量は中位(8位)**

**タイム関連:**
- **time_index** (8位, 0.025) - 過去3走の速度指数(距離/タイム)

**分析:**
- 重要度は中程度
- past_avg_sotai_chakujun(着順)の方が8.5倍重要
- タイムより着順の方が予測に効く!

---

### 5️⃣ **馬場変化・距離変化への適応力は低影響**

**適応力系特徴量:**
- **baba_change_adaptability** (17位, 0.009) - 馬場変化対応力
- **distance_change_adaptability** (22位, 0.005) - 距離変化対応力
- **baba_condition_score** (24位, 0.003) - 馬場状態別適性

**分析:**
- 馬場や距離が変わっても、基本能力(past_avg_sotai_chakujun)の方が重要
- これらは「ノイズ」に近い可能性
- **削除候補の特徴量**として検討すべき

---

### 6️⃣ **年齢ピーク特徴量は機能していない**

**年齢関連:**
- **barei_peak_short** (26位, 0.000) - 短距離ピーク年齢からの距離
- **barei_peak_distance** (25位, 0.002) - ピーク年齢からの距離

**分析:**
- ほぼ影響なし!
- futan_per_barei(斤量/馬齢)が年齢効果をカバーしている可能性
- **削除候補**

---

## 🔥 改善提案

### ✅ すぐできる改善

#### 1. **不要な特徴量を削除(次元削減)**
削除候補(SHAP < 0.005):
- `barei_peak_short` (0.000) ❌
- `barei_peak_distance` (0.002) ❌
- `baba_condition_score` (0.003) ❌
- `distance_change_adaptability` (0.005) ❌
- `wakuban_bias_score` (0.005) ❌

**期待効果:**
- 過学習リスク減少
- 学習速度向上
- モデルの解釈性向上

---

#### 2. **Top3特徴量の強化**

**past_avg_sotai_chakujun強化案:**
- 現在: 直近3走の平均
- 改善: **指数加重平均**(最新レースを重視)
  - 3走前: 重み0.2
  - 2走前: 重み0.3
  - 1走前: 重み0.5
  
**umaban_kyori_interaction強化案:**
- 現在: umaban × kyori / 1000
- 改善: **非線形変換**
  - 長距離(2400m+) × 外枠(13番+) → ペナルティ大
  - 短距離(1800m-) × 内枠(1-3番) → ボーナス

**past_score強化案:**
- 現在: G1=1.0, G2=0.8, G3=0.6...
- 改善: **賞金ベース**の重み付け
  - 1着賞金が高いレース = より高評価

---

#### 3. **騎手特徴量の精緻化**

**kishu_surface_score改善案:**
- 現在: 芝/ダート別の6ヶ月成績
- 改善: **競馬場×馬場タイプ**
  - 東京芝での騎手成績
  - 中山芝での騎手成績
  - 騎手は競馬場ごとに得意不得意がある

---

### 🔬 実験すべきこと

#### A. **過去成績の参照期間を変える**
- 現在: 直近3走
- 実験: 
  - 直近5走
  - 直近10走
  - 6ヶ月以内の全レース

#### B. **騎手×馬の相性特徴量**
- 同じ騎手×同じ馬の過去成績
- 騎手乗り替わり時の影響

#### C. **レースグレードをもっと細分化**
- 現在: G1/G2/G3/OP/3勝/2勝/1勝/未勝利
- 追加: **賞金額**を直接使う

---

## 📈 期待できる精度向上

### 現在の的中率: 21.5%(2021-2022年テスト)

**改善1: 不要特徴量削除**
- 期待向上: +0.5~1.0%
- 根拠: ノイズ除去による汎化性能向上

**改善2: Top3特徴量強化**
- 期待向上: +1.5~3.0%
- 根拠: 最重要特徴量の精度向上

**改善3: 騎手特徴量精緻化**
- 期待向上: +0.5~1.5%
- 根拠: 5位、7位の特徴量改善

**合計期待値: 22.0~26.0%**
- 最悪ケース: 22.0%(+0.5%)
- 期待値: 24.0%(+2.5%)
- 最良ケース: 26.0%(+4.5%)

---

## 🎲 次のアクション

### 優先度高(すぐやる)
1. ✅ **barei_peak_short, barei_peak_distanceを削除**
2. ✅ **baba_condition_score, distance_change_adaptabilityを削除**
3. ✅ **past_avg_sotai_chakujunを指数加重平均に変更**

### 優先度中(検証後に実施)
4. ⏳ **umaban_kyori_interactionに非線形変換を追加**
5. ⏳ **kishu_surface_scoreを競馬場別に分割**
6. ⏳ **過去成績参照期間を3走→5走に変更して比較**

### 優先度低(余裕があれば)
7. 🔮 **騎手×馬の相性特徴量を追加**
8. 🔮 **賞金額ベースの特徴量を追加**

---

## 💡 結論

**SHAP分析から得られた最大の知見:**

> **「馬の直近パフォーマンス(past_avg_sotai_chakujun)が他のすべてを圧倒している」**

現在のモデルは:
- ✅ 馬の過去成績を正しく評価できている
- ✅ 騎手の能力も適切に考慮している
- ✅ 斤量の影響も捉えている
- ❌ ノイズ特徴量が多すぎる(26個中5個は不要)
- ❌ Top3特徴量の作り方に改善余地あり

**次のステップ:**
1. 不要特徴量を削除して21個に減らす
2. past_avg_sotai_chakujunを指数加重平均に改善
3. モデルを再学習して的中率を確認

**目標: 21.5% → 24.0%以上**
