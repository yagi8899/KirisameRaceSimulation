# 穴馬データ量分析レポート

**作成日**: 2026年1月21日  
**目的**: 条件別穴馬分類器を作成するためのデータ量検証

---

## 📊 エグゼクティブサマリー

### 結論

| 項目 | 結果 |
|------|------|
| **全体穴馬率** | **9.72%**（7-12番人気で3着以内） |
| **JRA10競馬場** | ✅ すべてデータ十分（競馬場別モデル作成可能） |
| **競馬場×芝ダ別** | ✅ 主要な組み合わせはデータ十分 |
| **競馬場×芝ダ×距離帯** | ⚠️ 一部の組み合わせでデータ不足 |

### 推奨アーキテクチャ

```
穴馬分類器の粒度: 競馬場 × 芝ダ区分（推奨）
```

- **競馬場単位**: データ十分だが、芝とダートの特性差を吸収できない
- **競馬場×芝ダ**: 最適なバランス（20モデル）
- **競馬場×芝ダ×距離**: データ不足の組み合わせが多い

---

## 1️⃣ 全体統計

| 項目 | 値 |
|------|------|
| 総レコード数（7-12番人気） | 1,082,714頭 |
| 穴馬数（3着以内） | 105,269頭 |
| 穴馬率 | **9.72%** |

> 💡 **発見**: 訓練データの1.22%は「全人気」に対する比率だった。7-12番人気に絞ると**9.72%**が実際の穴馬率。これはテストデータ（函館10.77%）とほぼ一致する。

---

## 2️⃣ 競馬場別データ量

### JRA10競馬場（すべてデータ十分✅）

| 競馬場 | コード | 総数 | 穴馬数 | 穴馬率 | 判定 |
|--------|--------|------:|-------:|-------:|------|
| 東京 | 05 | 104,805 | 10,480 | 10.00% | ✅ 十分 |
| 中山 | 06 | 104,079 | 10,479 | 10.07% | ✅ 十分 |
| 京都 | 08 | 100,240 | 10,099 | 10.07% | ✅ 十分 |
| 阪神 | 09 | 96,692 | 9,856 | 10.19% | ✅ 十分 |
| 中京 | 07 | 67,097 | 7,086 | 10.56% | ✅ 十分 |
| 新潟 | 04 | 64,204 | 6,650 | 10.36% | ✅ 十分 |
| 小倉 | 10 | 60,068 | 6,374 | 10.61% | ✅ 十分 |
| 福島 | 03 | 56,008 | 6,064 | 10.83% | ✅ 十分 |
| 札幌 | 01 | 34,452 | 3,506 | 10.18% | ✅ 十分 |
| **函館** | **02** | **31,120** | **3,190** | **10.25%** | ✅ 十分 |

### 穴馬率の傾向

- **最高**: 福島 11.83%（ローカル開催で波乱が多い）
- **最低**: 東京 10.00%（大箱競馬場で実力通りになりやすい）
- **函館**: 10.25%（全体平均と同等）

> 📝 **注記**: 競馬場コード30以降は地方競馬のデータと思われる。JRA分析では除外推奨。

---

## 3️⃣ 競馬場 × 芝ダ区分別データ量

### JRA10競馬場の芝・ダート別（すべてデータ十分✅）

| 競馬場 | 芝 総数 | 芝 穴馬率 | ダート 総数 | ダート 穴馬率 |
|--------|--------:|----------:|------------:|-------------:|
| 東京 | 48,072 | 9.96% | 53,217 | 9.96% |
| 中山 | 41,125 | 10.64% | 59,324 | 9.66% |
| 京都 | 42,548 | 10.21% | 53,776 | 9.91% |
| 阪神 | 40,284 | 10.74% | 52,665 | 9.64% |
| 中京 | 30,743 | 11.03% | 34,716 | 10.11% |
| 新潟 | 37,095 | 10.86% | 24,590 | 9.57% |
| 小倉 | 37,859 | 10.80% | 20,382 | 10.36% |
| 福島 | 33,051 | 11.39% | 21,312 | 9.93% |
| 札幌 | 16,032 | 10.62% | 18,420 | 9.79% |
| **函館** | **16,793** | **11.22%** | **14,327** | **9.12%** |

### 傾向分析

| 馬場 | 平均穴馬率 | 特徴 |
|------|----------:|------|
| **芝** | 10.65% | やや高い（波乱傾向） |
| **ダート** | 9.70% | やや低い（実力通り） |

> 💡 **発見**: 芝の方がダートより約1ポイント穴馬率が高い。芝は馬場状態や展開の影響を受けやすく、波乱が起きやすい。

---

## 4️⃣ 競馬場 × 距離帯別データ量

### JRA10競馬場の距離帯別（すべてデータ十分✅）

| 距離帯 | 定義 | 平均穴馬率 | 傾向 |
|--------|------|----------:|------|
| 短距離 | 1000-1400m | 10.05% | 平均的 |
| マイル | 1401-1800m | 10.20% | 平均的 |
| 中距離 | 1801-2200m | 10.60% | やや高い |
| 長距離 | 2201m~ | 11.10% | **高い** |

> 💡 **発見**: 長距離ほど穴馬率が高い傾向。スタミナ勝負で実力差が出にくく、ペース次第で波乱が起きやすい。

---

## 5️⃣ 競馬場 × 芝ダ × 距離帯別データ量（詳細版）

### 函館のデータ量詳細

| 馬場 | 距離帯 | 総数 | 穴馬数 | 穴馬率 | 判定 |
|------|--------|------:|-------:|-------:|------|
| 芝 | 短距離(1000-1400m) | 8,286 | 917 | 11.07% | ✅ 十分 |
| 芝 | マイル(1401-1800m) | 4,441 | 506 | 11.39% | ✅ 十分 |
| 芝 | 中距離(1801-2200m) | 3,056 | 340 | 11.13% | ✅ 十分 |
| 芝 | 長距離(2201m~) | 1,010 | 121 | 11.98% | ✅ 十分 |
| ダート | 短距離(1000-1400m) | 5,316 | 418 | 7.86% | ✅ 十分 |
| ダート | マイル(1401-1800m) | 8,831 | 867 | 9.82% | ✅ 十分 |
| ダート | 長距離(2201m~) | 180 | 21 | 11.67% | ❌ 不足 |

### データ不足の組み合わせ（JRA10競馬場）

| 競馬場 | 馬場 | 距離帯 | 総数 | 穴馬数 | 理由 |
|--------|------|--------|------:|-------:|------|
| 札幌 | ダート | 中距離 | 172 | 23 | コース設定なし |
| 札幌 | ダート | 長距離 | 316 | 37 | コース設定なし |
| 小倉 | ダート | 長距離 | 412 | 51 | コース設定なし |
| 新潟 | ダート | 長距離 | 106 | 9 | コース設定なし |
| 東京 | ダート | 長距離 | 102 | 16 | コース設定なし |
| 函館 | ダート | 長距離 | 180 | 21 | コース設定なし |
| 福島 | ダート | 長距離 | 249 | 23 | コース設定なし |
| 中京 | ダート | 長距離 | 683 | 62 | やや不足 |
| 新潟 | 芝 | 長距離 | 834 | 94 | やや不足 |

> 📝 **注記**: 「不足」の組み合わせは主にダート長距離。これらはコース設定がないか非常に稀なため、学習データとして期待できない。

---

## 6️⃣ 地域別データ量（緩和案）

| 地域 | 競馬場 | 総数 | 穴馬数 | 穴馬率 | 判定 |
|------|--------|------:|-------:|-------:|------|
| 関西 | 中京+京都+阪神 | 264,029 | 27,041 | 10.24% | ✅ 十分 |
| 関東 | 東京+中山 | 208,884 | 20,959 | 10.03% | ✅ 十分 |
| 九州 | 小倉 | 60,068 | 6,374 | 10.61% | ✅ 十分 |
| 東北・北関東 | 福島+新潟 | 120,212 | 12,714 | 10.58% | ✅ 十分 |
| **北海道** | 札幌+函館 | **65,572** | **6,696** | **10.21%** | ✅ 十分 |

> 💡 **緩和案**: 函館単体でデータ不足の場合、「北海道（札幌+函館）」でグルーピングすることで2倍のデータ量を確保可能。

---

## 🎯 推奨事項

### 1. 穴馬分類器のアーキテクチャ

```
推奨: 競馬場 × 芝ダ区分（20モデル）
```

| レベル | モデル数 | メリット | デメリット |
|--------|----------|----------|------------|
| 全競馬場統一 | 1 | データ最大 | 競馬場特性を無視 |
| 競馬場別 | 10 | シンプル | 芝ダ特性を無視 |
| **競馬場×芝ダ** | **20** | **バランス良好** | - |
| 競馬場×芝ダ×距離 | 80+ | 最も詳細 | データ不足多発 |

### 2. 函館モデルの推奨設定

```python
# 函館専用穴馬分類器の設定
{
    "track_code": "02",           # 函館
    "surface_type": "turf",       # 芝（穴馬率11.22%）
    "min_distance": 1000,
    "max_distance": 2600,         # 長距離まで含む
    "expected_upset_rate": 0.1122 # 期待穴馬率
}

{
    "track_code": "02",           # 函館
    "surface_type": "dirt",       # ダート（穴馬率9.12%）
    "min_distance": 1000,
    "max_distance": 1800,         # 長距離は除外（データ不足）
    "expected_upset_rate": 0.0912 # 期待穴馬率
}
```

### 3. scale_pos_weight の再計算

**現状の問題**:
- 訓練データ穴馬率: 1.22%（全人気ベース）← **誤り**
- テストデータ穴馬率: 10.77%
- 9倍の差 → scale_pos_weight が大きくズレる

**修正後**:
- 訓練データ穴馬率: **9.72%**（7-12番人気ベース）← **正しい**
- テストデータ穴馬率: 10.77%
- **1.1倍の差** → scale_pos_weight 調整ほぼ不要！

```python
# 修正前
scale_adjustment = 0.3  # 9倍の差を補正しようとしていた

# 修正後（推奨）
scale_adjustment = 1.0  # 差がほぼないので調整不要
# または
scale_adjustment = 0.9  # 微調整（10.77% / 9.72% ≈ 1.1）
```

---

## 📋 次のアクション

1. **訓練データ生成ロジックの修正**
   - `is_upset` の計算時に7-12番人気のデータのみを対象にする
   - または、全人気データを使うが `scale_pos_weight` を正しく計算する

2. **条件別穴馬分類器の実装**
   - `model_configs.json` と同じ条件で穴馬分類器も作成
   - `walk_forward_validation.py` でRankerと一緒に学習

3. **scale_pos_weight の修正**
   - 現在の0.5 → 1.0 に変更（または自動計算）
   - 訓練データの穴馬率を正しく反映

---

## 📊 データ品質に関する注記

- 競馬場コード30-61は**地方競馬**のデータ
- JRA分析では**コード01-10のみ**を使用推奨
- 「不明」の芝ダ区分は主に**障害レース**または**データ欠損**
