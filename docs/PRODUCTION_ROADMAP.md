# 🚀 Ranker + 穴馬分類器 本運用ロードマップ

**作成日**: 2026年1月24日  
**目的**: 穴馬予測システムを本運用するまでに必要なタスクの整理

---

## 📋 全体サマリー

### 現状（2026年1月時点）

| 項目 | 状態 |
|------|------|
| Rankerモデル | ✅ 完成（全競馬場対応） |
| 穴馬分類器 | ✅ 完成（統合モデル） |
| テスト済み競馬場 | 東京、小倉（2競馬場のみ） |
| 全体ROI | -23.8%（フィルタなし） |
| フィルタ後ROI | +プラス（条件絞り込み時） |

### 発見された重要な知見

| 芝/ダート | 狙い目オッズ帯 | Ranker条件 | 戦略 |
|-----------|---------------|-----------|------|
| **芝** | 10-30倍（低め） | Ranker上位5以内 | 高TP率(25-32%)で手堅く |
| **ダート** | 60-100倍（高め） | Ranker上位8以内 | 高配当狙い |

---

## 📝 Phase 1: 全競馬場テスト（必須）

### 1.1 Walk-Forward形式でのモデル作成・テスト

**目的**: 全10競馬場で2023〜2025年を対象にした検証

**対象競馬場**:
- [ ] 札幌
- [ ] 函館
- [ ] 福島
- [ ] 新潟
- [x] 東京（完了）
- [ ] 中山
- [ ] 中京
- [ ] 京都
- [ ] 阪神
- [x] 小倉（完了）

**実行コマンド例**:
```bash
# Walk-Forward検証（各競馬場はjsonで詳しく指定）
python walk_forward_validation.py --config walk_forward_config.json
```

**出力**:
- `check_results/predicted_results_<競馬場>.tsv`
- 最終的に `predicted_results_all.tsv` にマージ

---

### 1.2 全競馬場ROI分析

**目的**: 今回発見した戦略パターンが全競馬場で有効か検証

**使用スクリプト**:
```bash
# 全競馬場のROI分析
python analyze_actual_roi.py check_results/predicted_results_all.tsv
```

**確認項目**:
- [ ] 競馬場×芝/ダート別ROI
- [ ] 芝: 10-30倍 × Ranker上位5 の有効性
- [ ] ダート: 60-100倍 × Ranker上位8 の有効性
- [ ] サンプル数が十分か（各条件20件以上推奨）

---

### 1.3 最適閾値の探索

**目的**: 全競馬場データに基づく最適な穴馬確率閾値の決定

**使用スクリプト**:
```bash
# 閾値最適化
python optimize_upset_threshold.py check_results/predicted_results_all.tsv
```

**検討項目**:
- [ ] 全体最適閾値
- [ ] 競馬場別閾値（必要なら）
- [ ] ROI最大化 vs Precision最大化のトレードオフ

---

### 1.4 Precision/Recall確認

**目的**: モデルの予測精度を評価

**使用スクリプト**:
```bash
# 全体
python calculate_precision_recall.py check_results/predicted_results_all.tsv

# 競馬場別
python calculate_precision_recall.py check_results/predicted_results_all.tsv --by-track

# 芝/ダート別
python calculate_precision_recall.py check_results/predicted_results_all.tsv --by-surface

# 年度別
python calculate_precision_recall.py check_results/predicted_results_all.tsv --by-year
```

**目標値**:

| 指標 | 目標 |
|------|------|
| Precision | 10%以上（Phase 2達成） |
| フィルタ後TP率 | 20%以上 |
| フィルタ後ROI | 0%以上（プラス収支） |

---

## 📝 Phase 2: 本運用テスト環境構築

### 2.1 検証用DB作成

**目的**: 本運用に近い環境でのテスト

**手順**:
1. [ ] 2024年までのデータを過去データとして保持
2. [ ] 2025年データを速報テーブルに移行
3. [ ] 速報テーブルからのデータ取得をシミュレート

**確認項目**:
- [ ] オッズ取得タイミングの再現
- [ ] 出走取消・競走除外の処理
- [ ] データ欠損時の挙動

---

### 2.2 本運用シミュレーション

**目的**: 実際の運用フローを検証

**テスト内容**:
1. [ ] 速報テーブルからデータ取得
2. [ ] Ranker予測実行
3. [ ] 穴馬分類器予測実行
4. [ ] 購入判断フィルタ適用
5. [ ] 推奨馬リスト出力
6. [ ] 結果検証（翌日）

**使用スクリプト**:
```bash
# 速報予測
python sokuho_prediction.py --date <日付>
```

---

## 📝 Phase 3: 購入判断ロジック実装

### 3.1 購入フィルタの実装

**目的**: プラスROI条件のみ購入する仕組み

**実装場所**: `sokuho_prediction.py` または新規スクリプト

**フィルタロジック**:
```python
def should_buy(row):
    """プラスROI条件に基づく購入判断"""
    surface = row['芝ダ区分']
    odds = row['単勝オッズ']
    ranker = row['予測順位']
    upset_prob = row['穴馬確率']
    
    # 穴馬分類器の閾値チェック
    if upset_prob < THRESHOLD:
        return False
    
    # 人気順チェック（7-12番人気）
    if not (7 <= row['人気順'] <= 12):
        return False
    
    # 芝/ダート別の条件
    if surface == '芝':
        # 芝: 低オッズ×高Ranker
        return 10 <= odds < 30 and ranker <= 5
    else:  # ダート
        # ダート: 高オッズ×Ranker上位8
        return 60 <= odds < 100 and ranker <= 8
```

**注意**: 全競馬場テスト後に条件を最終決定すること

---

### 3.2 閾値と購入フィルタの分離

**現状の構造**:
```
穴馬確率 >= 閾値 → 穴馬候補
```

**新しい構造**:
```
穴馬確率 >= 閾値 → 穴馬候補（予測対象）
         ↓
    購入フィルタ → 実際に購入する馬
```

**実装項目**:
- [ ] `upset_threshold_config.json` は穴馬候補の選定用
- [ ] 購入フィルタは別設定ファイル（`purchase_filter_config.json`）

---

## 📝 Phase 4: 資金管理・リスク管理

### 4.1 資金管理戦略

**検討項目**:
- [ ] 1レースあたりの投資額
- [ ] 1日の最大投資額
- [ ] 1週間の最大投資額
- [ ] ケリー基準の適用検討（`kelly_criterion.py`）

**推奨設定例**:
| 項目 | 推奨値 |
|------|--------|
| 1点あたり | 100円 |
| 1レース最大 | 500円（5点まで） |
| 1日最大 | 5,000円 |
| 1週間最大 | 20,000円 |

---

### 4.2 撤退基準の設定

**検討項目**:
- [ ] 累計損失がいくらで運用停止するか
- [ ] 連続不的中が何回で条件見直しするか
- [ ] 特定条件のパフォーマンス悪化時の対応

**推奨基準例**:
| 条件 | アクション |
|------|-----------|
| 累計損失 -50,000円 | 運用停止・全面見直し |
| 1週間ROI -30%以下 | 条件の再検証 |
| 特定条件のROI -50%以下（20件以上） | その条件を除外 |

---

## 📝 Phase 5: 運用モニタリング

### 5.1 日次モニタリング

**記録項目**:
- 購入点数
- 的中数
- 投資額
- 回収額
- ROI

**スクリプト作成**:
- [ ] `daily_report.py` - 日次レポート生成

---

### 5.2 週次/月次分析

**分析項目**:
- 条件別ROI推移
- 想定からの乖離
- 新たなパターンの発見

**スクリプト作成**:
- [ ] `weekly_analysis.py` - 週次分析レポート

---

## 📅 実施スケジュール（案）

| Phase | タスク | 所要時間 | 優先度 |
|-------|--------|---------|--------|
| **1.1** | 全競馬場Walk-Forwardテスト | 2-3日 | ⭐⭐⭐⭐⭐ |
| **1.2** | 全競馬場ROI分析 | 1時間 | ⭐⭐⭐⭐⭐ |
| **1.3** | 最適閾値探索 | 2-3時間 | ⭐⭐⭐⭐⭐ |
| **1.4** | Precision/Recall確認 | 1時間 | ⭐⭐⭐⭐ |
| **2.1** | 検証用DB作成 | 1日 | ⭐⭐⭐⭐ |
| **2.2** | 本運用シミュレーション | 1週間 | ⭐⭐⭐⭐ |
| **3.1** | 購入フィルタ実装 | 2-3時間 | ⭐⭐⭐⭐ |
| **3.2** | 閾値とフィルタの分離 | 1-2時間 | ⭐⭐⭐ |
| **4.1** | 資金管理戦略決定 | 1時間 | ⭐⭐⭐ |
| **4.2** | 撤退基準設定 | 1時間 | ⭐⭐⭐ |
| **5.1** | 日次モニタリング設計 | 2時間 | ⭐⭐ |
| **5.2** | 週次/月次分析設計 | 2時間 | ⭐⭐ |

---

## ✅ チェックリスト

### Phase 1: 全競馬場テスト
- [ ] 全10競馬場のWalk-Forwardテスト完了
- [ ] `analyze_actual_roi.py` で全競馬場ROI分析完了
- [ ] 芝/ダート戦略パターンの全競馬場での有効性確認
- [ ] 最適閾値の決定
- [ ] Precision 10%以上達成

### Phase 2: 本運用テスト
- [ ] 検証用DB作成完了
- [ ] 速報テーブルからの予測テスト完了
- [ ] 本運用フローの動作確認

### Phase 3: 購入ロジック
- [ ] 購入フィルタの実装完了
- [ ] `purchase_filter_config.json` 作成
- [ ] フィルタ適用後のROIがプラス確認

### Phase 4: リスク管理
- [ ] 資金管理ルール決定
- [ ] 撤退基準決定
- [ ] 運用ルールのドキュメント化

### Phase 5: モニタリング
- [ ] 日次レポートスクリプト作成
- [ ] 週次分析スクリプト作成

---

## 📁 関連ファイル

| ファイル | 用途 |
|----------|------|
| `analyze_actual_roi.py` | 実際の複勝オッズに基づくROI分析 |
| `calculate_precision_recall.py` | Precision/Recall計算 |
| `optimize_upset_threshold.py` | 閾値最適化 |
| `sokuho_prediction.py` | 速報予測 |
| `upset_threshold_config.json` | 閾値設定 |
| `UPSET_PREDICTION_GOALS.md` | 穴馬予測の目標・戦略 |

---

## ⚠️ 重要な注意事項

1. **サンプル数の確認**: 条件別のサンプル数が少ない場合（20件未満）は信頼性が低い
2. **過学習リスク**: 特定の競馬場・期間に最適化しすぎないこと
3. **オッズ変動**: 締切直前のオッズを使用すること（前日オッズでは不正確）
4. **複勝オッズの特性**: 高オッズ馬の複勝オッズは単勝に比例しない

---

**最終更新**: 2026年1月24日  
**作成者**: GitHub Copilot AI Assistant
