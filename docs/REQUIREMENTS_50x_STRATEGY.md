# 要件定義書: 元金50万円を10倍にする戦略システム

## 1. プロジェクト概要

### 1.1 目的
競馬予測システムを活用し、元金50万円を500万円（10倍）に増やすための戦略システムを構築する。

### 1.2 背景
- 既存の穴馬予測モデルがROI 335%（2024年実績）を達成
- ランキング学習による順位予測の精度は実用レベル
- 期待値計算・ケリー基準などの理論実装は完了済み
- **不足しているもの**: 資金シミュレーション、複合馬券戦略、実運用判定基準

### 1.3 成功基準
| 指標 | 目標値 | 備考 |
|------|--------|------|
| 最終資金 | 500万円以上 | 初期25万円投入から開始 |
| 破産確率 | 5%以下 | モンテカルロシミュレーションで検証 |
| 最大ドローダウン | 50%以下 | 許容リスク上限 |
| 目標達成期間 | 2年以内 | 現実的な期間設定 |

---

## 2. 資金管理要件

### 2.1 初期資金設定
| 項目 | 金額 | 説明 |
|------|------|------|
| 総資金 | 50万円 | 元金 |
| 初期投入額 | 25万円 | 最大ドローダウン50%を想定した安全設計 |
| 予備資金 | 25万円 | ドローダウン時の追加投入用 |

### 2.2 資金投入ルール
1. **初期フェーズ**: 25万円で運用開始
2. **追加投入条件**: 初期25万円が50万円に到達した場合、予備25万円を投入
3. **撤退条件**: 初期25万円が12.5万円以下（-50%）になった場合、戦略を見直し

### 2.3 賭け金スケーリング制約

#### 2.3.1 オッズインパクトの現実的制約
競馬のオッズは賭け金によって変動する。特に穴馬（7-12番人気）は元々の売上が少ないため影響を受けやすい。

**オッズ変動の目安**（JRA中央競馬の場合）:
| 馬券種 | 売上規模 | 1点あたり安全圏 | 影響が出始める金額 |
|--------|----------|-----------------|-------------------|
| 単勝 | 数百万〜数千万円 | 〜5,000円 | 10,000円以上 |
| 複勝 | 数百万〜数千万円 | 〜10,000円 | 20,000円以上 |
| 馬連 | 数千万円 | 〜5,000円 | 10,000円以上 |
| ワイド | 数百万円 | 〜3,000円 | 5,000円以上 |
| 三連複 | 数千万円 | 〜3,000円 | 5,000円以上 |
| 三連単 | 数億円 | 〜5,000円 | 10,000円以上 |

**穴馬単勝の特殊性**:
- 7-12番人気の単勝オッズは通常30倍〜100倍
- 売上が少ないため、1万円賭けるだけでオッズが数倍下がる可能性あり
- **対策**: 単勝よりも馬連・三連複で穴馬を「相手」として活用

#### 2.3.2 本システムでの賭け金上限
| 馬券種 | 1点あたり上限 | 1レースあたり上限 | 理由 |
|--------|--------------|------------------|------|
| 単勝（本命） | 5,000円 | 5,000円 | オッズ変動を最小化 |
| 単勝（穴馬） | 1,000円 | 1,000円 | 穴馬はオッズ影響大 |
| 複勝 | 5,000円 | 10,000円 | 比較的影響小 |
| 馬連 | 3,000円 | 15,000円 | メイン馬券として活用 |
| ワイド | 3,000円 | 12,000円 | サブ・保険として活用、穴馬予測との相性◎ |
| 三連複 | 2,000円 | 20,000円 | 高配当狙い |

#### 2.3.3 1日あたりの投資上限
| フェーズ | 資金規模 | 1日上限 | 1レース上限 |
|----------|----------|---------|------------|
| 初期（25万円） | 〜50万円 | 25,000円 | 5,000円 |
| 成長期（50-100万円） | 50-100万円 | 50,000円 | 10,000円 |
| 拡大期（100万円〜） | 100万円〜 | 100,000円 | 20,000円 |

---

## 3. 検証フェーズ要件

### 3.1 検証の原則
**「検証なくして実運用なし」** - 全ての戦略は統計的に有意な結果を示すまで実運用しない。

### 3.2 Walk-Forward検証

#### 3.2.1 検証期間
| 用途 | 期間 | データ |
|------|------|--------|
| 学習期間 | 2014-2022年 | 9年分 |
| 検証期間1 | 2023年 | 1年分（実施済み） |
| 検証期間2 | 2024年 | 1年分（実施済み、ROI 335%） |
| 検証期間3 | 2025年 | 1年分（追加検証予定） |

#### 3.2.2 検証基準
| 指標 | 合格基準 | 不合格時の対応 |
|------|----------|---------------|
| ROI | 150%以上 | モデル改善 or 戦略見直し |
| 的中率（穴馬） | 5%以上 | 閾値調整 |
| 連敗耐性 | 20連敗でも破産しない | 賭け金比率を下げる |
| 年間安定性 | 3年中2年以上でROI>100% | 条件を絞る |

### 3.3 モンテカルロシミュレーション

#### 3.3.1 目的
過去の的中・不的中パターンをもとに、将来の資金推移を確率的にシミュレーションし、破産確率と期待リターンを算出する。

#### 3.3.2 シミュレーション設定
| パラメータ | 値 | 説明 |
|------------|-----|------|
| 試行回数 | 10,000回 | 統計的信頼性確保 |
| シミュレーション期間 | 2年（約200週） | 目標達成期間 |
| 初期資金 | 25万円 | 実運用開始額 |
| 破産定義 | 資金が初期の10%（2.5万円）以下 | 実質的な撤退ライン |

#### 3.3.3 出力指標
| 指標 | 説明 |
|------|------|
| 破産確率 | 資金が破産ラインを下回る確率 |
| 中央値到達資金 | 50%の確率で到達する資金 |
| 95%tile到達資金 | 上位5%のシナリオでの資金 |
| 5%tile到達資金 | 下位5%のシナリオでの資金 |
| 目標達成確率 | 500万円に到達する確率 |
| 期待到達日数 | 500万円到達までの期待日数 |
| 最大ドローダウン分布 | ドローダウンの確率分布 |

### 3.4 データ信頼性の担保

#### 3.4.1 サンプルサイズ
| 項目 | 数値 | 十分性 |
|------|------|--------|
| 2024年穴馬候補数 | 約500頭 | ✅ 統計的に十分 |
| 2024年穴馬的中数 | 約50頭（推定） | ✅ 十分 |
| Walk-Forward検証年数 | 3年（2023-2025） | ✅ 十分 |

#### 3.4.2 過学習チェック
- ✅ 2024年は完全未来データとして検証済み
- ✅ 学習データと検証データは時系列で分離
- 📋 2025年データでの追加検証を予定

---

## 4. 戦略要件

### 4.1 メイン戦略: 穴馬活用型複合馬券

#### 4.1.1 戦略概要
穴馬予測モデルで検出した馬を「相手」として活用し、馬連・三連複で高配当を狙う。

#### 4.1.2 馬券構成
```
【馬連戦略】高配当狙い（メイン）
軸: ランキング学習による上位2頭
相手: 穴馬予測で検出された馬（7-12番人気）

購入例:
- 1着候補 - 穴馬A（馬連）
- 1着候補 - 穴馬B（馬連）
- 2着候補 - 穴馬A（馬連）
- 2着候補 - 穴馬B（馬連）

【ワイド戦略】回収率安定化（サブ・保険）
軸: ランキング学習による上位2頭
相手: 穴馬予測で検出された馬（7-12番人気）

※穴馬予測は「3着以内」をターゲットにしているため、ワイドとの相性が非常に良い
※馬連が外れても穴馬が3着ならワイドで回収可能

購入例:
- 1着候補 - 穴馬A（ワイド）
- 1着候補 - 穴馬B（ワイド）
- 2着候補 - 穴馬A（ワイド）
- 2着候補 - 穴馬B（ワイド）

【三連複戦略】大穴狙い（スパイス）
軸: ランキング学習による上位2頭
相手: 穴馬予測で検出された馬

購入例:
- 1着候補 - 2着候補 - 穴馬A（三連複）
- 1着候補 - 2着候補 - 穴馬B（三連複）
```

#### 4.1.3 馬券種別の役割と資金配分
| 馬券種 | 役割 | 資金配分 | 理由 |
|--------|------|----------|------|
| 馬連 | メイン・高配当狙い | 40% | 的中時のリターンが大きい |
| ワイド | サブ・保険 | 35% | 穴馬が3着でも回収可能、安定性向上 |
| 三連複 | スパイス・大穴狙い | 25% | 高配当だが的中率低め |

#### 4.1.4 期待配当
| 馬券種 | 期待オッズ | 的中率目安 | 期待ROI | 備考 |
|--------|-----------|-----------|---------|------|
| 馬連（本命-穴馬） | 30-100倍 | 3-5% | 150-300% | 1-2着限定 |
| ワイド（本命-穴馬） | 10-30倍 | 8-12% | 120-200% | 3着でもOK、安定性高 |
| 三連複（本命2頭-穴馬） | 50-200倍 | 2-4% | 150-400% | 高配当狙い |

#### 4.1.5 ワイド戦略の詳細

**なぜワイドが有効か:**
1. **モデルとの完全一致**: 穴馬予測は「3着以内」を予測 → ワイドの的中条件と同じ
2. **保険効果**: 馬連（1-2着限定）が外れても、穴馬が3着ならワイドで回収
3. **複数的中の可能性**: ワイドは3組まで的中するため、本命2頭+穴馬で最大2点的中
4. **連敗リスク軽減**: 的中率が高いため、資金の安定性が向上

**ワイド活用の具体例:**
```
レース結果: 1着=本命A、2着=人気馬、3着=穴馬X

【馬連】本命A - 穴馬X → ハズレ（穴馬が3着のため）
【ワイド】本命A - 穴馬X → 的中！（3着以内同士）

→ 馬連は外れたが、ワイドで回収できた
```

### 4.2 サブ戦略: 高ROI条件特化

#### 4.2.1 条件別ROI（2024年実績）
| 条件 | ROI | 優先度 |
|------|-----|--------|
| 函館芝中長距離 | 492% | ★★★★★ |
| 東京芝中長距離 | 378% | ★★★★☆ |
| 阪神芝中長距離 | 267% | ★★★☆☆ |
| 阪神芝短距離 | 205% | ★★★☆☆ |

#### 4.2.2 資金配分比率
高ROI条件に資金を傾斜配分する。

| 条件カテゴリ | ROI | 資金配分比率 |
|--------------|-----|-------------|
| Tier1（ROI 400%+） | 400%+ | 40% |
| Tier2（ROI 250-400%） | 250-400% | 35% |
| Tier3（ROI 150-250%） | 150-250% | 20% |
| Tier4（ROI 150%未満） | <150% | 5%（様子見） |

### 4.3 レース選択基準

#### 4.3.1 参加条件
| 条件 | 基準 | 理由 |
|------|------|------|
| 出走頭数 | 12頭以上 | 穴馬の出現確率確保 |
| レース信頼度 | 0.6以上 | race_confidence_scorer.pyの出力 |
| 穴馬検出 | 1頭以上 | 戦略の前提条件 |
| モデル対応 | 対応モデルあり | 未対応条件は除外 |

#### 4.3.2 見送り条件
- 新馬戦・未勝利戦（データ不足）
- 荒天時（予測精度低下）
- 穴馬検出なし（戦略適用不可）

---

## 5. システム実装要件

### 5.1 新規実装が必要な機能

#### 5.1.1 資金シミュレーター（最優先）
**ファイル名**: `fund_simulator.py`

**機能要件**:
- 初期資金・賭け金・回収の時系列シミュレーション
- モンテカルロ法による複数シナリオ生成
- 破産確率・最大ドローダウン・目標達成確率の算出
- 条件別（競馬場・馬券種）のシミュレーション対応

**入力**:
- 過去の予測結果（的中/不的中、オッズ、賭け金）
- 初期資金、賭け金ルール
- シミュレーション設定（試行回数、期間）

**出力**:
- 資金推移グラフ
- 統計サマリー（破産確率、期待値、分位点）
- シナリオ別詳細データ

#### 5.1.2 複合馬券バックテスト（高優先）
**ファイル名**: `compound_bet_backtester.py`

**機能要件**:
- 馬連・三連複・ワイドのバックテスト
- 穴馬予測結果との組み合わせ評価
- Walk-Forward形式での検証
- 条件別ROI算出

#### 5.1.3 戦略オプティマイザー（中優先）
**ファイル名**: `strategy_optimizer.py`

**機能要件**:
- 馬券種・賭け金比率の最適化
- 条件別資金配分の最適化
- ケリー基準との統合

### 5.2 既存機能の拡張

#### 5.2.1 bet_evaluator.py の拡張
- 穴馬予測結果を「相手」として使う馬連・三連複の評価機能追加
- 資金シミュレーターとの連携インターフェース

#### 5.2.2 kelly_criterion.py の拡張
- 条件別ケリー係数の算出
- 複合馬券向けケリー基準の実装

#### 5.2.3 universal_test.py の拡張
- 複合馬券戦略のテスト機能追加
- 資金シミュレーション結果の出力

### 5.3 検証パイプライン
**ファイル名**: `validation_pipeline.py`

**機能要件**:
```
[学習] → [予測] → [バックテスト] → [シミュレーション] → [評価レポート]
```
- 一気通貫の自動実行
- 再現性のある結果生成
- Go/No-Go判定の自動出力

---

## 6. 実運用判定基準

### 6.1 Go条件（全て満たす必要あり）
| 条件 | 基準値 | 検証方法 |
|------|--------|----------|
| 破産確率 | 5%以下 | モンテカルロシミュレーション |
| 期待ROI | 150%以上 | 3年Walk-Forward平均 |
| 最大ドローダウン | 50%以下（95%tile） | シミュレーション |
| 年間安定性 | 3年中2年以上でROI>100% | Walk-Forward結果 |

### 6.2 No-Go条件（1つでも該当したら見直し）
| 条件 | 基準値 | 対応 |
|------|--------|------|
| 破産確率 | 10%以上 | 賭け金比率を下げる |
| 期待ROI | 120%未満 | モデル改善 or 戦略変更 |
| 連敗耐性 | 15連敗で破産 | ケリー係数を下げる |

### 6.3 実運用開始チェックリスト
- [ ] 3年分のWalk-Forward検証完了
- [ ] モンテカルロシミュレーションで破産確率5%以下を確認
- [ ] 複合馬券バックテストでROI 150%以上を確認
- [ ] 最大ドローダウン50%以下を確認
- [ ] 賭け金上限ルールを設定済み
- [ ] 撤退条件を明確化済み

---

## 7. 開発ロードマップ

### Phase 1: 検証基盤構築（2週間）
| タスク | 優先度 | 工数 |
|--------|--------|------|
| fund_simulator.py 実装 | ★★★★★ | 3日 |
| モンテカルロシミュレーション実装 | ★★★★★ | 2日 |
| compound_bet_backtester.py 実装 | ★★★★☆ | 3日 |
| validation_pipeline.py 実装 | ★★★★☆ | 2日 |

### Phase 2: 検証実施（2週間）
| タスク | 優先度 | 工数 |
|--------|--------|------|
| 2023-2025年 Walk-Forward検証 | ★★★★★ | 3日 |
| 複合馬券バックテスト | ★★★★★ | 3日 |
| モンテカルロシミュレーション実行 | ★★★★★ | 2日 |
| 結果分析・レポート作成 | ★★★★☆ | 2日 |

### Phase 3: 戦略最適化（1週間）
| タスク | 優先度 | 工数 |
|--------|--------|------|
| 条件別資金配分最適化 | ★★★★☆ | 2日 |
| ケリー係数調整 | ★★★☆☆ | 1日 |
| 賭け金ルール最終決定 | ★★★★★ | 1日 |
| Go/No-Go判定 | ★★★★★ | 1日 |

### Phase 4: 実運用準備（1週間）
| タスク | 優先度 | 工数 |
|--------|--------|------|
| 実運用スクリプト整備 | ★★★★☆ | 2日 |
| モニタリング機能実装 | ★★★☆☆ | 2日 |
| ドキュメント整備 | ★★★☆☆ | 1日 |

**合計: 約6週間**

---

## 8. リスク管理

### 8.1 想定リスクと対策
| リスク | 影響度 | 対策 |
|--------|--------|------|
| モデル精度の低下 | 高 | 定期的な再学習、Walk-Forward継続 |
| オッズ変動 | 中 | 賭け金上限の厳守、馬連メイン |
| 連敗による資金減少 | 高 | ケリー基準、最大ドローダウン監視 |
| データ品質の劣化 | 中 | データパイプラインの監視 |

### 8.2 撤退ルール
| 条件 | アクション |
|------|-----------|
| 資金が初期の50%（12.5万円）以下 | 一時停止、戦略見直し |
| 3ヶ月連続でROI 100%未満 | モデル再検証 |
| 破産ライン（2.5万円）到達 | 完全撤退、ゼロベースで再構築 |

---

## 9. 成功の定義

### 9.1 マイルストーン
| マイルストーン | 資金目標 | 期間目安 |
|----------------|----------|----------|
| MS1: 検証完了 | - | 4週間後 |
| MS2: 実運用開始 | 25万円 | 6週間後 |
| MS3: 初期目標達成 | 50万円（+100%） | 6ヶ月後 |
| MS4: 中間目標達成 | 100万円（+300%） | 12ヶ月後 |
| MS5: 最終目標達成 | 500万円（+1900%） | 24ヶ月後 |

### 9.2 KPI
| KPI | 目標値 | 測定頻度 |
|-----|--------|----------|
| 月間ROI | 120%以上 | 月次 |
| 月間的中率（穴馬） | 5%以上 | 月次 |
| 最大ドローダウン | 50%以下 | 常時 |
| 破産確率（更新） | 5%以下 | 月次 |

---

## 付録A: 用語定義

| 用語 | 定義 |
|------|------|
| ROI | Return on Investment。回収額 ÷ 投資額 × 100% |
| ドローダウン | ピーク資金からの下落率 |
| ケリー基準 | 最適な賭け金比率を算出する数学的手法 |
| Walk-Forward | 時系列データで学習期間と検証期間をスライドさせる検証手法 |
| モンテカルロシミュレーション | 乱数を用いて多数のシナリオを生成する手法 |

## 付録B: 関連ファイル

| ファイル | 役割 |
|----------|------|
| bet_evaluator.py | 賭け評価 |
| expected_value_calculator.py | 期待値計算 |
| kelly_criterion.py | ケリー基準 |
| upset_classifier_creator.py | 穴馬分類モデル |
| universal_test.py | 汎用テスト |

---

**文書管理**
- 作成日: 2026年1月21日
- バージョン: 1.0
- 作成者: GitHub Copilot
- 最終更新: 2026年1月21日
